

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mrs.fit &mdash; PASTIS  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> PASTIS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mrs.html">mrs package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PASTIS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>mrs.fit</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mrs.fit</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A fit_tool class that deals with the quantification of MRS data based on the scipy&#39;s least_squares optimisation function.</span>

<span class="sd">@author: Tangi Roussel</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">suspect</span>
<span class="kn">from</span> <span class="nn">mrs</span> <span class="kn">import</span> <span class="n">sim</span>
<span class="kn">from</span> <span class="nn">mrs</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">mrs</span> <span class="kn">import</span> <span class="n">aliases</span> <span class="k">as</span> <span class="n">xxx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">optimize</span>
<span class="kn">import</span> <span class="nn">matplotlib._color_data</span> <span class="k">as</span> <span class="nn">mcd</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="n">parse</span>

<span class="kn">import</span> <span class="nn">pdb</span>

<span class="n">PARS_LONG_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Concentration [mmol/kg]&quot;</span><span class="p">,</span> <span class="s2">&quot;Linewidth factor [Hz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Frequency shift [Hz]&quot;</span><span class="p">,</span> <span class="s2">&quot;Phase [rd]&quot;</span><span class="p">]</span>
<span class="n">PARS_SHORT_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cm&quot;</span><span class="p">,</span> <span class="s2">&quot;dd&quot;</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="s2">&quot;dp&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="fit_plot_type"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_plot_type">[docs]</a><span class="k">class</span> <span class="nc">fit_plot_type</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The enum fit_plot_type describes the type of plots that can be displayed real-time during the fit.&quot;&quot;&quot;</span>

    <span class="n">BARGRAPH_CM</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">BARGRAPH_DD</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">BARGRAPH_DF</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">BARGRAPH_DP</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">COST_FUNCTION</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">CORR_MATRIX</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">TIME_DOMAIN</span> <span class="o">=</span> <span class="mi">7</span></div>


<div class="viewcode-block" id="fit_adjust_metabolites_mode"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_adjust_metabolites_mode">[docs]</a><span class="k">class</span> <span class="nc">fit_adjust_metabolites_mode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The enum fit_adjust_metabolite_mode describes how the algorithm should look for fittable metabolites. See the method fit_pastis.adjust_metabolites() for more info.&quot;&quot;&quot;</span>

    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">OPTIMISTIC</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">AVERAGE</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">PESSIMISTIC</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="fit_adjust_metabolites_when"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_adjust_metabolites_when">[docs]</a><span class="k">class</span> <span class="nc">fit_adjust_metabolites_when</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The enum fit_adjust_metabolite_when describes when the algorithm should look for fittable metabolites.&quot;&quot;&quot;</span>

    <span class="n">NEVER</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">BEFORE_SECOND_FIT_ONLY</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">BEFORE_EACH_FIT</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="fit_tool"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_tool">[docs]</a><span class="k">class</span> <span class="nc">fit_tool</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The fit_tool class is a virtual class, mother of other classes used for fitting.&quot;&quot;&quot;</span>

    <span class="c1"># frozen stuff: a technique to prevent creating new attributes</span>
    <span class="c1"># (https://stackoverflow.com/questions/3603502/prevent-creating-new-attributes-outside-init)</span>
    <span class="n">__isfrozen</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overload of __setattr__ method to check that we are not creating a new attribute.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isfrozen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error_new_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a fit_tool object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : MRSData2 objet</span>
<span class="sd">            Data to fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># name of the fit (fit approach for example)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fit&quot;</span>
        <span class="c1"># data signal to process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

<div class="viewcode-block" id="fit_tool.copy"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_tool.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy method.&quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="fit_lcmodel"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_lcmodel">[docs]</a><span class="k">class</span> <span class="nc">fit_lcmodel</span><span class="p">(</span><span class="n">fit_tool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The fit_lcmodel class is used to fit acquired MRS data using the blackbox now opensource old FORTRAN LCModel reference algorithm which has been used for the past 30 years.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meta_bs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a fit_lcmodel object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : MRSData2 objet</span>
<span class="sd">            Data to fit</span>
<span class="sd">        meta_bs : sim.metabolite_basis_set object</span>
<span class="sd">            Metabolite db to use to fit. If None, use meta_bs from sequence. If sequence is None, use default meta_bs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># some LCModel parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_executable_fullpath</span> <span class="o">=</span> <span class="s2">&quot;/home/tangir/crmbm/soft/lcmodel/lcm-64/bin/lcmodel&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_rawfile_fullpath</span> <span class="o">=</span> <span class="s2">&quot;/home/tangir/crmbm/soft/lcmodel/data/data.raw&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_filbas</span> <span class="o">=</span> <span class="s2">&quot;/home/tangir/crmbm/soft/lcmodel/metabolite_basis_sets/7t/gamma_press_te</span><span class="si">{}</span><span class="s2">_7t_v1.basis&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_lcsv</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># default metabolite basis set used for simulation</span>
        <span class="k">if</span><span class="p">(</span><span class="n">meta_bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span> <span class="o">=</span> <span class="n">meta_bs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">metabolite_basis_set</span><span class="p">()</span>

        <span class="c1"># display stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_pdf_software</span> <span class="o">=</span> <span class="s2">&quot;evince&quot;</span>

        <span class="c1"># final results parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># freeze</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__isfrozen</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="fit_lcmodel.copy"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_lcmodel.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy method.&quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_adjust_filbas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adjust the metabolite basis set according to te.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adjusting metabolite basis set TE...&quot;</span><span class="p">)</span>

        <span class="c1"># hold debugs logs during parse</span>
        <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>

        <span class="c1"># scan basis set files</span>
        <span class="n">metabs_folder</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_filbas</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">metabs_filename_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_filbas</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">metabs_files_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">metabs_files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">metabs_folder</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">this_metabs_filename</span> <span class="ow">in</span> <span class="n">metabs_files</span><span class="p">:</span>
                <span class="n">parse_res</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">metabs_filename_mask</span><span class="p">,</span> <span class="n">this_metabs_filename</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">parse_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">this_metabs_te</span> <span class="o">=</span> <span class="n">parse_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">metabs_files_dict</span><span class="p">[</span><span class="n">this_metabs_te</span><span class="p">]</span> <span class="o">=</span> <span class="n">metabs_folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">this_metabs_filename</span>

        <span class="c1"># put back log</span>
        <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

        <span class="c1"># find metabs with a TE close to the data&#39;s TE</span>
        <span class="n">metabs_te_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metabs_files_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">te_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">metabs_te_arr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">te</span><span class="p">)</span>
        <span class="n">ite_mindiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">te_diff</span><span class="p">)</span>
        <span class="n">optim_te</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metabs_files_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">ite_mindiff</span><span class="p">]</span>

        <span class="c1"># change metabolite basis set file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_filbas</span> <span class="o">=</span> <span class="n">metabs_files_dict</span><span class="p">[</span><span class="n">optim_te</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found that it is better to use the TE=</span><span class="si">%s</span><span class="s2">ms metabolite basis set file!&quot;</span> <span class="o">%</span> <span class="n">optim_te</span><span class="p">)</span>

<div class="viewcode-block" id="fit_lcmodel.run"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_lcmodel.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call LCModel using suspect (https://suspect.readthedocs.io/en/latest/notebooks/tut04_quant.html).&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;running LCModel fit...&quot;</span><span class="p">)</span>

        <span class="c1"># check that we have everything we need</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;canceling fit, no data was given to this fit object!&quot;</span><span class="p">)</span>

        <span class="c1"># adjust metabolite basis set file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_filbas</span><span class="p">()</span>

        <span class="c1"># create a parameters dictionary to set the basis set to use</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;FILBAS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_filbas</span><span class="p">,</span>
            <span class="s2">&quot;LCSV&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_lcsv</span><span class="p">,</span>
            <span class="s2">&quot;DGPPMN&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> 
            <span class="s2">&quot;DGPPMX&quot;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
        <span class="c1"># call suspect to prepare LCModel files</span>
        <span class="n">suspect</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">lcmodel</span><span class="o">.</span><span class="n">write_all_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_rawfile_fullpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_ref</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># guess CONTROL file name</span>
        <span class="n">fullpath_noext</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_rawfile_fullpath</span><span class="p">)</span>
        <span class="n">controlfile_fullpath</span> <span class="o">=</span> <span class="n">fullpath_noext</span> <span class="o">+</span> <span class="s2">&quot;_sl0.CONTROL&quot;</span>

        <span class="c1"># LCModel is now free, replace KEY by 210387309</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">controlfile_fullpath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">controlfile_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;KEY = 123456789&#39;</span><span class="p">,</span> <span class="s1">&#39;KEY = 210387309&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">controlfile_fullpath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">controlfile_data</span><span class="p">)</span>

        <span class="c1"># make system call to LCModel</span>
        <span class="n">system_res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lcmodel_executable_fullpath</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">controlfile_fullpath</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LCmodel binary system call returned &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">system_res</span><span class="p">))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extracting LCmodel results from CSV...&quot;</span><span class="p">)</span>
        <span class="n">csvfile_fullpath</span> <span class="o">=</span> <span class="n">fullpath_noext</span> <span class="o">+</span> <span class="s2">&quot;.CSV&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvfile_fullpath</span><span class="p">)</span>

        <span class="c1"># build params vector from this dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">)</span>
        <span class="n">meta_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()</span>
        <span class="n">meta_names_lcmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># make everything lowercase</span>
        <span class="n">meta_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">meta_names</span><span class="p">]</span>
        <span class="n">meta_names_lcmodel</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">meta_names_lcmodel</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mlc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">meta_names</span><span class="p">,</span> <span class="n">meta_names_lcmodel</span><span class="p">)):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">mlc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mlc</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># abs CRB error</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="o">.</span><span class="n">_errors</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mlc</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">mlc</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

        <span class="c1"># display if needed</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;displaying LCModel results...&quot;</span><span class="p">)</span>
            <span class="n">psfile_fullpath</span> <span class="o">=</span> <span class="n">fullpath_noext</span> <span class="o">+</span> <span class="s2">&quot;.PS&quot;</span>
            <span class="n">pdffile_fullpath</span> <span class="o">=</span> <span class="n">fullpath_noext</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ps2pdf &quot;</span> <span class="o">+</span> <span class="n">psfile_fullpath</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">pdffile_fullpath</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_pdf_software</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">pdffile_fullpath</span> <span class="o">+</span> <span class="s2">&quot; &amp;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_lcmodel.get_hash"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_lcmodel.get_hash">[docs]</a>    <span class="k">def</span> <span class="nf">get_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a hash of this fit object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        h : string</span>
<span class="sd">            Hash code of this strategy. Usefull later when dealing with databases...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bytes_to_hash</span> <span class="o">=</span> <span class="s2">&quot;lcmodel&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">bytes_to_hash</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>

<div class="viewcode-block" id="fit_lcmodel.to_dataframe"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_lcmodel.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix_str</span><span class="o">=</span><span class="s2">&quot;fit_&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the object&#39;s attributes to dataframe. Can include the object itself.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefix_str : string</span>
<span class="sd">            Prefix string to add to column names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : Dataframe</span>
<span class="sd">            With all the datasets and parameters from this fit object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;converting to dataframe...&quot;</span><span class="p">)</span>

        <span class="c1"># use pandas json_normalize function to flatten all nested stuff (magic!)</span>
        <span class="c1"># this takes care of the job attribute too</span>
        <span class="n">df_attr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># and need a specific call for the MRSData2 data</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;data_&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">df_attr</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>

        <span class="n">df_params_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="s2">&quot;params_fit_&quot;</span><span class="p">)</span>
        <span class="n">df_attr</span> <span class="o">=</span> <span class="n">df_attr</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;params_fit&#39;</span><span class="p">:</span> <span class="s1">&#39;params_fit_obj&#39;</span><span class="p">})</span>

        <span class="c1"># append columns</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_attr</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                        <span class="n">df_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                        <span class="n">df_params_fit</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># add fit hash</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fit_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span>

        <span class="c1"># remove index column</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="c1"># add prefix</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="n">prefix_str</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="fit_pastis"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis">[docs]</a><span class="k">class</span> <span class="nc">fit_pastis</span><span class="p">(</span><span class="n">fit_tool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The fit_pastis class is used to fit acquired MRS data using a linear combination algorithm based on QUEST, see Ratiney et al. NMR Biomed, 2005.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meta_bs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a fit_pastis object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : MRSData2 objet</span>
<span class="sd">            Data to fit</span>
<span class="sd">        sequence : sim.mrs_sequence object</span>
<span class="sd">            Sequence to use to fit. If None, use sequence from data</span>
<span class="sd">        meta_bs : sim.metabolite_basis_set object</span>
<span class="sd">            Metabolite db to use to fit. If None, use meta_bs from sequence. If sequence is None, use default meta_bs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># default sequence used for simulation (if none, will take sequence from data)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span>

        <span class="c1"># default metabolite basis set used for simulation (if none, will take sequence from data)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">meta_bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span> <span class="o">=</span> <span class="n">meta_bs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">meta_bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">meta_bs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># default meta_bs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">metabolite_basis_set</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># default meta_bs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">metabolite_basis_set</span><span class="p">()</span>

        <span class="c1"># list of metabolites to fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># list of metabolites to integrate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metabolites_area_integration</span> <span class="o">=</span> <span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_Water</span><span class="p">]</span>

        <span class="c1"># --- defaut lower bound parameters ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="o">.</span><span class="n">set_default_min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_df</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dp</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.0</span>

        <span class="c1"># --- default upper boud parameters ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="o">.</span><span class="n">set_default_max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">]</span> <span class="o">=</span> <span class="mf">50.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_df</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mf">10.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dp</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.0</span>

        <span class="c1"># --- default initial parameters ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="c1"># with early minimal concentrations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span>
        <span class="c1"># with early minimal damping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span>

        <span class="c1"># linklock array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_linklock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">_linklock</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_unique_linklock</span><span class="p">()</span>

        <span class="c1"># --- final results parameters ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_area</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_area_pnorm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># private option to know if we are dealing with a water fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_water_only</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># --- optimization options ---</span>
        <span class="c1"># should we use jacobin information during the fit or not?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_jacobian</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># ppm range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># stop fit if parameter changes go below this tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_xtol</span> <span class="o">=</span> <span class="mf">1e-9</span>
        <span class="c1"># stop fit if (error?) function changes go below this tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_ftol</span> <span class="o">=</span> <span class="mf">1e-9</span>
        <span class="c1"># stop fit if gradient (?) changes go below this tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_gtol</span> <span class="o">=</span> <span class="mf">1e-9</span>
        <span class="c1"># least squares optimization method (check spicy.optimize.least_squares doc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_method</span> <span class="o">=</span> <span class="s1">&#39;trf&#39;</span>
        <span class="c1"># count number of calls to error function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># record cost function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_function</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># number of successive fits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># total time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_total_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># FQN noise region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fqn_noise_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># --- display options ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># figure index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_fig_index</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="c1"># ppm range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_range_ppm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># ppm</span>
        <span class="c1"># display every n calls to error function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_frequency</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="c1"># describes the type of plots showed in the 4 subplots during the fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_subplots_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit_plot_type</span><span class="o">.</span><span class="n">BARGRAPH_CM</span><span class="p">,</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">BARGRAPH_DD</span><span class="p">,</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">BARGRAPH_DF</span><span class="p">,</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">CORR_MATRIX</span><span class="p">]</span>

        <span class="c1"># --- display options ---</span>
        <span class="c1"># should we show the CRBs error bars during the fit?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_CRBs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># --- peak area integration options ---</span>
        <span class="c1"># ppm range to look for peak maximum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">]</span>  <span class="c1"># ppm</span>

        <span class="c1"># freeze</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__isfrozen</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="fit_pastis.copy"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy method.&quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">mrs_sequence</span><span class="p">)):</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">metabolites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_linklock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">linklock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_linklock</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># --- fit init/min/max vectors ---</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">params_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">params_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># --- fit results vectors ---</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">params_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">params_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_area</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_area_pnorm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">params_area_pnorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_area_pnorm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># --- optimization options vectors ---</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">optim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">optim_ppm_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># --- reinit internal paramters for fit ---</span>
        <span class="c1"># count number of calls to error function</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_model_call_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># record cost function</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_cost_function</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># time</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_fit_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># --- fqn and display options ---</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn_noise_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">fqn_noise_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fqn_noise_range</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_range_ppm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">display_range_ppm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_range_ppm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_subplots_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">display_subplots_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_subplots_types</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># --- peak area integration stuff ---</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites_area_integration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">metabolites_area_integration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metabolites_area_integration</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># reinit internal parameters for peak area integration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_ppms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_nprots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas_norm</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_unique_linklock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Link the params_min, _max and _init linlock vectors using a reference/pointer.&quot;&quot;&quot;</span>
        <span class="c1"># link-lock vectors should be the same for initial, minimum and maximum parameter sets: link them here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">_linklock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_linklock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="o">.</span><span class="n">_linklock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_linklock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="o">.</span><span class="n">_linklock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_linklock</span>

    <span class="k">def</span> <span class="nf">_run_area_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the area integration pipeline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pars : params object</span>
<span class="sd">            Estimated relative metabolic concentration using area integration</span>
<span class="sd">        pars_norm : params object</span>
<span class="sd">            Estimated relative metabolic concentration using area integration, normalized by proton number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;initializing peak area integration...&quot;</span><span class="p">)</span>

        <span class="c1"># clear internal parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_ppms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_nprots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas_norm</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check and fix area_integration_peak_ranges</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites_area_integration</span><span class="p">)</span>

        <span class="c1"># first find chemical shifts for those peaks</span>
        <span class="n">meta_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">integration_metagroup_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_keys</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metabolites_area_integration</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">this_metagroup_key</span> <span class="ow">in</span> <span class="n">integration_metagroup_keys</span><span class="p">:</span>
            <span class="n">meta_found_singulet</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">this_meta</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">[</span><span class="n">this_metagroup_key</span><span class="p">][</span><span class="s2">&quot;metabolites&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># find first meta in this metagroup</span>
                <span class="n">this_meta_name</span> <span class="o">=</span> <span class="n">this_meta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">this_meta_ppm</span> <span class="o">=</span> <span class="n">this_meta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;ppm&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">this_meta_nprots</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">this_meta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;ppm&quot;</span><span class="p">]))</span>
                <span class="n">this_meta_j</span> <span class="o">=</span> <span class="n">this_meta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;J&quot;</span><span class="p">]</span>

                <span class="c1"># check that it is a singlet: only one meta, all Js are zeroes and only one unique ppm</span>
                <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">this_meta_j</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">this_meta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;ppm&quot;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">meta_found_singulet</span> <span class="o">=</span> <span class="n">this_meta</span>

            <span class="k">if</span><span class="p">(</span><span class="n">meta_found_singulet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt; one of the metabolites you chose for peak integration does not have a singlet, aborting area integration...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># store</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_peak_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_meta_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_peak_ppms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_meta_ppm</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_peak_nprots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_meta_nprots</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;running peak area integration...&quot;</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># zero-fill for improved resolution</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">correct_zerofill_nd</span><span class="p">()</span>
        <span class="c1"># chemical shift axis</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

        <span class="c1"># find maximum peak in range and its chemical shift</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">sf_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_fig_index</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;run (mrs.fit.fit_pastis)&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="c1"># now for each peak, integrate the area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas_norm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">)</span>
        <span class="n">pars</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">_linklock</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pars_pnorm</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">)</span>
        <span class="n">pars_pnorm</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pars_pnorm</span><span class="o">.</span><span class="n">_linklock</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;integrating peak for...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">this_peak_index</span><span class="p">,</span> <span class="n">this_peak_range</span><span class="p">,</span> <span class="n">this_peak_name</span><span class="p">,</span> <span class="n">this_peak_ppm</span><span class="p">,</span> <span class="n">this_peak_np</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites_area_integration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_ppms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak_nprots</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] theoretically at </span><span class="si">%.2f</span><span class="s2">ppm in theory&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_peak_name</span><span class="p">,</span> <span class="n">this_peak_ppm</span><span class="p">))</span>

            <span class="c1"># first find closest peak in range</span>
            <span class="n">this_peak_search_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">this_peak_ppm</span> <span class="o">-</span> <span class="n">this_peak_range</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">this_peak_ppm</span> <span class="o">+</span> <span class="n">this_peak_range</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span>
            <span class="n">this_peak_ppm</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">this_peak_lw_hz</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">this_peak_search_range</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found it in the spectrum at </span><span class="si">%.2f</span><span class="s2">ppm&quot;</span> <span class="o">%</span> <span class="n">this_peak_ppm</span><span class="p">)</span>

            <span class="c1"># integrate area</span>

            <span class="c1"># according to https://doi.org/10.1002/nbm.4257</span>
            <span class="c1"># peak integration area should be 2 * peak linewidth</span>
            <span class="n">this_peak_lw_ppm</span> <span class="o">=</span> <span class="n">this_peak_lw_hz</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">f0</span>
            <span class="k">if</span><span class="p">(</span><span class="n">this_peak_lw_ppm</span> <span class="o">&gt;</span> <span class="n">this_peak_range</span><span class="p">):</span>
                <span class="n">this_peak_lw_ppm</span> <span class="o">=</span> <span class="n">this_peak_range</span>

            <span class="n">ippm_peak_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppm</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">this_peak_ppm</span> <span class="o">-</span> <span class="n">this_peak_lw_ppm</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ppm</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">this_peak_ppm</span> <span class="o">+</span> <span class="n">this_peak_lw_ppm</span><span class="p">))</span>
            <span class="n">sf_to_integrate</span> <span class="o">=</span> <span class="n">sf_real</span><span class="p">[</span><span class="n">ippm_peak_range</span><span class="p">]</span>
            <span class="n">ppm_to_integrate</span> <span class="o">=</span> <span class="n">ppm</span><span class="p">[</span><span class="n">ippm_peak_range</span><span class="p">]</span>
            <span class="n">sf_to_integrate</span> <span class="o">=</span> <span class="n">sf_to_integrate</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ppm_to_integrate</span> <span class="o">=</span> <span class="n">ppm_to_integrate</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">this_peak_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sf_to_integrate</span><span class="p">,</span> <span class="n">ppm_to_integrate</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;got a peak area of </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">this_peak_area</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;and that is </span><span class="si">%f</span><span class="s2"> when normalized to number of 1H (</span><span class="si">%.0f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_peak_area</span> <span class="o">/</span> <span class="n">this_peak_np</span><span class="p">,</span> <span class="n">this_peak_np</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

            <span class="c1"># store</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_peak_area</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_peak_areas_norm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_peak_area</span> <span class="o">/</span> <span class="n">this_peak_np</span><span class="p">)</span>
            <span class="n">pars</span><span class="p">[</span><span class="n">this_peak_index</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_peak_area</span>
            <span class="n">pars_pnorm</span><span class="p">[</span><span class="n">this_peak_index</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_peak_area</span> <span class="o">/</span> <span class="n">this_peak_np</span>
            <span class="c1"># fix linklock vectors</span>
            <span class="n">pars</span><span class="o">.</span><span class="n">_linklock</span><span class="p">[</span><span class="n">this_peak_index</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pars_pnorm</span><span class="o">.</span><span class="n">_linklock</span><span class="p">[</span><span class="n">this_peak_index</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># display the area</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span><span class="p">):</span>
                <span class="n">axs</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">ppm_to_integrate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sf_to_integrate</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">this_peak_name</span><span class="p">)</span>

        <span class="c1"># finalize figure</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span><span class="p">):</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_range_ppm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_range_ppm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># return a param vectors</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">pars_pnorm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_linear_combination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the linear combination fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params_fit : params object</span>
<span class="sd">            Estimated metabolic parameters using the fitting algorithm</span>
<span class="sd">        optim_result : &#39;OptimizeResult&#39; object returned by scipy.optimize.least_squares</span>
<span class="sd">            Numerical optimization parameters, includes the R^2 coefficients [rsq_t and rsq_f] and the FQN coefficient [fqn]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ckeck consistency lower&lt;&gt;init&lt;&gt;upper bounds</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking consistency with parameter bounds...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1"># min vs max</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">linklock</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; One lower bound (</span><span class="si">%f</span><span class="s2">) is equal/greater than a upper bound (</span><span class="si">%f</span><span class="s2">) for [</span><span class="si">%s</span><span class="s2">] at index (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()[</span><span class="n">ll</span><span class="p">],</span> <span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
                <span class="c1"># min vs init</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">linklock</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; One initial value (</span><span class="si">%f</span><span class="s2">) is equal/lower than the lower bound value (</span><span class="si">%f</span><span class="s2">) for [</span><span class="si">%s</span><span class="s2">] at index (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()[</span><span class="n">ll</span><span class="p">],</span> <span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
                <span class="c1"># max vs init</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">linklock</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; One initial value (</span><span class="si">%f</span><span class="s2">) is equal/greater than the upper bound value (</span><span class="si">%f</span><span class="s2">) for [</span><span class="si">%s</span><span class="s2">] at index (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()[</span><span class="n">ll</span><span class="p">],</span> <span class="n">ll</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>

        <span class="c1"># checking if LL is not broken</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">check</span><span class="p">()):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;the link-lock vector looks broken!&quot;</span><span class="p">)</span>

        <span class="c1"># checking if we are dealing with a reference scan fit (water only)</span>
        <span class="n">where_LL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">linklock</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_water_only</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">where_LL</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">where_LL</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xxx</span><span class="o">.</span><span class="n">m_Water</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_water_only</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;mmmh, looks like you are fitting a water reference scan!&quot;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;running fit...&quot;</span><span class="p">)</span>
        <span class="c1"># dummy full&gt;free&gt;full&gt;free conversion to apply master/slave rules</span>
        <span class="n">params_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">toFreeParams</span><span class="p">()</span>
        <span class="n">params_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">toFullParams</span><span class="p">(</span><span class="n">params_free</span><span class="p">)</span>
        <span class="n">params_free</span> <span class="o">=</span> <span class="n">params_full</span><span class="o">.</span><span class="n">toFreeParams</span><span class="p">()</span>

        <span class="n">params_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">toFreeParams</span><span class="p">()</span>
        <span class="n">params_min_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="o">.</span><span class="n">toFreeParams</span><span class="p">()</span>
        <span class="n">params_max_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="o">.</span><span class="n">toFreeParams</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 3, 2, 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_function</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># run it</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;calling least-square optimizer...&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_jacobian</span><span class="p">):</span>
            <span class="n">optim_result</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minimizeThis</span><span class="p">,</span> <span class="n">params_free</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">params_min_free</span><span class="p">,</span> <span class="n">params_max_free</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jac</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_xtol</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_gtol</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ftol</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_method</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optim_result</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minimizeThis</span><span class="p">,</span> <span class="n">params_free</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">params_min_free</span><span class="p">,</span> <span class="n">params_max_free</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_xtol</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_gtol</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ftol</span><span class="p">)</span>

        <span class="c1"># nth final display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimizeThis</span><span class="p">(</span><span class="n">optim_result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_time</span>

        <span class="c1"># results</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;optimization terminated!&quot;</span><span class="p">)</span>
        <span class="c1"># final pars</span>
        <span class="n">params_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params_fit</span> <span class="o">=</span> <span class="n">params_fit</span><span class="o">.</span><span class="n">toFullParams</span><span class="p">(</span><span class="n">optim_result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># final CRBs</span>
        <span class="n">params_CRBs_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_CRBs</span><span class="p">(</span><span class="n">params_fit</span><span class="p">)</span>
        <span class="n">params_fit</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="n">params_CRBs_abs</span>
        <span class="c1"># final corr mat</span>
        <span class="n">corr_mat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_corr_mat</span><span class="p">(</span><span class="n">params_fit</span><span class="p">)</span>
        <span class="n">params_fit</span><span class="o">.</span><span class="n">_corr_mat</span> <span class="o">=</span> <span class="n">corr_mat</span>

        <span class="c1"># add fit criteria to optim_result</span>
        <span class="n">rsq_t</span><span class="p">,</span> <span class="n">rsq_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Rsq</span><span class="p">(</span><span class="n">params_fit</span><span class="p">)</span>
        <span class="n">optim_result</span><span class="o">.</span><span class="n">rsq_t</span> <span class="o">=</span> <span class="n">rsq_t</span>
        <span class="n">optim_result</span><span class="o">.</span><span class="n">rsq_f</span> <span class="o">=</span> <span class="n">rsq_f</span>
        <span class="n">optim_result</span><span class="o">.</span><span class="n">fqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_FQN</span><span class="p">(</span><span class="n">params_fit</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">params_fit</span><span class="p">,</span> <span class="n">optim_result</span><span class="p">)</span>

<div class="viewcode-block" id="fit_pastis.run"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the peak area integration followed by the linear combination fit.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;initializing...&quot;</span><span class="p">)</span>

        <span class="c1"># check that we have everything we need</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;canceling fit, no data was given to this fit object!&quot;</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;canceling fit, the list of metabolites to fit was not specified!&quot;</span><span class="p">)</span>

        <span class="c1"># sequence</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span>
        <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">te</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">tr</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">na</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">ds</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">nuclei</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">voxel_size</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># means it is already an instance</span>
            <span class="k">pass</span>

        <span class="c1"># do we need to adapt our ppm range?</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">bandpass_filter_range_ppm</span><span class="p">):</span>
            <span class="c1"># we need to reinitialize the sequence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">bandpass_filter_range_ppm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span>
            <span class="c1"># force reinit of sequence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># initialize sequence if needed with correct ppm range</span>
        <span class="k">if</span><span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">ready</span><span class="p">)</span> <span class="ow">or</span> <span class="p">()</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">)</span>

        <span class="c1"># reset linklock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_unique_linklock</span><span class="p">()</span>

        <span class="c1"># run</span>
        <span class="n">pars_area</span><span class="p">,</span> <span class="n">pars_area_pnorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_area_integration</span><span class="p">()</span>
        <span class="n">params_fit</span><span class="p">,</span> <span class="n">optim_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_linear_combination</span><span class="p">()</span>

        <span class="c1"># number of successive fits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># total time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_total_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_time</span>

        <span class="c1"># store</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;saving fit results...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span> <span class="o">=</span> <span class="n">params_fit</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_area</span> <span class="o">=</span> <span class="n">pars_area</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_area_pnorm</span> <span class="o">=</span> <span class="n">pars_area_pnorm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span> <span class="o">=</span> <span class="n">optim_result</span></div>

    <span class="k">def</span> <span class="nf">_jac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_free</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the jacobian vector needed for optimization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params_free : 1D numpy array of free parameters</span>
<span class="sd">            An array of fit parameter values which are free according to the link-lock (LL) array.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        j_free : numpy array [number of free parameters,number of time points]</span>
<span class="sd">            Jacobian model used to numerical optimization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># link-lock stuff</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">toFullParams</span><span class="p">(</span><span class="n">params_free</span><span class="p">)</span>

        <span class="c1"># calling jacobian model</span>
        <span class="n">j_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_jac</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># linlock the jacobian vector</span>
        <span class="c1"># for each master parameter, sum the slave derivates</span>
        <span class="n">LL_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span><span class="p">)</span>
        <span class="n">LL_list</span> <span class="o">=</span> <span class="n">LL_list</span><span class="p">[</span><span class="n">LL_list</span> <span class="o">&gt;=</span> <span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">this_LL</span> <span class="ow">in</span> <span class="n">LL_list</span><span class="p">:</span>
            <span class="n">j_full</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span> <span class="o">==</span> <span class="o">-</span><span class="n">this_LL</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">j_full</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span> <span class="o">==</span> <span class="o">+</span><span class="n">this_LL</span><span class="p">,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># reducing it to free params</span>
        <span class="n">j_free</span> <span class="o">=</span> <span class="n">j_full</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">j_free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">j_free</span><span class="p">)</span>

        <span class="c1"># fix for complex numbers</span>
        <span class="n">j_free_cmplx_odd_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">j_free</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j_free</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">j_free_cmplx_odd_even</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">j_free</span><span class="o">.</span><span class="n">real</span>
        <span class="n">j_free_cmplx_odd_even</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">j_free</span><span class="o">.</span><span class="n">imag</span>

        <span class="c1"># transpose</span>
        <span class="n">j_free_cmplx_odd_even_tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">j_free_cmplx_odd_even</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">j_free_cmplx_odd_even_tp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_minimizeThis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_free</span><span class="p">,</span> <span class="n">fit_terminated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the difference between the model and the data, also called residue. The user should not call this function. it is the job of the optimization function that will try to mininize the residue using least-squares and gradient descent stuff, etc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params_free : 1D numpy array of free parameters</span>
<span class="sd">            An array of fit parameter values which are free according to the link-lock (LL) array</span>
<span class="sd">        fit_terminated : bool</span>
<span class="sd">            If fit terminated, change figure title :)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        diff_cmplx_odd_even : numpy array</span>
<span class="sd">            Residue with real and imaginary values interleaved (only way here to deal with numerical optimization with complex numbers!)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># link-lock stuff</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">toFullParams</span><span class="p">(</span><span class="n">params_free</span><span class="p">)</span>

        <span class="c1"># and boum the model</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># and the difference with the data</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># fit criteria</span>
        <span class="n">rsq_t</span><span class="p">,</span> <span class="n">rsq_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Rsq</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">fqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_FQN</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># cost</span>
        <span class="n">current_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_function</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_err</span><span class="p">)</span>

        <span class="c1"># iterate counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># display</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fit_terminated</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_frequency</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_fig_index</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;_minimizeThis (mrs.fit.fit_pastis)&quot;</span><span class="p">)</span>

            <span class="c1"># display real-time bargraphs</span>
            <span class="c1"># real-time CRBs</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_CRBs</span><span class="p">):</span>
                <span class="n">params</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_CRBs</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

            <span class="c1"># let&#39;s display the subplots as required by self.display_subplots_types</span>
            <span class="n">axs_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">plt_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_subplots_types</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">plt_type</span> <span class="o">==</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">BARGRAPH_CM</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disp_bargraph</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">plt_type</span> <span class="o">==</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">BARGRAPH_DD</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disp_bargraph</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">plt_type</span> <span class="o">==</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">BARGRAPH_DF</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disp_bargraph</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_df</span><span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">plt_type</span> <span class="o">==</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">BARGRAPH_DP</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disp_bargraph</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dp</span><span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">plt_type</span> <span class="o">==</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">COST_FUNCTION</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cost_function</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;iterations&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;LSQ fit residue&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">plt_type</span> <span class="o">==</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">CORR_MATRIX</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disp_corr_mat</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">plt_type</span> <span class="o">==</span> <span class="n">fit_plot_type</span><span class="o">.</span><span class="n">TIME_DOMAIN</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time_axis</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">time_axis</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">mod</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">time_axis</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FID (real)&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">disp_fit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_water_only</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_range_ppm</span><span class="p">)</span>
            <span class="n">current_fit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_time</span>
            <span class="k">if</span><span class="p">(</span><span class="n">fit_terminated</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fit terminated! </span><span class="si">%d</span><span class="s2">s elapsed </span><span class="se">\n</span><span class="s2"> iteration #</span><span class="si">%d</span><span class="s2"> | residue = </span><span class="si">%.2E</span><span class="s2"> | R2 = </span><span class="si">%.2f</span><span class="s2">/</span><span class="si">%.2f</span><span class="s2"> | FQN = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_fit_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span><span class="p">,</span> <span class="n">current_err</span><span class="p">,</span> <span class="n">rsq_t</span><span class="p">,</span> <span class="n">rsq_f</span><span class="p">,</span> <span class="n">fqn</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Running fit... </span><span class="si">%d</span><span class="s2">s elapsed </span><span class="se">\n</span><span class="s2"> iteration #</span><span class="si">%d</span><span class="s2"> | residue = </span><span class="si">%.2E</span><span class="s2"> | R2 = </span><span class="si">%.2f</span><span class="s2">/</span><span class="si">%.2f</span><span class="s2"> | FQN = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_fit_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span><span class="p">,</span> <span class="n">current_err</span><span class="p">,</span> <span class="n">rsq_t</span><span class="p">,</span> <span class="n">rsq_f</span><span class="p">,</span> <span class="n">fqn</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

            <span class="c1"># save PNG</span>
            <span class="c1"># plt.savefig(&quot;%0.4d.png&quot; % self._model_call_count)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_call_count</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;th model call!&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># fix for complex numbers</span>
        <span class="n">diff_cmplx_odd_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">diff_cmplx_odd_even</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">real</span>
        <span class="n">diff_cmplx_odd_even</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">imag</span>

        <span class="k">return</span><span class="p">(</span><span class="n">diff_cmplx_odd_even</span><span class="p">)</span>

<div class="viewcode-block" id="fit_pastis.get_fittable_metabolites"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.get_fittable_metabolites">[docs]</a>    <span class="k">def</span> <span class="nf">get_fittable_metabolites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snr_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">fit_adjust_metabolites_mode</span><span class="o">.</span><span class="n">AVERAGE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust the list of metabolites to fit. This method is experimental. It runs an algorithm to try and test which metabolites are actually fittable. How? Based on their common concentration and simulated time-domain SNR. If the metabolite SNR is above the threshold (1, by default, meaning above noise level in short), the metabolite is kept in the fit list. The final metabolite basis set is printed on screen. This method should be run after the run() method in order to get some first fit results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        snr_threshold : float</span>
<span class="sd">            SNR threshold in order to keep the metabolite in the fit metabolite basis set. This is a time-domain SNR calculated using the maximum point of the real part of FID divided by the STD of noise at the end of the FID.</span>
<span class="sd">        mode : fit_adjust_metabolite_mode</span>
<span class="sd">            This describes how optimistic is the algorithm. When running on the OPTIMISTIC mode, the algorithm will assume a low concentration for the reference metabolite (Cr_CH3 for example) based on the concentration ranges in the xls metabolite basis set. It will also keep in the basis set metabolites giving a SNR above the threshold even with the lowest concentration. AVERAGE mode uses average concentrations while PESSIMISTIC uses maximum concentrations available in the xls metabolite basis set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_metabolites_list : list</span>
<span class="sd">            New list of metabolite indexes to fit</span>
<span class="sd">        metabolites_excluded_list : list</span>
<span class="sd">            List of metabolite indexes to exclude from fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first get original noise level</span>
        <span class="n">noise_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">noise_level</span>

        <span class="c1"># get reference metabolite concentration</span>
        <span class="c1"># correct for T1/T2 effects</span>
        <span class="n">params_fit_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="o">.</span><span class="n">correct_T2s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">te</span><span class="p">)</span><span class="o">.</span><span class="n">correct_T1s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tr</span><span class="p">)</span>
        <span class="c1"># go and get concentration for this metabolites according to literature</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">fit_adjust_metabolites_mode</span><span class="o">.</span><span class="n">AVERAGE</span><span class="p">):</span>
            <span class="n">cm_lit_ref</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_min</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_max</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">cm_lit_test</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_min</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_max</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">fit_adjust_metabolites_mode</span><span class="o">.</span><span class="n">OPTIMISTIC</span><span class="p">):</span>
            <span class="n">cm_lit_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_min</span><span class="p">()</span>
            <span class="n">cm_lit_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_max</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">fit_adjust_metabolites_mode</span><span class="o">.</span><span class="n">PESSIMISTIC</span><span class="p">):</span>
            <span class="n">cm_lit_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_max</span><span class="p">()</span>
            <span class="n">cm_lit_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="o">.</span><span class="n">get_literature_min</span><span class="p">()</span>

        <span class="c1"># get our reference metabolite from metabolite basis set</span>
        <span class="n">m_ref</span> <span class="o">=</span> <span class="n">xxx</span><span class="o">.</span><span class="n">m_Ref_MB</span>

        <span class="c1"># for each metabolite we attempt to fit here, we test its SNR</span>
        <span class="n">snr_metabolites_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metabolites_kept_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metabolites_excluded_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># metabolites</span>
        <span class="n">meta_names</span> <span class="o">=</span> <span class="n">params_fit_ref</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()</span>
        <span class="n">metabolites_to_test_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span> <span class="k">if</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MBs</span><span class="p">)]</span>
        <span class="n">macromolecules_to_keep_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span> <span class="k">if</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MMs</span><span class="p">)]</span>

        <span class="c1"># init display</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span><span class="p">):</span>
            <span class="n">n_subplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metabolites_to_test_list</span><span class="p">)</span>
            <span class="n">n_subplots_side</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_subplots</span><span class="p">)))</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_fig_index</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_subplots_side</span><span class="p">,</span> <span class="n">n_subplots_side</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;adjust_metabolites (mrs.fit.fit_pastis)&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plot_index</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metabolites_to_test_list</span><span class="p">):</span>
            <span class="c1"># simulate its signal with the noise level estimated on the data</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_bs</span><span class="p">)</span>
            <span class="n">p</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># concentration parameter according to fit results and known concentrations</span>
            <span class="n">p</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_fit_ref</span><span class="p">[</span><span class="n">m_ref</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">*</span> <span class="n">cm_lit_test</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">cm_lit_ref</span><span class="p">[</span><span class="n">m_ref</span><span class="p">]</span>
            <span class="c1"># take damping/T2* parameter from fit results of ref metabolite</span>
            <span class="n">p</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_fit_ref</span><span class="p">[</span><span class="n">m_ref</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">]</span>
            <span class="c1"># go simulation without noise</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">simulate_signal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="c1"># noise only</span>
            <span class="n">p</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># go simulation</span>
            <span class="n">s_noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">simulate_signal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">)</span>

            <span class="c1"># estimate time SNR</span>
            <span class="n">this_snr_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">this_snr_n</span> <span class="o">=</span> <span class="n">noise_std</span>
            <span class="n">this_snr</span> <span class="o">=</span> <span class="n">this_snr_s</span> <span class="o">/</span> <span class="n">this_snr_n</span>
            <span class="n">snr_metabolites_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_snr</span><span class="p">)</span>

            <span class="c1"># check snr and store</span>
            <span class="k">if</span><span class="p">(</span><span class="n">this_snr</span> <span class="o">&gt;</span> <span class="n">snr_threshold</span><span class="p">):</span>
                <span class="n">metabolites_kept_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metabolites_excluded_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="c1"># display</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span><span class="p">):</span>
                <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">plot_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_noise</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s_noise</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">plot_index</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">this_snr_n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_snr</span> <span class="o">&gt;</span> <span class="n">snr_threshold</span><span class="p">):</span>
                    <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">plot_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">plot_index</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">plot_index</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;FID time (ms)&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">meta_names</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>

        <span class="c1"># display</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_enable</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">label_outer</span><span class="p">()</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># display results</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial basis set (n=</span><span class="si">%d</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">meta_names</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span><span class="p">])))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metabolite tested (n=</span><span class="si">%d</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metabolites_to_test_list</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">meta_names</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">metabolites_to_test_list</span><span class="p">])))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metabolite included (n=</span><span class="si">%d</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metabolites_kept_list</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">meta_names</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">metabolites_kept_list</span><span class="p">])))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metabolite excluded (n=</span><span class="si">%d</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metabolites_excluded_list</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">meta_names</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">metabolites_excluded_list</span><span class="p">])))</span>

        <span class="c1"># merge back with macromolecules</span>
        <span class="n">new_metabolites_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metabolites_kept_list</span> <span class="o">+</span> <span class="n">macromolecules_to_keep_list</span><span class="p">))))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Final basis set (n=</span><span class="si">%d</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_metabolites_list</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">meta_names</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">new_metabolites_list</span><span class="p">])))</span>

        <span class="c1"># and return</span>
        <span class="k">return</span><span class="p">(</span><span class="n">new_metabolites_list</span><span class="p">,</span> <span class="n">metabolites_excluded_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_pastis.get_hash"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.get_hash">[docs]</a>    <span class="k">def</span> <span class="nf">get_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a hash of this strategy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        h : string</span>
<span class="sd">            Hash code of this strategy. Usefull later when dealing with databases...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bytes_to_hash</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metabolites_area_integration</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_linklock</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_jacobian</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_xtol</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ftol</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_gtol</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">optim_method</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn_noise_range</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">area_integration_peak_ranges</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">bytes_to_hash</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>

<div class="viewcode-block" id="fit_pastis.get_CRBs"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.get_CRBs">[docs]</a>    <span class="k">def</span> <span class="nf">get_CRBs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Cramér-Rao Lower Bounds.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : params object</span>
<span class="sd">            Array of simulation parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params_CRBs_abs : params object</span>
<span class="sd">            Array of simulation parameters, absolute CRBs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calling jacobian model</span>
        <span class="n">j_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_jac</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># reducing it to free params</span>
        <span class="n">j_free</span> <span class="o">=</span> <span class="n">j_full</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">j_free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">j_free</span><span class="p">)</span>

        <span class="c1"># Fisher (number of free metabolites*number of params, time points)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j_free</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">j_free</span><span class="p">))</span>

        <span class="c1"># covariance</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>

        <span class="c1"># CRBs</span>
        <span class="n">CRBs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">covar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">covar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">CRBs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>

        <span class="c1"># original noise level before apodization</span>
        <span class="n">noise_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">noise_level</span>

        <span class="c1"># normalize to noise: absolute CRBs</span>
        <span class="n">CRBs_abs</span> <span class="o">=</span> <span class="n">CRBs</span> <span class="o">*</span> <span class="n">noise_std</span>

        <span class="c1"># put back to full parameter form</span>
        <span class="n">params_CRBs_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params_CRBs_abs</span> <span class="o">=</span> <span class="n">params_CRBs_abs</span><span class="o">.</span><span class="n">toFullParams</span><span class="p">(</span><span class="n">CRBs_abs</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">params_CRBs_abs</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_pastis.get_Rsq"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.get_Rsq">[docs]</a>    <span class="k">def</span> <span class="nf">get_Rsq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the R^2 coefficient in time and frequency domain.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : params object</span>
<span class="sd">            Array of simulation parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r2_t : float</span>
<span class="sd">            R^2 correlation coefficient between data and fit in TIME DOMAIN</span>
<span class="sd">        r2_f: float</span>
<span class="sd">            R^2 correlation coefficient between data and fit in FREQUENCY DOMAIN</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the model</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># and the R coeff in TIME DOMAIN</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
        <span class="n">r_t</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">r2_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># and the R coeff in FREQUENCY DOMAIN</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spectrum</span><span class="p">(),</span> <span class="n">mod</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>
        <span class="n">r_f</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">r2_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_f</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">r2_t</span><span class="p">,</span> <span class="n">r2_f</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_pastis.get_FQN"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.get_FQN">[docs]</a>    <span class="k">def</span> <span class="nf">get_FQN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the FQN coefficient. See https://doi.org/10.1002/nbm.4257 : Quantitatively, this can be expressed using the fit quality number (FQN), which is the ratio of the variance in the fit residual divided by the variance in the pure spectral noise. For an ideal fit, the FQN should be close to 1.0, and the FQN/SNR ratio should be much less than 1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : params object</span>
<span class="sd">            Array of simulation parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fqn : float</span>
<span class="sd">            FQN coefficient of the fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># residue</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># our model is in TIME DOMAIN</span>
        <span class="c1"># but FQN only makes sense in FREQUENCY DOMAIN</span>
        <span class="c1"># that&#39;s fine with me, let&#39;s do it FREQUENCY DOMAIN</span>

        <span class="c1"># estimate noise variance in user specified spectral region</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>
        <span class="n">sf_analyze</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
        <span class="n">ippm_noise_range</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fqn_noise_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ppm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ppm</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fqn_noise_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data_noise_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">sf_analyze</span><span class="p">[</span><span class="n">ippm_noise_range</span><span class="p">])</span>
        
        <span class="c1"># estimate variance of fit residual in user specified spectral region</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>
        <span class="n">sf_analyze</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
        <span class="c1"># TODO: decide if the FQN should be calculated in a spectral region or not</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">residue_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">sf_analyze</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ippm_noise_range</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ppm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ppm</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">optim_ppm_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">residue_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">sf_analyze</span><span class="p">[</span><span class="n">ippm_noise_range</span><span class="p">])</span>

        <span class="n">fqn</span> <span class="o">=</span> <span class="n">residue_var</span> <span class="o">/</span> <span class="n">data_noise_var</span>
        <span class="k">return</span><span class="p">(</span><span class="n">fqn</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_pastis.get_corr_mat"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.get_corr_mat">[docs]</a>    <span class="k">def</span> <span class="nf">get_corr_mat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">mIndex_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pIndex_list</span><span class="o">=</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return and display the parameter correlation matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : params object</span>
<span class="sd">            Array of simulation parameters</span>
<span class="sd">        mIndex_list : list of int</span>
<span class="sd">            Metabolite indexes to display in bargraph</span>
<span class="sd">        pIndex_list : list of int</span>
<span class="sd">            Parameter indexes to display in bargraph</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        corr_mat : numpy array</span>
<span class="sd">            Correlation matrix</span>
<span class="sd">        corr_mat_lbls : numpy array</span>
<span class="sd">            Correlation matrix labels for plot output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calling jacobian model</span>
        <span class="n">j_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_jac</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># probably do not want to look at the full matrix but only some metabolites/parameters</span>
        <span class="n">mat_linklock_mIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mat_linklock_mIndex</span><span class="p">[</span><span class="n">mIndex_list</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mat_linklock_pIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mat_linklock_pIndex</span><span class="p">[:,</span> <span class="n">pIndex_list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mat_linklock_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mat_linklock_mIndex</span><span class="p">,</span> <span class="n">mat_linklock_pIndex</span><span class="p">),</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># build labels vector the same way</span>
        <span class="n">corr_mat_lbls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">meta_names</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">meta_names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PARS_SHORT_NAMES</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">mat_linklock_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]):</span>
                    <span class="n">corr_mat_lbls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mat_linklock_mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;empty fit correlation matrix, please adjust the mIndex_list/pIndex_list parameters!&quot;</span><span class="p">)</span>

        <span class="c1"># reducing it to metabolites, parameters of interest + free params</span>
        <span class="n">j_reduced</span> <span class="o">=</span> <span class="n">j_full</span><span class="p">[</span><span class="n">mat_linklock_mask</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">j_reduced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">j_reduced</span><span class="p">)</span>

        <span class="c1"># Fisher (number of free metabolites*number of params, time points)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j_reduced</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">j_reduced</span><span class="p">))</span>

        <span class="c1"># covariance</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>

        <span class="c1"># parameter correlation</span>
        <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">covar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">corr_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">corr_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">corr_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">covar</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">covar</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]))</span>

        <span class="k">return</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">corr_mat_lbls</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_pastis.disp_corr_mat"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.disp_corr_mat">[docs]</a>    <span class="k">def</span> <span class="nf">disp_corr_mat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">disp_color_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return and display the parameter correlation matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : matplotlib axis</span>
<span class="sd">            Axis to use for plotting</span>
<span class="sd">        params : params object</span>
<span class="sd">            Array of simulation parameters</span>
<span class="sd">        disp_color_bar : boolean</span>
<span class="sd">            Add a color (True) or not (False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calling jacobian model</span>
        <span class="n">corr_mat</span><span class="p">,</span> <span class="n">corr_mat_lbls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_corr_mat</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_mat_lbls</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_mat_lbls</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">corr_mat_lbls</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">corr_mat_lbls</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">disp_color_bar</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_pastis.disp_bargraph"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.disp_bargraph">[docs]</a>    <span class="k">def</span> <span class="nf">disp_bargraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pIndex</span><span class="o">=</span><span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a bargraph of concentrations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : matplotlib axis</span>
<span class="sd">            Axis to use for plotting</span>
<span class="sd">        params : sim.params</span>
<span class="sd">            Parameters to barplot</span>
<span class="sd">        pIndex : int</span>
<span class="sd">            Parameter index to display in bargraph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># LLcolor_names=[name for name in mcd.XKCD_COLORS]</span>
        <span class="n">LLcolor_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xkcd:blue&#39;</span><span class="p">,</span> <span class="s1">&#39;xkcd:red&#39;</span><span class="p">,</span> <span class="s1">&#39;xkcd:violet&#39;</span><span class="p">,</span> <span class="s1">&#39;xkcd:green&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;xkcd:goldenrod&#39;</span><span class="p">,</span> <span class="s1">&#39;xkcd:crimson&#39;</span><span class="p">,</span> <span class="s1">&#39;xkcd:salmon&#39;</span><span class="p">,</span> <span class="s1">&#39;xkcd:wheat&#39;</span><span class="p">,</span> <span class="s1">&#39;xkcd:lightblue&#39;</span><span class="p">]</span>
        <span class="c1"># fixed bar width, maybe an issue one day</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="c1"># label</span>
        <span class="n">lbl</span> <span class="o">=</span> <span class="n">PARS_LONG_NAMES</span><span class="p">[</span><span class="n">pIndex</span><span class="p">]</span>

        <span class="c1"># build logical mask</span>
        <span class="n">meta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># filter out the fixed LLs</span>
        <span class="n">meta_mask</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">linklock</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># filter out water?</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_water_only</span><span class="p">):</span>
            <span class="n">meta_mask</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_Water</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># parameter filter</span>
        <span class="n">meta_mask_p</span> <span class="o">=</span> <span class="n">meta_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">meta_mask_p</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">meta_mask_p</span><span class="p">[:,</span> <span class="n">pIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">meta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">meta_mask</span><span class="p">,</span> <span class="n">meta_mask_p</span><span class="p">)</span>

        <span class="c1"># check that we still have something to display</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">meta_mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;nothing to display! :(&quot;</span><span class="p">)</span>

        <span class="c1"># prepare data</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">meta_mask</span><span class="p">]</span>
        <span class="n">params_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="p">[</span><span class="n">meta_mask</span><span class="p">]</span>
        <span class="n">params_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="p">[</span><span class="n">meta_mask</span><span class="p">]</span>
        <span class="n">params_range</span> <span class="o">=</span> <span class="n">params_max</span> <span class="o">-</span> <span class="n">params_min</span>  <span class="c1"># we want to plot the ranges</span>
        <span class="n">params_LL</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">linklock</span><span class="p">[</span><span class="n">meta_mask</span><span class="p">]</span>
        <span class="n">params_std</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="n">meta_mask</span><span class="p">]</span>
        <span class="n">meta_names</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()</span>
        <span class="n">meta_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">meta_names</span><span class="p">))</span> <span class="k">if</span> <span class="n">meta_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pIndex</span><span class="p">]]</span>

        <span class="c1"># prepare bars</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">meta_mask</span><span class="p">[:])</span>
        <span class="n">pos_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># draw bars</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos_bars</span><span class="p">,</span> <span class="n">params_range</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">params_min</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
        <span class="n">bar_params</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos_bars</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">params_std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

        <span class="c1"># set color according to linklock</span>
        <span class="k">for</span> <span class="n">this_bar</span><span class="p">,</span> <span class="n">this_LL</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bar_params</span><span class="p">,</span> <span class="n">params_LL</span><span class="p">):</span>
            <span class="n">this_LLcolor_name</span> <span class="o">=</span> <span class="n">LLcolor_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">this_LL</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">LLcolor_names</span><span class="p">))]</span>
            <span class="n">this_LLcolor</span> <span class="o">=</span> <span class="n">mcd</span><span class="o">.</span><span class="n">XKCD_COLORS</span><span class="p">[</span><span class="n">this_LLcolor_name</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">this_bar</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">this_LLcolor</span><span class="p">)</span>

        <span class="c1"># ylim</span>
        <span class="k">if</span><span class="p">(</span><span class="n">pIndex</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dd</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">params_max</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">pIndex</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">p_df</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_dp</span><span class="p">]):</span>
            <span class="n">minmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params_min</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params_max</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">minmax</span><span class="p">,</span> <span class="o">+</span><span class="n">minmax</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">pos_bars</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">meta_names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="fit_pastis.to_dataframe"><a class="viewcode-back" href="../../mrs.html#mrs.fit.fit_pastis.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix_str</span><span class="o">=</span><span class="s2">&quot;fit_&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the object&#39;s attributes to dataframe. Can include the object itself.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefix_str : string</span>
<span class="sd">            Prefix string to add to column names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : Dataframe</span>
<span class="sd">            With all the datasets and parameters from this fit object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;converting to dataframe...&quot;</span><span class="p">)</span>

        <span class="c1"># use pandas json_normalize function to flatten all nested stuff (magic!)</span>
        <span class="c1"># this takes care of the job attribute too</span>
        <span class="n">df_attr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># and need a specific call for the MRSData2 data</span>
        <span class="n">df_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;data_&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">df_attr</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>

        <span class="c1"># params objects</span>
        <span class="n">df_params_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_min</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="s2">&quot;params_min_&quot;</span><span class="p">)</span>
        <span class="n">df_params_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_max</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="s2">&quot;params_max_&quot;</span><span class="p">)</span>
        <span class="n">df_params_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_init</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="s2">&quot;params_init_&quot;</span><span class="p">)</span>

        <span class="c1"># keep objects</span>
        <span class="n">df_attr</span> <span class="o">=</span> <span class="n">df_attr</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;params_min&#39;</span><span class="p">:</span> <span class="s1">&#39;params_min_obj&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;params_max&#39;</span><span class="p">:</span> <span class="s1">&#39;params_max_obj&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;params_init&#39;</span><span class="p">:</span> <span class="s1">&#39;params_init_obj&#39;</span><span class="p">})</span>

        <span class="c1"># if any results, do them too</span>
        <span class="k">if</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_area_pnorm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="n">df_params_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_fit</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="s2">&quot;params_fit_&quot;</span><span class="p">)</span>
            <span class="n">df_params_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_area</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="s2">&quot;params_area_&quot;</span><span class="p">)</span>
            <span class="n">df_params_area_pnorm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_area_pnorm</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="s2">&quot;params_area_pnorm_&quot;</span><span class="p">)</span>

            <span class="c1"># keep objects</span>
            <span class="n">df_attr</span> <span class="o">=</span> <span class="n">df_attr</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;params_fit&#39;</span><span class="p">:</span> <span class="s1">&#39;params_fit_obj&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;params_area&#39;</span><span class="p">:</span> <span class="s1">&#39;params_area_obj&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;params_area_pnorm&#39;</span><span class="p">:</span> <span class="s1">&#39;params_area_pnorm_obj&#39;</span><span class="p">})</span>

            <span class="c1"># append columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_attr</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_min</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_init</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_fit</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_area</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_area_pnorm</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># append columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_attr</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_min</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                            <span class="n">df_params_init</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


        <span class="c1"># add fit hash</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fit_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span>

        <span class="c1"># remove index column</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="c1"># remove this weird column</span>
        <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;level_0&quot;</span><span class="p">]</span>

        <span class="c1"># add prefix</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="n">prefix_str</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="disp_fit"><a class="viewcode-back" href="../../mrs.html#mrs.fit.disp_fit">[docs]</a><span class="k">def</span> <span class="nf">disp_fit</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">LL_exluding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">LL_merging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mIndex_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">water_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">zerofilling_final_npts</span><span class="o">=</span><span class="mi">16384</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a bargraph of concentrations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : matplotlib axis</span>
<span class="sd">        Axis to use for plotting</span>
<span class="sd">    params : params object</span>
<span class="sd">        List of parameter arrays to display as bars</span>
<span class="sd">    seq : mrs_sequence</span>
<span class="sd">        Virtual MRS sequence object</span>
<span class="sd">    LL_excluding : boolean</span>
<span class="sd">        Shows only free or master spectra (True) or not (False)</span>
<span class="sd">    LL_merging : boolean</span>
<span class="sd">        Shows concentration link-lock connections by merging spectra (True) or not (False)</span>
<span class="sd">    mIndex_list : list</span>
<span class="sd">        Indexes of metabolite to display</span>
<span class="sd">    water_only : boolean</span>
<span class="sd">        If only water is displayed</span>
<span class="sd">    display_range : list [2]</span>
<span class="sd">        Range in ppm used for display</span>
<span class="sd">    zerofilling_final_npts : int</span>
<span class="sd">        Final npts of points after zero-filling data to smooth display; if (None), no zero-filling</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dummy full&gt;free&gt;full conversion to apply master/slave rules</span>
    <span class="n">params_free</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">toFreeParams</span><span class="p">()</span>
    <span class="n">params_full</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">toFullParams</span><span class="p">(</span><span class="n">params_free</span><span class="p">)</span>

    <span class="c1"># the data</span>
    <span class="k">if</span><span class="p">(</span><span class="n">zerofilling_final_npts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">correct_zerofill_nd</span><span class="p">(</span><span class="n">zerofilling_final_npts</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="c1"># the full model</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">params_full</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">zerofilling_final_npts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">correct_zerofill_nd</span><span class="p">(</span><span class="n">zerofilling_final_npts</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">mod</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="c1"># the residue</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">mod</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">diff</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;residue&#39;</span><span class="p">)</span>

    <span class="c1"># trying to set ylim smart way</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="c1"># if not only water and water exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">water_only</span><span class="p">):</span>
            <span class="c1"># generate a model signal, water set to 0 to set later ylim</span>
            <span class="n">params_full_nowater</span> <span class="o">=</span> <span class="n">params_full</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">params_full_nowater</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_Water</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">mod_nowater</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">params_full_nowater</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mod_nowater</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># metabolite list</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mIndex_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">meta_ind_list</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">xxx</span><span class="o">.</span><span class="n">n_MBs</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">meta_ind_list</span> <span class="o">=</span> <span class="n">mIndex_list</span>

    <span class="n">meta_names</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_meta_names</span><span class="p">()</span>

    <span class="c1"># filter out fixed LL?</span>
    <span class="k">if</span><span class="p">(</span><span class="n">LL_exluding</span><span class="p">):</span>
        <span class="c1"># remove fixed parameters (LL==1)</span>
        <span class="n">meta_ind_list_without_fixedLLs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">meta_ind_list</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">params_full</span><span class="o">.</span><span class="n">linklock</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">meta_ind_list_without_fixedLLs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">meta_ind_list</span> <span class="o">=</span> <span class="n">meta_ind_list_without_fixedLLs</span>

    <span class="c1"># calculate a nice gap</span>
    <span class="n">n_meta_to_display</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_ind_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># 1 line for MMs</span>
    <span class="k">if</span><span class="p">(</span><span class="n">LL_merging</span><span class="p">):</span>
        <span class="n">n_meta_to_display</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">params_full</span><span class="o">.</span><span class="n">linklock</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">])</span>
    <span class="n">ygap</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">*</span> <span class="p">(</span><span class="mi">60</span> <span class="o">-</span> <span class="n">n_meta_to_display</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.005</span>

    <span class="c1"># init metabolite-per-metabolite plot</span>
    <span class="n">ignore_those_mLLs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">p_allzeros</span> <span class="o">=</span> <span class="n">params_full</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">p_allzeros</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">koffset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">mLL</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">meta_ind_list</span><span class="p">,</span> <span class="n">params_full</span><span class="o">.</span><span class="n">linklock</span><span class="p">[</span><span class="n">meta_ind_list</span><span class="p">,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]):</span>
        <span class="c1"># check if we should plot this guy</span>
        <span class="n">mLL_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mLL</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mLL_abs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_those_mLLs</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">LL_merging</span> <span class="ow">and</span> <span class="n">mLL_abs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># find which metabolites to merge (NAA_CH3 and NAA_CH2 for example)</span>
                <span class="n">this_params_LL_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params_full</span><span class="o">.</span><span class="n">linklock</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">])</span>
                <span class="n">this_meta_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">this_params_LL_abs</span> <span class="o">==</span> <span class="n">mLL_abs</span><span class="p">)</span>
                <span class="n">this_meta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">this_meta_mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">this_meta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">this_meta_mask</span><span class="p">)</span>
                <span class="n">this_meta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">this_meta_mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="c1"># remember for next time we meet one of those metabolites</span>
                <span class="n">ignore_those_mLLs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mLL_abs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">this_meta_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">params_full</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">this_meta_mask</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># prepare metabolite name</span>
            <span class="n">this_meta_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">mName</span><span class="p">,</span> <span class="n">mLL</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">meta_names</span><span class="p">,</span> <span class="n">this_meta_mask</span><span class="p">[:,</span> <span class="n">xxx</span><span class="o">.</span><span class="n">p_cm</span><span class="p">]):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">mLL</span><span class="p">):</span>
                    <span class="n">this_meta_name</span> <span class="o">=</span> <span class="n">this_meta_name</span> <span class="o">+</span> <span class="n">mName</span> <span class="o">+</span> <span class="s2">&quot; &amp; &quot;</span>
            <span class="n">this_meta_name</span> <span class="o">=</span> <span class="n">this_meta_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># prepare parameters</span>
            <span class="n">this_params</span> <span class="o">=</span> <span class="n">p_allzeros</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">this_params</span><span class="p">[</span><span class="n">this_meta_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">params_full</span><span class="p">[</span><span class="n">this_meta_mask</span><span class="p">]</span>

            <span class="c1"># call model</span>
            <span class="n">s_single_meta</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">this_params</span><span class="p">)</span>

            <span class="c1"># display</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_single_meta</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_single_meta</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">ygap</span> <span class="o">*</span> <span class="p">(</span><span class="n">koffset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="n">ygap</span> <span class="o">*</span> <span class="p">(</span><span class="n">koffset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ygap</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">this_meta_name</span><span class="p">)</span>
            <span class="n">koffset</span> <span class="o">=</span> <span class="n">koffset</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># prepare macromolecules parameters</span>
    <span class="n">this_params</span> <span class="o">=</span> <span class="n">p_allzeros</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">this_params</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MMs</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">params_full</span><span class="p">[</span><span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MMs</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># call model</span>
    <span class="n">s_MMs</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">this_params</span><span class="p">)</span>

    <span class="c1"># plot the final MM baseline</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_MMs</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_MMs</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">ygap</span> <span class="o">*</span> <span class="p">(</span><span class="n">koffset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>

    <span class="c1"># and now break down the MM baseline into the gaussian components</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">xxx</span><span class="o">.</span><span class="n">m_All_MMs</span><span class="p">:</span>
        <span class="c1"># prepare parameters for this MM</span>
        <span class="n">this_params</span> <span class="o">=</span> <span class="n">p_allzeros</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">this_params</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">params_full</span><span class="p">[</span><span class="n">im</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># call model</span>
        <span class="n">s_single_MM</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">this_params</span><span class="p">)</span>

        <span class="c1"># plot the a single MM keeping the same offset</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_single_MM</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_single_MM</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">ygap</span> <span class="o">*</span> <span class="p">(</span><span class="n">koffset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="n">ygap</span> <span class="o">*</span> <span class="p">(</span><span class="n">koffset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">ygap</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Lip baseline&#39;</span><span class="p">)</span>

    <span class="c1"># finalize the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># ylim trick: tricky</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">ygap</span> <span class="o">*</span> <span class="p">(</span><span class="n">koffset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">ymax</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Tangi Roussel

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>