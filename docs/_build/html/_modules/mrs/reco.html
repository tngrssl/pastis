

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mrs.reco &mdash; PASTIS  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> PASTIS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mrs.html">mrs package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PASTIS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>mrs.reco</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mrs.reco</h1><div class="highlight"><pre>
<span></span><span class="ch">#! / usr / bin / env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Three classes&#39; definition in here.</span>

<span class="sd">    * a MRSData2 class with a bunch of methods based on the suspect module to deal with SIEMENS 7T MRS data</span>
<span class="sd">    * a pipeline class to run the reconstruction process on a bunch of acquired data</span>

<span class="sd">@author: Tangi Roussel</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">suspect</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib._pylab_helpers</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">mrs</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">mrs</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">mrs</span> <span class="kn">import</span> <span class="n">paths</span> <span class="k">as</span> <span class="n">default_paths</span>

<span class="kn">import</span> <span class="nn">pdb</span>

<span class="c1"># max number of datasets in a pipeline</span>
<span class="n">MAX_NUM_DATASETS</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># constants used during data rejection</span>
<span class="c1"># minimum step while setting amplitude threshold (% of signal relative change)</span>
<span class="n">DATA_REJECTION_AMPLITUDE_STEP</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="c1"># minimum step while setting linewidth threshold (Hz)</span>
<span class="n">DATA_REJECTION_LINEWIDTH_STEP</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="c1"># minimum step while setting chemical shift threshold (ppm)</span>
<span class="n">DATA_REJECTION_FREQUENCY_STEP</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="c1"># minimum step while setting phase threshold (rad)</span>
<span class="n">DATA_REJECTION_PHASE_STEP</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># spectral resolution for peak realignment using inter-correlation mode (experimental) (ppm)</span>
<span class="n">RECO_CORRECT_REALIGN_INTER_CORR_MODE_DF</span> <span class="o">=</span> <span class="mf">0.1</span>


<div class="viewcode-block" id="suspect_phasing_method"><a class="viewcode-back" href="../../mrs.html#mrs.reco.suspect_phasing_method">[docs]</a><span class="k">class</span> <span class="nc">suspect_phasing_method</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The enum suspect_phasing_method describes the type of phasing method to use (phasing method from the suspect package.&quot;&quot;&quot;</span>

    <span class="n">MATCH_MAGNITUDE_REAL</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">MIN_IMAG_INTEGRAL</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ACME</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="data_rejection_method"><a class="viewcode-back" href="../../mrs.html#mrs.reco.data_rejection_method">[docs]</a><span class="k">class</span> <span class="nc">data_rejection_method</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The enum data_rejection_method describes the type of data rejection method used.&quot;&quot;&quot;</span>

    <span class="n">AUTO_AMPLITUDE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">AUTO_LINEWIDTH</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">AUTO_FREQUENCY</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">AUTO_PHASE</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="MRSData2"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2">[docs]</a><span class="k">class</span> <span class="nc">MRSData2</span><span class="p">(</span><span class="n">suspect</span><span class="o">.</span><span class="n">mrsobjects</span><span class="o">.</span><span class="n">MRSData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class based on suspect&#39;s MRSData to store MRS data.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_filepath</span><span class="p">,</span> <span class="n">physio_log_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anatomy_folderpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">te</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ppm0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">voxel_dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">offset_display</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">patient</span><span class="o">=</span><span class="p">{},</span> <span class="n">sequence_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_rejection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_file_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_concatenated</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_rawdata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a MRSData2 object that inherits of Suspect&#39;s MRSData class. In short, the MRSData2 class is a copy of MRSData + my custom methods for post-processing. To create a MRSData2 object, you need give a path that points to a SIEMENS DICOM or a SIEMENS TWIX file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_filepath : string</span>
<span class="sd">            Full absolute file path pointing to the stored signal (DCM or TWIX file) or the folder assuming that a dcm file named &quot;original-primary_e09_0001.dcm&quot; is stored inside.</span>
<span class="sd">        physio_log_file : string</span>
<span class="sd">            Full absolute file path pointing to a IDEA VB17 respiratory log file</span>
<span class="sd">        anatomy_folderpath : string</span>
<span class="sd">            Full absolute file path pointing a folder containing dicom DCM files contaning the anatomical images on which you want to dispaly the VOI</span>
<span class="sd">        obj,dt,f0,te,tr,ppm0,voxel_dimensions,transform,metadata</span>
<span class="sd">            Please check suspect&#39;s MRSData class for those arguments</span>
<span class="sd">        data_ref : MRSData2 object</span>
<span class="sd">            Reference data acquired for this signal</span>
<span class="sd">        label : string</span>
<span class="sd">            Label for this signal</span>
<span class="sd">        offset_display : float</span>
<span class="sd">            Y-axis offset display</span>
<span class="sd">        patient : dict</span>
<span class="sd">            Patient meta data</span>
<span class="sd">        sequence_obj : sim.mrs_sequence object</span>
<span class="sd">            Sequence object</span>
<span class="sd">        noise_level : float</span>
<span class="sd">            Noise level measured on real FID</span>
<span class="sd">        data_rejection : list of dicts</span>
<span class="sd">            Data rejection results (NA, SNR, LW, etc.)</span>
<span class="sd">        data_file_hash : string</span>
<span class="sd">            MD5 hash code of data file content</span>
<span class="sd">        is_concatenated : boolean</span>
<span class="sd">            Was this signal the result of a concatenation?</span>
<span class="sd">        is_rawdata : boolean</span>
<span class="sd">            Was this signal read from a DICOM file?</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obj : MRSData2 numpy array [averages,channels,timepoints]</span>
<span class="sd">            Resulting constructed MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data_filepath</span> <span class="o">==</span> <span class="p">[]):</span>
            <span class="c1"># calling the parent class&#39; constructor</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">suspect</span><span class="o">.</span><span class="n">mrsobjects</span><span class="o">.</span><span class="n">MRSData</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">te</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">ppm0</span><span class="p">,</span> <span class="n">voxel_dimensions</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="c1"># adding attributes</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">data_ref</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_display_label</span> <span class="o">=</span> <span class="n">label</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_display_offset</span> <span class="o">=</span> <span class="n">offset_display</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_tr</span> <span class="o">=</span> <span class="n">tr</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="n">patient</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">sequence_obj</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_noise_level</span> <span class="o">=</span> <span class="n">noise_level</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_data_rejection</span> <span class="o">=</span> <span class="n">data_rejection</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">=</span> <span class="n">data_file_hash</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_is_concatenated</span> <span class="o">=</span> <span class="n">is_concatenated</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_is_rawdata</span> <span class="o">=</span> <span class="n">is_rawdata</span>
            <span class="c1"># bye</span>
            <span class="k">return</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># hello</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;creating object...&quot;</span><span class="p">)</span>

        <span class="c1"># open data file</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading data file...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">data_filepath</span><span class="p">)</span>
        <span class="c1"># read data and header</span>
        <span class="n">mfr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">get_data_file_reader</span><span class="p">(</span><span class="n">data_filepath</span><span class="p">)</span>
        <span class="c1"># read data and get a suspect MRSData object</span>
        <span class="n">MRSData_obj</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># get hash code</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_md5_hash</span><span class="p">()</span>

        <span class="c1"># --- reshape data ---</span>

        <span class="c1"># add dimensions if needed</span>
        <span class="k">if</span><span class="p">(</span><span class="n">MRSData_obj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># this could be a single-shot single-rx signal in twix</span>
            <span class="c1"># or an averaged single-rx signal in dicom...</span>

            <span class="c1"># add 2 dimensions</span>
            <span class="n">MRSData_obj</span> <span class="o">=</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">MRSData_obj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># this could be a single-shot multi-rx signal</span>
            <span class="c1"># or a averaged single-rx signal...</span>
            <span class="n">coil_nChannels</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_number_rx_channels</span><span class="p">()</span>

            <span class="k">if</span><span class="p">(</span><span class="n">coil_nChannels</span> <span class="o">==</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="c1"># beware, same number of averages / coil elements, which is which?</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ambiguous data dimensions: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&gt; Assuming (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;) to be the coil channels!&quot;</span><span class="p">)</span>
                <span class="n">MRSData_obj</span> <span class="o">=</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">coil_nChannels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># ok the user said it is a single channel coil, so the 2nd dimension here is the number of averages!</span>
                <span class="c1"># adding 1 dimension for number of channels</span>
                <span class="n">MRSData_obj</span> <span class="o">=</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">MRSData_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">MRSData_obj</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ok that is a single-shot multi-channel signal</span>
                <span class="c1"># adding 1 dimension for averages</span>
                <span class="n">MRSData_obj</span> <span class="o">=</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;read a &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">MRSData_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; vector&quot;</span><span class="p">)</span>

        <span class="c1"># --- build MRSData object ---</span>
        <span class="c1"># calling the parent class&#39; constructor</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">suspect</span><span class="o">.</span><span class="n">mrsobjects</span><span class="o">.</span><span class="n">MRSData</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">f0</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">te</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">tr</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">ppm0</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">voxel_dimensions</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">MRSData_obj</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># --- get extra parameters ---</span>

        <span class="c1"># patient birthyear</span>
        <span class="n">patient_birthday_datetime</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_patient_birthday</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extracted patient birthyear (&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">patient_birthday_datetime</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="c1"># patient sex</span>
        <span class="n">patient_sex_str</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_patient_sex</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extracted patient sex (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">patient_sex_str</span><span class="p">)</span>

        <span class="c1"># patient name</span>
        <span class="n">patient_name_str</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_patient_name</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extracted patient name (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">patient_name_str</span><span class="p">)</span>

        <span class="c1"># patient weight</span>
        <span class="n">patient_weight_kgs</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_patient_weight</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extracted patient weight (</span><span class="si">%.2f</span><span class="s2">kg)&quot;</span> <span class="o">%</span> <span class="n">patient_weight_kgs</span><span class="p">)</span>

        <span class="c1"># patient height</span>
        <span class="n">patient_height_m</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_patient_height</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;extracted patient height (</span><span class="si">%.2f</span><span class="s2">m)&quot;</span> <span class="o">%</span> <span class="n">patient_height_m</span><span class="p">)</span>

        <span class="c1"># extract all the info to build the sequence object</span>
        <span class="n">sequence_obj</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">get_sequence</span><span class="p">()</span>

        <span class="c1"># --- build MRSData2 object ---</span>
        <span class="c1"># adding MRSData2 attributes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">data_ref</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">patient_name_str</span><span class="p">,</span>
                        <span class="s2">&quot;birthday&quot;</span><span class="p">:</span> <span class="n">patient_birthday_datetime</span><span class="p">,</span>
                        <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="n">patient_sex_str</span><span class="p">,</span>
                        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">patient_weight_kgs</span><span class="p">,</span>
                        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">patient_height_m</span><span class="p">}</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">sequence_obj</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_noise_level</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_data_rejection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">=</span> <span class="n">hc</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_is_concatenated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_is_rawdata</span> <span class="o">=</span> <span class="n">mfr</span><span class="o">.</span><span class="n">is_rawdata</span><span class="p">()</span>

        <span class="c1"># those need to be called now, because they the attributes above</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">set_display_offset</span><span class="p">()</span>

        <span class="c1"># respiratory trace if any</span>
        <span class="k">if</span><span class="p">(</span><span class="n">physio_log_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_physio_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># save this</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_physio_file</span> <span class="o">=</span> <span class="n">physio_log_file</span>

        <span class="c1"># anatomical images if any</span>
        <span class="k">if</span><span class="p">(</span><span class="n">anatomy_folderpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_anatomy_folderpath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># save this</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_anatomy_folderpath</span> <span class="o">=</span> <span class="n">anatomy_folderpath</span>

        <span class="k">return</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overload of special numpy array method called when playing around with stuff relative to object copy etc...</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : MRSData2 numpy array [1,channels,timepoints]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__array_finalize__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;data_ref&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># replace by a copy</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_display_label</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;display_label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_offset</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;display_offset&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;patient&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_physio_file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;physio_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anatomy_folderpath</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;anatomy_folderpath&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># replace by a copy</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_noise_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;noise_level&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_rejection</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;data_rejection&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;data_file_hash&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_concatenated</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;is_concatenated&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_rawdata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;is_rawdata&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="MRSData2.inherit"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.inherit">[docs]</a>    <span class="k">def</span> <span class="nf">inherit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overload of special suspect&#39;s MRSData method to import a numpy array in here.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : MRSData2 numpy array [1,channels,timepoints]</span>
<span class="sd">            Multi-channel reference signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj2</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">obj2</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;data_ref&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># replace by a copy</span>
        <span class="k">if</span><span class="p">(</span><span class="n">obj2</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj2</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">obj2</span><span class="o">.</span><span class="n">_display_label</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;display_label&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_display_offset</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;display_offset&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;patient&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_physio_file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;physio_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_anatomy_folderpath</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;anatomy_folderpath&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">obj2</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># replace by a copy</span>
        <span class="k">if</span><span class="p">(</span><span class="n">obj2</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obj2</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">obj2</span><span class="o">.</span><span class="n">_noise_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;noise_level&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_data_rejection</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;data_rejection&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;data_file_hash&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_is_concatenated</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_concatenated&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">obj2</span><span class="o">.</span><span class="n">_is_rawdata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;is_rawdata&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">obj2</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for display_label.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._display_label : string</span>
<span class="sd">            Display label used in display_spectrum method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_label</span><span class="p">)</span>

<div class="viewcode-block" id="MRSData2.set_display_label"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.set_display_label">[docs]</a>    <span class="k">def</span> <span class="nf">set_display_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the display label.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lbl: string</span>
<span class="sd">            New display label for this signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">((</span><span class="n">lbl</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">lbl</span> <span class="o">==</span> <span class="p">[])</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># create a usefull label based on patient name, sequence and object id</span>
            <span class="n">new_lbl</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">new_lbl</span> <span class="o">=</span> <span class="n">new_lbl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">new_lbl</span> <span class="o">=</span> <span class="n">new_lbl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; | &quot;</span>
            <span class="n">new_lbl</span> <span class="o">=</span> <span class="n">new_lbl</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_label</span> <span class="o">=</span> <span class="n">lbl</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">display_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for display_offset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._display_offset : float</span>
<span class="sd">            Display offset used in display_spectrum method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_offset</span><span class="p">)</span>

<div class="viewcode-block" id="MRSData2.set_display_offset"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.set_display_offset">[docs]</a>    <span class="k">def</span> <span class="nf">set_display_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ofs</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the display offset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ofs: float</span>
<span class="sd">            New display offset for this signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_offset</span> <span class="o">=</span> <span class="n">ofs</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">patient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for patient.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._patient : dict</span>
<span class="sd">            Patient meta data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">physio_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for physio_file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._physio_file : string</span>
<span class="sd">            Path to physio recording file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_physio_file</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">anatomy_folderpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for anatomy_folderpath.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._anatomy_folderpath : string</span>
<span class="sd">            Full absolute file path pointing a folder containing dicom DCM files contaning the anatomical images on which you want to dispaly the VOI</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_anatomy_folderpath</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for sequence.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._sequence : sim.mrs_sequence object</span>
<span class="sd">            Sequence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">noise_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for noise_level.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._noise_level : float</span>
<span class="sd">            Noise level in time-domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_level</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_rejection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for data_rejection.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._data_rejection : list of dict</span>
<span class="sd">            Data rejection results (NA, SNR, LW, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_rejection</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_file_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for data_file_hash.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._data_file_hash : string</span>
<span class="sd">            MD5 hash code of data file content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_file_hash</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_concatenated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for is_concatenated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._is_concatenated : boolean</span>
<span class="sd">            True if this current signal is a result of a concatenation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_concatenated</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_rawdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property get function for is_rawdata.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._is_rawdata : boolean</span>
<span class="sd">            True if this current signal was originally read from a raw data file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_rawdata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_analyze_peak_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppm_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find peak in specific ppm range using magnitude mode and return stuff.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ppm_range : list [2]</span>
<span class="sd">            Range in ppm used for peak searching</span>
<span class="sd">        allowed_apodization : float/boolean</span>
<span class="sd">            If &gt;0 or !=False, apodize signal during peak analysis</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        peak_ppm : float</span>
<span class="sd">            Position in PPM of the peak</span>
<span class="sd">        peak_val : np.complex128</span>
<span class="sd">            Peak value</span>
<span class="sd">        peak_lw : float</span>
<span class="sd">            Peak linewidth in Hz</span>
<span class="sd">        peak_seg_ppm : numpy array</span>
<span class="sd">            Peak segment ppm axis</span>
<span class="sd">        peak_seg_val : numpy complex array</span>
<span class="sd">            Peak segment value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># silently zero-fill and apodize if needed</span>
        <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_zerofill_nd</span><span class="p">()</span><span class="o">.</span><span class="n">correct_apodization_nd</span><span class="p">(</span><span class="n">allowed_apodization</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

        <span class="c1"># init</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">sf_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>

        <span class="c1"># mask outside range</span>
        <span class="n">ippm_peak_outside_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">ppm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ppm</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ppm</span> <span class="o">&gt;</span> <span class="n">ppm_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sf_abs</span><span class="p">[</span><span class="n">ippm_peak_outside_range</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># max</span>
        <span class="n">peak_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sf_abs</span><span class="p">)</span>

        <span class="c1"># check</span>
        <span class="k">if</span><span class="p">(</span><span class="n">peak_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no peak found in specified ppm range or badly phased data!&quot;</span><span class="p">)</span>

        <span class="c1"># ppm</span>
        <span class="n">peak_ppm</span> <span class="o">=</span> <span class="n">ppm</span><span class="p">[</span><span class="n">peak_index</span><span class="p">]</span>

        <span class="c1"># complex value</span>
        <span class="n">peak_val</span> <span class="o">=</span> <span class="n">sf</span><span class="p">[</span><span class="n">peak_index</span><span class="p">]</span>

        <span class="c1"># lw</span>
        <span class="n">sf_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
        <span class="n">amp_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_val</span><span class="p">)</span>
        <span class="n">ippm_max</span> <span class="o">=</span> <span class="n">peak_index</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sf_real</span><span class="p">[</span><span class="n">peak_index</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="n">amp_peak</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ippm_min</span> <span class="o">=</span> <span class="n">peak_index</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sf_real</span><span class="p">[</span><span class="n">peak_index</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">amp_peak</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">dppm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ppm</span><span class="p">[</span><span class="n">ippm_max</span><span class="p">]</span> <span class="o">-</span> <span class="n">ppm</span><span class="p">[</span><span class="n">ippm_min</span><span class="p">])</span>
        <span class="n">peak_lw</span> <span class="o">=</span> <span class="n">dppm</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">f0</span>

        <span class="c1"># peak segment</span>
        <span class="n">ippm_half_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ippm_min</span><span class="p">,</span> <span class="n">ippm_max</span><span class="p">)</span>
        <span class="n">ppm_seg</span> <span class="o">=</span> <span class="n">ppm</span><span class="p">[</span><span class="n">ippm_half_peak</span><span class="p">]</span>
        <span class="n">peak_seg</span> <span class="o">=</span> <span class="n">sf</span><span class="p">[</span><span class="n">ippm_half_peak</span><span class="p">]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">peak_ppm</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">peak_lw</span><span class="p">,</span> <span class="n">ppm_seg</span><span class="p">,</span> <span class="n">peak_seg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_analyze_peak_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze a peak in the spectrum by estimating its amplitude, linewidth, frequency shift and phase for each average.</span>

<span class="sd">        * Works only with a 2D [averages,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peak_range : array [2]</span>
<span class="sd">            Range in ppm used to analyze peak phase when no reference signal is specified</span>
<span class="sd">        allowed_apodization : float/boolean</span>
<span class="sd">            If &gt;0 or !=False, apodize signal during peak analysis</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        peak_trace : numpy array [averages,4]</span>
<span class="sd">            Peak changes (amplitude, linewidth, frequency and phase) for each average in raw data</span>
<span class="sd">        peak_trace_rel2mean : numpy array [averages,4]</span>
<span class="sd">            Peak changes (amplitude, linewidth, frequency and phase) for each average in raw data relative to mean value</span>
<span class="sd">        peak_trace_rel2firstpt : numpy array [averages,4]</span>
<span class="sd">            Peak relative changes (amplitude, linewidth, frequency and phase) for each average in raw data relative to 1st point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;analyzing peak for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># apodize if needed</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># first, find peak of interest in range, just to check</span>
        <span class="n">s_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">peak_ppm</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s_avg</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found peak of interest at </span><span class="si">%0.2f</span><span class="s2">ppm!&quot;</span> <span class="o">%</span> <span class="n">peak_ppm</span><span class="p">)</span>

        <span class="c1"># for each average in moving averaged data</span>
        <span class="n">peak_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="s2">&quot;analyzing&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="c1"># call 1D peak analysis</span>
            <span class="n">peak_ppm</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">peak_lw</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>

            <span class="c1"># shift in ppm</span>
            <span class="n">peak_trace</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_ppm</span>
            <span class="c1"># amplitude</span>
            <span class="n">peak_trace</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_val</span><span class="p">)</span>
            <span class="c1"># linewidth in Hz</span>
            <span class="n">peak_trace</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_lw</span>
            <span class="c1"># phase in rad</span>
            <span class="n">peak_trace</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">peak_val</span><span class="p">)</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># normalize stuff</span>

        <span class="c1"># relative to mean</span>
        <span class="n">peak_trace_rel2mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>
        <span class="n">peak_trace_rel2mean</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span>
        <span class="n">peak_trace_rel2mean</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">peak_trace_rel2mean</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">peak_trace_rel2mean</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># relative to 1st pt</span>
        <span class="n">peak_trace_rel2firstpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>
        <span class="n">peak_trace_rel2firstpt</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">peak_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span>
        <span class="n">peak_trace_rel2firstpt</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">peak_trace_rel2firstpt</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">peak_trace_rel2firstpt</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_trace</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">peak_trace</span><span class="p">,</span> <span class="n">peak_trace_rel2mean</span><span class="p">,</span> <span class="n">peak_trace_rel2firstpt</span><span class="p">)</span>

<div class="viewcode-block" id="MRSData2.analyze_noise_nd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.analyze_noise_nd">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_noise_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_pts</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure noise level in time domain and store it in the &quot;noise_level&quot; attribute. This is usefull to keep track of the original noise level for later use, CRB normalization durnig quantification for example.</span>

<span class="sd">        * Works with multi-dimensional signals.</span>
<span class="sd">        * Returns a multi-dimensional signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_pts : int</span>
<span class="sd">            Number of points at the end of the FID signal which we should use to estimate the noise STD</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        noise_lev : float</span>
<span class="sd">            Time-domain noise level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;estimating noise level for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># average if needed</span>
        <span class="k">while</span><span class="p">(</span><span class="n">s_real</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">s_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_real</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;estimating noise level in FID using last </span><span class="si">%d</span><span class="s2"> points...&quot;</span> <span class="o">%</span> <span class="n">n_pts</span><span class="p">)</span>
        <span class="c1"># noise is the std of the last real points, but that is not so simple</span>
        <span class="c1"># we really want real noise, not zeros from zero_filling</span>
        <span class="n">s_nonzero_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_real</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">s_analyze</span> <span class="o">=</span> <span class="n">s_real</span><span class="p">[</span><span class="n">s_nonzero_mask</span><span class="p">]</span>
        <span class="c1"># now take the last n_pts points</span>
        <span class="n">noise_lev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">s_analyze</span><span class="p">[</span><span class="o">-</span><span class="n">n_pts</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;noise level = </span><span class="si">%.2E</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">noise_lev</span><span class="p">)</span>

        <span class="c1"># changing noise level attribute</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;updating noise level...&quot;</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">_noise_level</span> <span class="o">=</span> <span class="n">noise_lev</span>

        <span class="c1"># if any ref data available, analyze noise there too</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">analyze_noise_nd</span><span class="p">(</span><span class="n">n_pts</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.analyze_physio_2d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.analyze_physio_2d">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_physio_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">delta_time_range</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the physiological signal and try to correlate it to a peak amplitude, linewidth, frequency shift and phase variations.</span>

<span class="sd">        * Works only with a 2D [averages,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peak_range : array [2]</span>
<span class="sd">            Range in ppm used to analyze peak phase when no reference signal is specified</span>
<span class="sd">        delta_time_range : float</span>
<span class="sd">            Range in ms used to correlate / match the NMR and the physiological signal. Yes, since we are not really sure of the start timestamp we found in the TWIX header, we try to match perfectly the two signals.</span>
<span class="sd">        allowed_apodization : float/boolean</span>
<span class="sd">            If &gt;0 or !=False, apodize signal during correction process. However, the final corrected signal will not be apodized.</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;analyzing physiological signals for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_physio_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># no physio signal here, exiting</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no error physiological recording file provided!&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>

        <span class="c1"># read data</span>
        <span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="n">rup</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">rr</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read_physio_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_physio_file</span><span class="p">)</span>
        <span class="n">resp_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">rt</span><span class="p">,</span> <span class="n">rup</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">rr</span><span class="p">]</span>
        <span class="c1"># physio signal</span>
        <span class="n">resp_t</span> <span class="o">=</span> <span class="n">resp_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">resp_s</span> <span class="o">=</span> <span class="n">resp_trace</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># perform peak analysis</span>
        <span class="n">peak_prop_abs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_peak_2d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">mri_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">tr</span> <span class="o">*</span> <span class="n">peak_prop_abs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peak_prop_abs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dt_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">delta_time_range</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">delta_time_range</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">cc_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dt_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>

        <span class="c1"># shift signal and calculate corr coeff</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="s2">&quot;correlating signals&quot;</span><span class="p">,</span> <span class="n">dt_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">idt</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dt_array</span><span class="p">):</span>
            <span class="c1"># build time scale</span>
            <span class="n">this_resp_t_interp</span> <span class="o">=</span> <span class="n">mri_t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">dt</span>
            <span class="n">this_resp_s_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">this_resp_t_interp</span><span class="p">,</span> <span class="n">resp_t</span><span class="p">,</span> <span class="n">resp_s</span><span class="p">)</span>

            <span class="c1"># now crop the signals to have the same length</span>
            <span class="n">final_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">this_resp_s_interp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peak_prop_abs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">this_mri_t</span> <span class="o">=</span> <span class="n">mri_t</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">final_length</span><span class="p">]</span>
            <span class="n">this_params_trace</span> <span class="o">=</span> <span class="n">peak_prop_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">final_length</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">this_resp_s_interp</span> <span class="o">=</span> <span class="n">this_resp_s_interp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">final_length</span><span class="p">]</span>

            <span class="c1"># now remove points where resp trace is at 0 or 1</span>
            <span class="n">mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">this_resp_s_interp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_resp_s_interp</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">this_resp_s_interp</span> <span class="o">=</span> <span class="n">this_resp_s_interp</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span>
            <span class="n">this_params_trace</span> <span class="o">=</span> <span class="n">this_params_trace</span><span class="p">[</span><span class="n">mm</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># now, for each parameter</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="c1"># estimate some R coeff</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">this_resp_s_interp</span><span class="p">,</span> <span class="n">this_params_trace</span><span class="p">[:,</span> <span class="n">p</span><span class="p">])</span>
                <span class="n">cc_2d</span><span class="p">[</span><span class="n">idt</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">idt</span><span class="p">)</span>

        <span class="c1"># find time shift that gives best correlation for each parameter</span>
        <span class="n">best_dt_per_par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">i_maxcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cc_2d</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]))</span>
            <span class="n">best_dt</span> <span class="o">=</span> <span class="n">dt_array</span><span class="p">[</span><span class="n">i_maxcorr</span><span class="p">]</span>
            <span class="n">best_dt_per_par</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_dt</span>

        <span class="c1"># find time shift that gives best correlation for all 4 parameters</span>
        <span class="n">cc_2d_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cc_2d</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">i_maxcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc_2d_all</span><span class="p">)</span>
        <span class="n">best_dt_all</span> <span class="o">=</span> <span class="n">dt_array</span><span class="p">[</span><span class="n">i_maxcorr</span><span class="p">]</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

        <span class="c1"># some info in the term</span>
        <span class="n">st_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="n">st_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">st_ms</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;data timestamp=</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ms</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">st_str</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;best start time for...&quot;</span><span class="p">)</span>

        <span class="n">st_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">best_dt_per_par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">st_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">st_ms</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;amplitude=</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ms</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">st_str</span><span class="p">)</span>
        <span class="n">st_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">best_dt_per_par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">st_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">st_ms</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;linewidth=</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ms</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">st_str</span><span class="p">)</span>
        <span class="n">st_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">best_dt_per_par</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">st_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">st_ms</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;frequency=</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ms</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">st_str</span><span class="p">)</span>
        <span class="n">st_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">best_dt_per_par</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">st_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">st_ms</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;phase=</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ms</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">st_str</span><span class="p">)</span>
        <span class="n">st_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">best_dt_all</span>
        <span class="n">st_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">st_ms</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;total=</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ms</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">st_str</span><span class="p">)</span>

        <span class="n">imaxR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">best_dt_per_par</span><span class="p">)</span>
        <span class="n">best_dt</span> <span class="o">=</span> <span class="n">best_dt_per_par</span><span class="p">[</span><span class="n">imaxR</span><span class="p">]</span>
        <span class="n">st_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">best_dt</span>
        <span class="n">st_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">st_ms</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;max R for=</span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ms</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">st_str</span><span class="p">)</span>

        <span class="c1"># time shift the signals with optimal shift</span>
        <span class="c1"># build time scale</span>
        <span class="n">this_resp_t_interp</span> <span class="o">=</span> <span class="n">mri_t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">best_dt</span>
        <span class="n">this_resp_s_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">this_resp_t_interp</span><span class="p">,</span> <span class="n">resp_t</span><span class="p">,</span> <span class="n">resp_s</span><span class="p">)</span>

        <span class="c1"># now crop the signals to have the same length</span>
        <span class="n">final_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">this_resp_s_interp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peak_prop_abs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">this_mri_t</span> <span class="o">=</span> <span class="n">mri_t</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">final_length</span><span class="p">]</span>
        <span class="n">this_params_trace</span> <span class="o">=</span> <span class="n">peak_prop_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">final_length</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">this_resp_s_interp</span> <span class="o">=</span> <span class="n">this_resp_s_interp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">final_length</span><span class="p">]</span>

        <span class="c1"># evaluate correlation coeff.</span>
        <span class="c1"># for each parameter</span>
        <span class="n">cc_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="c1"># estimate some R coeff</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">this_resp_s_interp</span><span class="p">,</span> <span class="n">this_params_trace</span><span class="p">[:,</span> <span class="n">p</span><span class="p">])</span>
            <span class="n">cc_final</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># now let&#39;s talk about FFT</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FFT analysis...&quot;</span><span class="p">)</span>
        <span class="n">nFFT</span> <span class="o">=</span> <span class="mi">2048</span>
        <span class="c1"># freq axis for resp trace</span>
        <span class="n">resp_f_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">nFFT</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="p">(</span><span class="n">resp_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">resp_t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span>  <span class="c1"># Hz ou  / s</span>
        <span class="n">resp_f_axis_bpm</span> <span class="o">=</span> <span class="n">resp_f_axis</span> <span class="o">*</span> <span class="mf">60.0</span>  <span class="c1"># / min</span>
        <span class="c1"># freq axis for params traces</span>
        <span class="n">this_params_trace_f_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">nFFT</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span>  <span class="c1"># Hz ou  / s</span>
        <span class="n">this_params_trace_f_axis_bpm</span> <span class="o">=</span> <span class="n">this_params_trace_f_axis</span> <span class="o">*</span> <span class="mf">60.0</span>  <span class="c1"># / min</span>

        <span class="c1"># FFT of resp. trace</span>
        <span class="n">resp_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">((</span><span class="n">resp_s</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resp_s</span><span class="p">))</span> <span class="o">*</span> <span class="n">signal</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">hann</span><span class="p">(</span><span class="n">resp_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nFFT</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)))</span>

        <span class="c1"># FFT of params traces</span>
        <span class="n">this_params_trace_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nFFT</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">this_params_trace_fft</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">((</span><span class="n">this_params_trace</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">this_params_trace</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]))</span> <span class="o">*</span> <span class="n">signal</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">hann</span><span class="p">(</span><span class="n">this_params_trace</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nFFT</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="c1"># display the cross-correlation plots</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;analyze_physio_2d_1 (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;analyzing physiological signals for [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dt_array</span><span class="p">,</span> <span class="n">cc_2d</span><span class="p">[:,</span> <span class="n">p</span><span class="p">],</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">best_dt_per_par</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">best_dt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time shift (ms)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R amplitude vs. resp.&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R linewidth. vs. resp.&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R frequency vs. resp.&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;R phase vs. resp.&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="c1"># display time signals</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;analyze_physio_2d_2 (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;analyzing physiological signals for [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">cc_final</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">resp_t</span> <span class="o">-</span> <span class="n">best_dt</span><span class="p">,</span> <span class="n">resp_s</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;resp. original&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_mri_t</span><span class="p">,</span> <span class="n">this_resp_s_interp</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;resp. resampled&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">resp_t</span> <span class="o">-</span> <span class="n">best_dt</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">resp_s</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;resp. original&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_mri_t</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">this_resp_s_interp</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;resp. resampled&#39;</span><span class="p">)</span>

                    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_mri_t</span><span class="p">,</span> <span class="n">this_params_trace</span><span class="p">[:,</span> <span class="n">p</span><span class="p">],</span> <span class="s1">&#39;rx-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MR peak property&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rel. amplitude change (%)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. linewidth (Hz)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. frequency (Hz)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. phase shift (rd)&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="c1"># display correlation plots</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">102</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;analyze_physio_2d_3 (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;analyzing physiological signals for [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">this_resp_s_interp</span><span class="p">,</span> <span class="n">this_params_trace</span><span class="p">[:,</span> <span class="n">p</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;resp. (u.a)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;R=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cc_final</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rel. amplitude change (%)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. linewidth (Hz)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. frequency (Hz)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. phase shift (rd)&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="c1"># display FFT plots</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">103</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;analyze_physio_2d_4 (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;analyzing physiological signals for [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">resp_f_axis_bpm</span><span class="p">,</span> <span class="n">resp_fft</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;resp.&#39;</span><span class="p">)</span>
                    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_params_trace_f_axis_bpm</span><span class="p">,</span> <span class="n">this_params_trace_fft</span><span class="p">[:,</span> <span class="n">p</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MR peak property&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency (BPM or 1 / min)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rel. amplitude change (FFT)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. linewidth (FFT)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. frequency (FFT)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. phase shift (FFT)&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        <span class="c1"># done</span>

<div class="viewcode-block" id="MRSData2.analyze_snr_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.analyze_snr_1d">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_snr_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_range</span><span class="p">,</span> <span class="n">noise_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">half_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">magnitude_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the SNR of a peak in the spectrum ; chemical shift ranges for the peak and the noise regions are specified by the user. Can also look at time-domain SNR. Works only for a 1D MRSData2 objects.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peak_range : list [2]</span>
<span class="sd">            Range in ppm used to find a peak of interest</span>
<span class="sd">        noise_range : list [2]</span>
<span class="sd">            Range in ppm used to estimate noise</span>
<span class="sd">        half_factor : float</span>
<span class="sd">            If (True), will divide the SNR by 2 folowing an old definition of the SNR where the std of noise is multiplied by two. Btw, this outdated definition is used by LCModel.</span>
<span class="sd">        magnitude_mode : boolean</span>
<span class="sd">            analyze signal in magnitude mode (True) or the real part (False)</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        snr : float</span>
<span class="sd">            Resulting SNR value</span>
<span class="sd">        s : float</span>
<span class="sd">            Resulting signal value</span>
<span class="sd">        n : float</span>
<span class="sd">            Resulting noise value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;analyzing SNR for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># display</span>
        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;analyze_snr_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;analyzing SNR for [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="c1"># find maximum peak in range</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="c1"># analyze peak WITHOUT ANY apodization (important)</span>
        <span class="n">ppm_peak</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">magnitude_mode</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;measuring the MAGNITUDE intensity at </span><span class="si">%0.2f</span><span class="s2">ppm!&quot;</span> <span class="o">%</span> <span class="n">ppm_peak</span><span class="p">)</span>
            <span class="n">snr_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_val</span><span class="p">)</span>
            <span class="n">sf_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;measuring the REAL intensity at </span><span class="si">%0.2f</span><span class="s2">ppm!&quot;</span> <span class="o">%</span> <span class="n">ppm_peak</span><span class="p">)</span>
            <span class="n">snr_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_val</span><span class="p">)</span>
            <span class="n">sf_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>

        <span class="c1"># estimate noise in user specified spectral region</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;estimating noise from </span><span class="si">%0.2f</span><span class="s2"> to </span><span class="si">%0.2f</span><span class="s2">ppm region!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">noise_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noise_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ippm_noise_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ppm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ppm</span> <span class="o">&lt;</span> <span class="n">noise_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">snr_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sf_noise</span><span class="p">[</span><span class="n">ippm_noise_range</span><span class="p">])</span>
        <span class="k">if</span><span class="p">(</span><span class="n">half_factor</span><span class="p">):</span>
            <span class="n">snr_noise</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">snr_noise</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sf</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;real part&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sf</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;magnitude mode&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span><span class="n">magnitude_mode</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># show peak of interest</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm_peak</span><span class="p">,</span> <span class="n">snr_signal</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_peak</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="c1"># show noise region</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">[</span><span class="n">ippm_noise_range</span><span class="p">],</span> <span class="n">sf_noise</span><span class="p">[</span><span class="n">ippm_noise_range</span><span class="p">],</span> <span class="s1">&#39;bo&#39;</span><span class="p">)</span>

        <span class="c1"># finish display</span>
        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># that&#39;s it</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">snr_signal</span> <span class="o">/</span> <span class="n">snr_noise</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;results for [&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">display_label</span> <span class="o">+</span> <span class="s2">&quot;] coming...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;S = </span><span class="si">%.2E</span><span class="s2">, N = </span><span class="si">%.2E</span><span class="s2">, SNR = </span><span class="si">%0.2f</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snr_signal</span><span class="p">,</span> <span class="n">snr_noise</span><span class="p">,</span> <span class="n">snr</span><span class="p">))</span>

        <span class="k">return</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span> <span class="n">snr_signal</span><span class="p">,</span> <span class="n">snr_noise</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.analyze_linewidth_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.analyze_linewidth_1d">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_linewidth_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_range</span><span class="p">,</span> <span class="n">magnitude_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the linewidth of a peak in the spectrum ; chemical shift ranges for the peak and the noise regions are specified by the user.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peak_range : list [2]</span>
<span class="sd">            Range in ppm used to find a peak of interest</span>
<span class="sd">        magnitude_mode : boolean</span>
<span class="sd">            analyze signal in magnitude mode (True) or the real part (False)</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lw : float</span>
<span class="sd">            Linewidth in Hz</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;analyzing peak linewidth for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># call 1D peak analysis WITHOUT ANY apodization (important)</span>
        <span class="n">ppm_peak</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">peak_seg_ppm</span><span class="p">,</span> <span class="n">peak_seg_val</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">magnitude_mode</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;estimating the MAGNITUDE peak linewidth at </span><span class="si">%0.2f</span><span class="s2">ppm!&quot;</span> <span class="o">%</span> <span class="n">ppm_peak</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;estimating the REAL peak linewidth at </span><span class="si">%0.2f</span><span class="s2">ppm!&quot;</span> <span class="o">%</span> <span class="n">ppm_peak</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;results for [&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">display_label</span> <span class="o">+</span> <span class="s2">&quot;] coming...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LW = </span><span class="si">%0.2f</span><span class="s2"> Hz!&quot;</span> <span class="o">%</span> <span class="n">lw</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;analyze_linewidth_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;analyzing peak linewidth for [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sf</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;real part&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sf</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;magnitude mode&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span><span class="n">magnitude_mode</span><span class="p">):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_seg_ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_seg_val</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_seg_ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_seg_val</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_intensity_scaling_nd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_intensity_scaling_nd">[docs]</a>    <span class="k">def</span> <span class="nf">correct_intensity_scaling_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaling_factor_rawdata</span><span class="o">=</span><span class="mf">1e8</span><span class="p">,</span> <span class="n">scaling_factor_dcm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Amplify the FID signals. Sounds useless but can actually help during quantification! Yes, it is not a good idea to fit signals which have intensities around 1e-6 or lower because of various fit tolerances and also digital problems (epsilon).</span>

<span class="sd">        * Works with multi-dimensional signals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scaling_factor_rawdata : float</span>
<span class="sd">            Amplification factor if data is raw</span>
<span class="sd">        scaling_factor_dcm : float</span>
<span class="sd">            Amplification factor if data is from a dcm file (already amplified)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s : MRSData2 numpy array [whatever dimensions]</span>
<span class="sd">            Resulting amplified MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;intensity scaling [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_rawdata</span><span class="p">):</span>
            <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">scaling_factor_rawdata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">scaling_factor_dcm</span>

        <span class="c1"># scale signal</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;multiplying time-domain signals by </span><span class="si">%E</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">scaling_factor</span><span class="p">)</span>
        <span class="n">s_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="n">scaling_factor</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_sc</span><span class="p">)</span>

        <span class="c1"># if any ref data available, we crop it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_sc</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_sc</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_sc</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_intensity_scaling_nd</span><span class="p">(</span><span class="n">scaling_factor</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_sc</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_fidmodulus_nd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_fidmodulus_nd">[docs]</a>    <span class="k">def</span> <span class="nf">correct_fidmodulus_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate absolute mode of FID signals. I am not sure I am doing this correctly but it is a first attempt.</span>

<span class="sd">        * Works with multi-dimensional signals.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s : MRSData2 numpy array [whatever dimensions]</span>
<span class="sd">            Resulting FID modulus data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># init</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;fid modulus [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;calculation magnitude of signal...&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># return magnitude</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_zerofill_nd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_zerofill_nd">[docs]</a>    <span class="k">def</span> <span class="nf">correct_zerofill_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nPoints_final</span><span class="o">=</span><span class="mi">16384</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Zero-fill MRS data signals along the time axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nPoints_final : int</span>
<span class="sd">            Final number of points</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        * Works with multi-dimensional signals.</span>
<span class="sd">        * Returns a multi-dimensional signal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_zf : MRSData2 numpy array [whatever,...,timepoints]</span>
<span class="sd">            Resulting zero-filled data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># init</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;zero_filling [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># check</span>
        <span class="n">nZeros</span> <span class="o">=</span> <span class="n">nPoints_final</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">np</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nZeros</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no zero-filling performed. The number of zeros to add was negative (</span><span class="si">%d</span><span class="s2">)!&quot;</span> <span class="o">%</span> <span class="n">nZeros</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">s_new_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">s_new_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nZeros</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-pts signal + </span><span class="si">%d</span><span class="s2"> zeros = </span><span class="si">%d</span><span class="s2">-pts zero-filled signal...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">np</span><span class="p">,</span> <span class="n">nZeros</span><span class="p">,</span> <span class="n">nPoints_final</span><span class="p">))</span>
        <span class="n">s_zf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_new_shape</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># sequence npts</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_zf</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;updating sequence.npts...&quot;</span><span class="p">)</span>
            <span class="n">s_zf</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="n">nPoints_final</span>
            <span class="n">s_zf</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">s_disp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">s_zf_disp</span> <span class="o">=</span> <span class="n">s_zf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">while</span><span class="p">(</span><span class="n">s_disp</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">s_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_disp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">s_zf_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_zf_disp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">130</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_zerofill_nd (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;zero_filling [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="c1"># no time axis, we want to see the number of points</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s_disp</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;number of points&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s_zf_disp</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;number of points&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;zero-filled&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_disp</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_disp</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_zf_disp</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_zf_disp</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;chemical shift (ppm)&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;zero-filled&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># if any ref data available, we crop it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_zf</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_zf</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_zf</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_zerofill_nd</span><span class="p">(</span><span class="n">nPoints_final</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_zf</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_time_shift_nd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_time_shift_nd">[docs]</a>    <span class="k">def</span> <span class="nf">correct_time_shift_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_shift_us</span><span class="o">=-</span><span class="mi">375</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shift time signals of Zero-fill MRS data signals along the time axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time_shift_us : float</span>
<span class="sd">            Time shift to apply to time signals. Negative means the beginning of the FIDs will be eaten up and circshifted at the end.</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        * Works with multi-dimensional signals.</span>
<span class="sd">        * Returns a multi-dimensional signal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_shifted : MRSData2 numpy array [averages,channels,timepoints]</span>
<span class="sd">            Resulting shifted data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;time_shifting [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># prepare frequency vector</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">f_tiles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">f_tiles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_tiles</span><span class="p">)</span>

        <span class="c1"># fft</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axes</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># apply phase 1st order in frequency-frequency domain (which is equivalent to a time shift in time domain)</span>
        <span class="n">sf_shifted</span> <span class="o">=</span> <span class="n">sf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="o">-</span><span class="n">time_shift_us</span> <span class="o">/</span> <span class="mf">1000000.0</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span>
        <span class="c1"># fft back and prey</span>
        <span class="n">s_shifted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">sf_shifted</span><span class="p">,</span> <span class="n">axes</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_shifted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_shifted</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1000000.0</span>  <span class="c1"># us</span>
            <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

            <span class="n">s_disp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">s_shifted_disp</span> <span class="o">=</span> <span class="n">s_shifted</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">while</span><span class="p">(</span><span class="n">s_disp</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">s_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_disp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">s_shifted_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_shifted_disp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">140</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_time_shift_nd (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;time_shifting [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s_disp</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (us)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s_shifted_disp</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (us)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;time-shifted&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_disp</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_shifted_disp</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;chemical shift (ppm)&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;time-shifted&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># if any ref data available, we crop it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_shifted</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_shifted</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_shifted</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_time_shift_nd</span><span class="p">(</span><span class="n">time_shift_us</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_shifted</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_phase_3d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_phase_3d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_phase_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_ref_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">peak_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">average_per_channel_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_point_fid_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">phase_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phase_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Well, that&#39;s a big one but basically it rephases the signal of interest.</span>

<span class="sd">        &gt;In the case of multi-channel acquisition, the phase will be estimated for each channel, for each average using phase time evolution estimated on reference signal.</span>
<span class="sd">        &gt;If the reference signal is not specified and weak water suppression was performed, 0th order phase correction will be done using the first point in the fid.</span>
<span class="sd">        &gt;If strong water suppression was performed, 0th order phase correction will be done using the phase of a peak in the spectrum; the chemical shift range to find this peak is specified by the user.</span>
<span class="sd">        &gt;&gt;Note that those last two approaches can be performed for each average in the case of high SNR (rare) or by averaging all the scans for each channel in the case of lower SNR.</span>

<span class="sd">        * Works only with a 3D [averages,channels,timepoints] signal.</span>
<span class="sd">        * Returns a 3D [averages,channels,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_ref_data : boolean</span>
<span class="sd">            Use reference data (usually non water suppressed) for phasing</span>
<span class="sd">        peak_range : list [2]</span>
<span class="sd">            Range in ppm used to peak-pick and estimate a phase</span>
<span class="sd">        average_per_channel_mode : boolean</span>
<span class="sd">            Average all the averages for each channel when doing peak analysis</span>
<span class="sd">        first_point_fid_mode : boolean</span>
<span class="sd">            Estimate phase from 1st point of FID</span>
<span class="sd">        phase_order : int</span>
<span class="sd">            Order of phasing: 0(th) or 1(st) order phasing</span>
<span class="sd">        phase_offset : float</span>
<span class="sd">            Phase added to signal (rad)</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_phased : MRSData2 numpy array [averages,channels,timepoints]</span>
<span class="sd">            Resulting phased data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;phasing [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 3D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># check if any ref data</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">use_ref_data</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;you want to phase data based on ref. data but no such data is available!&quot;</span><span class="p">)</span>
            <span class="n">use_ref_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># dimensions check for reference data</span>
        <span class="k">if</span><span class="p">(</span><span class="n">use_ref_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 3D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional reference data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s_phased</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># list of phasing methods</span>
        <span class="n">list_phase_method</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">list_phase_method</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0th &amp; 1st order phase from ref. scan FID (method #0)&quot;</span>
        <span class="n">list_phase_method</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0th order only phase from ref. scan FID (method #1)&quot;</span>
        <span class="n">list_phase_method</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0th order phase from 1st pt in FID (method #2)&quot;</span>
        <span class="n">list_phase_method</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0th order phase from 1st pt in averaged FID (method #3)&quot;</span>
        <span class="n">list_phase_method</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0th order phase from peak in spectrum (method #4)&quot;</span>
        <span class="n">list_phase_method</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0th order phase from peak in averaged spectrum (method #5)&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

        <span class="c1"># choose which method is adequate</span>
        <span class="n">only_0th_order</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">use_ref_data</span><span class="p">):</span>
            <span class="c1"># we have a ref scan, so method #0 or #1</span>
            <span class="n">phase_method</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">only_0th_order</span>
            <span class="n">t_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we do not have a ref scan, so method #2, #3, #4, #5</span>
            <span class="c1"># that depends on water intensity and water suppression</span>
            <span class="k">if</span><span class="p">(</span><span class="n">first_point_fid_mode</span><span class="p">):</span>
                <span class="n">phase_method</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase_method</span> <span class="o">=</span> <span class="mi">4</span>

            <span class="c1"># and on SNR</span>
            <span class="k">if</span><span class="p">(</span><span class="n">average_per_channel_mode</span><span class="p">):</span>
                <span class="n">phase_method</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="c1"># prepare subplots</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_phase_3d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;phasing [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="c1"># display chosen method</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;phasing using method: &quot;</span> <span class="o">+</span> <span class="n">list_phase_method</span><span class="p">[</span><span class="n">phase_method</span><span class="p">])</span>

        <span class="c1"># for each channel</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

            <span class="k">if</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">phase_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># time-domain phase of reference signal for this channel</span>
                <span class="n">sp_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:])</span>

                <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
                    <span class="c1"># display reference FID</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_ref</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;real part&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_ref</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;imag part&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;intensity (u.a)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ref - channel #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="c1"># display reference time-domain phase</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_ref</span><span class="p">,</span> <span class="n">sp_ref</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;unwrapped phase&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;phase (rd)&quot;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ref - channel #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="c1"># phase of first point in averaged fid</span>
                <span class="n">s_avg</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">phase_fid_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">s_avg</span><span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">5</span><span class="p">):</span>
                <span class="c1"># phase of peak in averaged spectrum</span>
                <span class="n">s_avg</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># find maximum peak in range and its phase</span>
                <span class="n">peak_ppm</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s_avg</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">)</span>
                <span class="n">phase_peak_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">peak_val</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;measuring phase at </span><span class="si">%0.2f</span><span class="s2">ppm on 1st channel!&quot;</span> <span class="o">%</span> <span class="n">peak_ppm</span><span class="p">)</span>

            <span class="c1"># late init progress bar</span>
            <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pbar</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="s2">&quot;phasing&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># now, for each average in meta signal acquired with this channel</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

                <span class="c1"># this spectrum</span>
                <span class="n">this_s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">this_sf</span> <span class="o">=</span> <span class="n">this_s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>

                <span class="k">if</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># correct phase using reference time-domain phase estimation</span>
                    <span class="n">this_s_phased</span> <span class="o">=</span> <span class="n">this_s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">sp_ref</span> <span class="o">+</span> <span class="n">phase_offset</span><span class="p">))</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># correct phase using first point of reference time-domain phase estimation</span>
                    <span class="n">this_s_phased</span> <span class="o">=</span> <span class="n">this_s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">sp_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">phase_offset</span><span class="p">))</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="c1"># phase of first point of this fid</span>
                    <span class="n">phase_fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">this_s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># and apply it to correct the spectrum</span>
                    <span class="n">this_s_phased</span> <span class="o">=</span> <span class="n">this_s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">phase_fid</span> <span class="o">+</span> <span class="n">phase_offset</span><span class="p">))</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="c1"># apply to correct the spectrum</span>
                    <span class="n">this_s_phased</span> <span class="o">=</span> <span class="n">this_s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">phase_fid_avg</span> <span class="o">+</span> <span class="n">phase_offset</span><span class="p">))</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="c1"># find maximum peak in range and its phase</span>
                    <span class="n">peak_ppm</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">this_s</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">)</span>
                    <span class="n">phase_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">peak_val</span><span class="p">)</span>

                    <span class="c1"># apply phase to spectrum</span>
                    <span class="n">this_sf_phased</span> <span class="o">=</span> <span class="n">this_sf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">phase_peak</span> <span class="o">+</span> <span class="n">phase_offset</span><span class="p">))</span>
                    <span class="c1"># ifft back</span>
                    <span class="n">this_s_phased</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">this_sf_phased</span><span class="p">))</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="c1"># apply phase to spectrum</span>
                    <span class="n">this_sf_phased</span> <span class="o">=</span> <span class="n">this_sf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">phase_peak_avg</span> <span class="o">+</span> <span class="n">phase_offset</span><span class="p">))</span>
                    <span class="c1"># ifft back</span>
                    <span class="n">this_s_phased</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">this_sf_phased</span><span class="p">))</span>

                <span class="c1"># store</span>
                <span class="n">s_phased</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">this_s_phased</span>

                <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>

                    <span class="c1"># convert back to MRSData2</span>
                    <span class="n">this_s_phased</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">this_s_phased</span><span class="p">)</span>

                    <span class="c1"># display original meta FID</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">this_s</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;real part&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">this_s</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;imag part&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Meta channel #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; average #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="c1"># display original meta spectrum</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">this_sf</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;real part&#39;</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">phase_method</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">phase_method</span> <span class="o">==</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_val</span><span class="p">),</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">peak_ppm</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Meta channel #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; average #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="c1"># display corrected meta FID</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">this_s_phased</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;real part&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;corrected&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

                    <span class="c1"># display corrected meta spectrum</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">this_s_phased</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;real part&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency (ppm)&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;corrected&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_phased</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_phased</span><span class="p">)</span>

        <span class="c1"># if any ref data available, we phase it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_phased</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_phased</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_phased</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_phase_3d</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_phased</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_combine_channels_3d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_combine_channels_3d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_combine_channels_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_ref_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">channels_onoff</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recombine Rx channels using SVD stuff. If no reference signal is specified, the recombination weights will be calculated from the signal of interest (not optimal).</span>

<span class="sd">        * Works only with a 3D [averages,channels,timepoints] signal.</span>
<span class="sd">        * Returns a 2D [averages,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_ref_data : boolean</span>
<span class="sd">            Use reference data (usually non water suppressed) for channel combining</span>
<span class="sd">        phasing : boolean</span>
<span class="sd">            Allow 0th order phasing during channel combine or not</span>
<span class="sd">        channels_onoff : boolean list [nChannels]</span>
<span class="sd">            Binary weights to apply to each channel for example to turn off some of them</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_combined : MRSData2 numpy array [averages,timepoints]</span>
<span class="sd">            Resulting channel combined data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;channel combining [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 3D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># check if any ref data</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">use_ref_data</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;you want to channel-combine data based on ref. data but no such data is available!&quot;</span><span class="p">)</span>
            <span class="n">use_ref_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># dimensions check for reference data</span>
        <span class="k">if</span><span class="p">(</span><span class="n">use_ref_data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 3D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional reference data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;this is a single-channel signal, no need to recombine this!&quot;</span><span class="p">)</span>
            <span class="n">s_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;reshaped to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s_combined</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">phasing</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">use_ref_data</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;channel recombine WITH reference scan AND phasing (original suspect code)...&quot;</span><span class="p">)</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">channel_combination</span><span class="o">.</span><span class="n">svd_weighting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;channel recombine WITHOUT reference scan AND phasing (original suspect code)...&quot;</span><span class="p">)</span>
                    <span class="n">s_dirty_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">channel_combination</span><span class="o">.</span><span class="n">svd_weighting</span><span class="p">(</span><span class="n">s_dirty_mean</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">use_ref_data</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;channel recombine WITH reference scan &amp; NO phasing...&quot;</span><span class="p">)</span>
                    <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">channel_weights</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="o">-</span><span class="n">channel_weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">channel_weights</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;channel recombine reference scan &amp; NO phasing...&quot;</span><span class="p">)</span>
                    <span class="n">s_dirty_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">p</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">s_dirty_mean</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">channel_weights</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="o">-</span><span class="n">channel_weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">channel_weights</span><span class="p">))</span>

            <span class="c1"># turn off some channels ?</span>
            <span class="n">channels_onoff_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels_onoff</span><span class="p">)</span>
            <span class="k">if</span><span class="p">((</span><span class="n">channels_onoff_np</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                <span class="n">channels_onoff_float</span> <span class="o">=</span> <span class="n">channels_onoff_np</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;playing with channel weights...&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">channels_onoff_float</span><span class="p">))</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">channels_onoff_float</span>

            <span class="n">s_combined</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">channel_combination</span><span class="o">.</span><span class="n">combine_channels</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_combined</span><span class="p">)</span>

        <span class="c1"># if any ref data available, we combine it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_combined</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_combined</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_combined</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_combine_channels_3d</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">channels_onoff</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_combined</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.concatenate_2d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.concatenate_2d">[docs]</a>    <span class="k">def</span> <span class="nf">concatenate_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate current signal with another one along the averages axis.</span>

<span class="sd">        * Works only with a 2D [averages,timepoints] signal.</span>
<span class="sd">        * Returns a 2D [averages,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : MRSData2 numpy array [averages,timepoints]</span>
<span class="sd">            MRS data to concatenate to the current data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_concatenated : MRSData2 numpy array [averages,timepoints]</span>
<span class="sd">            Resulting concatenated signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;concatenating [</span><span class="si">%s</span><span class="s2">] to [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">display_label</span><span class="p">))</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;concatenating dataset shapes &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; ...&quot;</span><span class="p">)</span>

        <span class="n">s_concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_concatenated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_concatenated</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;obtained a dataset shape &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s_concatenated</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="c1"># update some attributes</span>
        <span class="n">s_concatenated</span><span class="o">.</span><span class="n">_is_concatenated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_concatenated</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_build_moving_average_data_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nAvgWindow</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build moving average data in the average dimension. Usefull for the analyze_peak and correct_realign_2d functions.</span>

<span class="sd">        * Works only with a 2D [averages,timepoints] signal.</span>
<span class="sd">        * Returns a 2D [averages,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nAvgWindow : int</span>
<span class="sd">            Size of the moving average window</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_ma : MRSData2 numpy array [averages,timepoints]</span>
<span class="sd">            Resulting moving average data stored in a MRSData2 object. The number of averages is the same as the original data BUT each of those average is actually an average of nAvgWindow spectra.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;calculating moving average for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;moving averaging with window of </span><span class="si">%d</span><span class="s2"> samples!&quot;</span> <span class="o">%</span> <span class="n">nAvgWindow</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># number of averages for moving average?</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">nAvgWindow</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">nAvgWindow</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># build moving averaged data</span>
        <span class="n">s_ma</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">moving_averages_half</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">nAvgWindow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ia</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">moving_averages_half</span><span class="p">)</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span> <span class="o">+</span> <span class="n">moving_averages_half</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">s_ma</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">ia</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_ma</span><span class="p">)</span>

<div class="viewcode-block" id="MRSData2.correct_analyze_and_reject_2d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_analyze_and_reject_2d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_analyze_and_reject_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_analyze_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">peak_snr_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">],</span> <span class="n">peak_lw_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">moving_averages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reject_when_linewidth_fails</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">peak_properties_ranges</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;amplitude (%)&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;linewidth (Hz)&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">],</span> <span class="s2">&quot;chemical shift (ppm)&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;phase std. factor (%)&quot;</span><span class="p">:</span> <span class="mf">60.0</span><span class="p">},</span> <span class="n">peak_properties_rel2mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_method_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_adjust_allowed_snr_change</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze peak in each average in terms intensity, linewidth, chemical shift and phase and reject data if one of these parameters goes out of the min / max bounds. Usefull to understand what the hell went wrong during your acquisition when you have the raw data and to try to improve things a little. You can choose to set the bounds manually or automatically based on a peak property (amplitude, linewidth, frequency, phase). And you can run several automatic adjusment methods, the one giving the highest SNR and/or the lowest peak linewidth will be selected. All this is very experimental and the code is long and not optimized, sorry ;).</span>
<span class="sd">    Special note about the optimization: when does it stop? First, the algorithm tries to optimize the data rejection to get a SNR higher than the (initial SNR * auto_adjust_allowed_snr_change). If the latter is not possible, then the algorithm tries to reduce the linewidth without reducing SNR compared to the initial SNR. If nothing works out, no data rejection is performed except maybe based on peak detection (see reject_when_linewidth_fails).</span>

<span class="sd">        * Works only with a 2D [averages,timepoints] signal.</span>
<span class="sd">        * Returns a 2D [averages,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peak_analyze_range : list</span>
<span class="sd">            Range in ppm used to analyze peak properties (amplitude, linewidth, chemical shift, phase)</span>
<span class="sd">        peak_snr_range : list</span>
<span class="sd">            Range in ppm used to estimate SNR</span>
<span class="sd">        peak_lw_range : list</span>
<span class="sd">            Range in ppm used to estimate linewidth</span>
<span class="sd">        moving_averages : int</span>
<span class="sd">            Number of averages to perform when using moving average, need to be an odd number</span>
<span class="sd">        reject_when_linewidth_fails : boolean</span>
<span class="sd">            Reject data if linewidth estimatiopn fails (=0Hz). Usually when the peak looks so bad that the peak width cannot be measured...</span>
<span class="sd">        peak_properties_ranges : dict</span>
<span class="sd">            Dictionnary that contains 4 entries, 4 rejection criterias for</span>
<span class="sd">                &quot;amplitude (%)&quot;: amplitude relative changes: keep data if within +/-val % range</span>
<span class="sd">                &quot;linewidth (Hz)&quot;: linewidth changes: keep data is within values in Hz</span>
<span class="sd">                &quot;chemical shift (ppm)&quot;: chemical shift changes: keep data is within +/-val ppm</span>
<span class="sd">                &quot;phase std. factor (%)&quot;: phase changes: keep data if within +/- val/100 * std(phase) rd</span>
<span class="sd">        peak_properties_rel2mean : boolean</span>
<span class="sd">            Relative peak properties (amplitude, chemical shift and phase) should be caculated based on the mean value over the whole acquisition (True) or only the first acquired point (False)</span>
<span class="sd">        auto_method_list : list of data_rejection_method</span>
<span class="sd">            Automatic rejection bounds adjustment methods</span>
<span class="sd">        auto_adjust_allowed_snr_change : float</span>
<span class="sd">            Allowed change in SNR (%), a positive or negative relative to the initial SNR without data rejection</span>
<span class="sd">        allowed_apodization : float/boolean</span>
<span class="sd">            If &gt;0 or !=False, apodize signal during correction process. However, the final corrected signal will not be apodized.</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_cor : MRSData2 numpy array [averages,timepoints]</span>
<span class="sd">           Data remaining after data rejection stored in a MRSData2 object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;analyzing data and rejecting some for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;single-shot signal, nothing to analyze!&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

        <span class="c1"># check if we did data rejection before</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rejection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">iround_data_rej</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iround_data_rej</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rejection</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">th round of data rejection!&quot;</span> <span class="o">%</span> <span class="n">iround_data_rej</span><span class="p">)</span>

        <span class="c1"># estimate initial SNR and linewidth</span>
        <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        <span class="n">s_avg</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">correct_average_2d</span><span class="p">()</span>
        <span class="n">initial_snr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s_avg</span><span class="o">.</span><span class="n">analyze_snr_1d</span><span class="p">(</span><span class="n">peak_snr_range</span><span class="p">)</span>
        <span class="n">initial_lw</span> <span class="o">=</span> <span class="n">s_avg</span><span class="o">.</span><span class="n">analyze_linewidth_1d</span><span class="p">(</span><span class="n">peak_lw_range</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Pre-data-rejection SNR = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">initial_snr</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Pre-data-rejection linewidth = </span><span class="si">%.2f</span><span class="s2"> Hz&quot;</span> <span class="o">%</span> <span class="n">initial_lw</span><span class="p">)</span>

        <span class="c1"># build moving averaged data</span>
        <span class="n">s_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_moving_average_data_2d</span><span class="p">(</span><span class="n">moving_averages</span><span class="p">)</span>

        <span class="c1"># perform peak analysis (possibly with apodization to stabilize things)</span>
        <span class="n">peak_prop_abs</span><span class="p">,</span> <span class="n">peak_prop_rel2mean</span><span class="p">,</span> <span class="n">peak_prop_rel2firstpt</span> <span class="o">=</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">_analyze_peak_2d</span><span class="p">(</span><span class="n">peak_analyze_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>

        <span class="c1"># first set the data according to relative option: this is a user option</span>
        <span class="k">if</span><span class="p">(</span><span class="n">peak_properties_rel2mean</span><span class="p">):</span>
            <span class="n">peak_prop_rel</span> <span class="o">=</span> <span class="n">peak_prop_rel2mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peak_prop_rel</span> <span class="o">=</span> <span class="n">peak_prop_rel2firstpt</span>

        <span class="c1"># choose if absolute or relative will be analyzed: this is hard-coded</span>
        <span class="n">peak_prop_analyze</span> <span class="o">=</span> <span class="n">peak_prop_abs</span> <span class="o">*</span> <span class="mf">0.0</span>
        <span class="c1"># amplitude: relative in %</span>
        <span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_rel</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># linewidth: absolute in Hz</span>
        <span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_abs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># frequency: relative in ppm</span>
        <span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_rel</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># phase: absolute in rad</span>
        <span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_rel</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="c1"># choose if absolute or relative will be displayed</span>
        <span class="n">peak_prop_disp</span> <span class="o">=</span> <span class="n">peak_prop_rel</span> <span class="o">*</span> <span class="mf">0.0</span>
        <span class="c1"># amplitude: relative in %</span>
        <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_rel</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># linewidth: absolute in Hz</span>
        <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_abs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># frequency: absolute in ppm</span>
        <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_abs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># phase: absolute in rad</span>
        <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_abs</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="c1"># our time scale</span>
        <span class="n">t_ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1000.0</span>  <span class="c1"># s</span>

        <span class="c1"># stats</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;peak analysis: means  std. deviations&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rel. peak amplitude = </span><span class="si">%.2f</span><span class="s2">  </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;abs. linewidth = </span><span class="si">%.1f</span><span class="s2">  </span><span class="si">%.1f</span><span class="s2"> Hz (</span><span class="si">%.3f</span><span class="s2">  </span><span class="si">%.3f</span><span class="s2"> ppm)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;abs. frequency = </span><span class="si">%.2f</span><span class="s2">  </span><span class="si">%.2f</span><span class="s2"> ppm ( </span><span class="si">%.1f</span><span class="s2"> Hz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;abs. phase = </span><span class="si">%.2f</span><span class="s2">  </span><span class="si">%.2f</span><span class="s2"> rad&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>

        <span class="c1"># check for Nones</span>
        <span class="n">peak_properties_ranges_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">peak_properties_ranges</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">peak_properties_ranges_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peak_properties_ranges_list</span><span class="p">]</span>

        <span class="c1"># special for linewidth: can be a max linewidth or a list</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># reject when peak linewidth fails</span>
        <span class="k">if</span><span class="p">(</span><span class="n">reject_when_linewidth_fails</span><span class="p">):</span>
            <span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="c1"># special for phase: rejection range is a factor of std</span>
        <span class="n">phase_std</span> <span class="o">=</span> <span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">phase_std_reject_range</span> <span class="o">=</span> <span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">phase_std</span>

        <span class="c1"># prepare rejection min/max vectors</span>
        <span class="n">peak_prop_min</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                         <span class="o">-</span><span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                         <span class="o">-</span><span class="n">phase_std_reject_range</span><span class="p">]</span>

        <span class="n">peak_prop_max</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                         <span class="o">+</span><span class="n">peak_properties_ranges_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                         <span class="o">+</span><span class="n">phase_std_reject_range</span><span class="p">]</span>

        <span class="c1"># automatic rejection ?</span>
        <span class="k">if</span><span class="p">(</span><span class="n">auto_method_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>

            <span class="c1"># init</span>
            <span class="n">display_axes_ready</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
            <span class="n">properties_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">peak_properties_ranges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">auto_method_final_snr_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">auto_method_final_lw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">peak_prop_min_auto_res</span> <span class="o">=</span> <span class="n">peak_prop_min</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">peak_prop_max_auto_res</span> <span class="o">=</span> <span class="n">peak_prop_max</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># for each auto method</span>
            <span class="k">for</span> <span class="n">this_auto_method</span> <span class="ow">in</span> <span class="n">auto_method_list</span><span class="p">:</span>
                <span class="c1"># prepare min/max peak property range</span>
                <span class="n">this_prop_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">this_prop_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="c1"># get range resolution from constants</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_auto_method</span> <span class="o">==</span> <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_AMPLITUDE</span><span class="p">):</span>
                    <span class="n">this_prop_step</span> <span class="o">=</span> <span class="n">DATA_REJECTION_AMPLITUDE_STEP</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">this_auto_method</span> <span class="o">==</span> <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_LINEWIDTH</span><span class="p">):</span>
                    <span class="n">this_prop_step</span> <span class="o">=</span> <span class="n">DATA_REJECTION_LINEWIDTH_STEP</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">this_auto_method</span> <span class="o">==</span> <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_FREQUENCY</span><span class="p">):</span>
                    <span class="n">this_prop_step</span> <span class="o">=</span> <span class="n">DATA_REJECTION_FREQUENCY_STEP</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">this_auto_method</span> <span class="o">==</span> <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_PHASE</span><span class="p">):</span>
                    <span class="n">this_prop_step</span> <span class="o">=</span> <span class="n">DATA_REJECTION_PHASE_STEP</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;upsyy! I am not aware of this automatic data rejection method: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">this_auto_method</span><span class="p">))</span>

                <span class="c1"># generate a range to test, using the resolution</span>
                <span class="n">this_prop_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">this_prop_min</span> <span class="o">-</span> <span class="n">this_prop_step</span><span class="p">,</span> <span class="n">this_prop_max</span> <span class="o">+</span> <span class="n">this_prop_step</span><span class="p">,</span> <span class="n">this_prop_step</span><span class="p">)</span>

                <span class="c1"># checking that there is actually a variation and a range to test</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_prop_range</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># no? let&#39;s skip this method</span>
                    <span class="n">this_prop_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">this_prop_min</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># now let&#39;s be smart and reduce the number of values to test according to the peak property measurements</span>
                    <span class="c1"># regrid to nearest in previously computed range</span>
                    <span class="n">this_prop_analyze_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                    <span class="n">this_prop_analyze_set</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">this_prop_range</span><span class="p">,</span> <span class="n">this_prop_range</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)(</span><span class="n">this_prop_analyze_set</span><span class="p">)</span>
                    <span class="c1"># remove one step resolution, remove duplicates and sort</span>
                    <span class="n">this_prop_analyze_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">this_prop_analyze_set</span> <span class="o">-</span> <span class="n">this_prop_step</span><span class="p">))))</span>
                    <span class="c1"># remove negative values</span>
                    <span class="n">this_prop_analyze_set</span> <span class="o">=</span> <span class="n">this_prop_analyze_set</span><span class="p">[</span><span class="n">this_prop_analyze_set</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># we should now have an optimized set of thresholds to test</span>
                    <span class="n">this_prop_range</span> <span class="o">=</span> <span class="n">this_prop_analyze_set</span>

                    <span class="c1"># checking that there is actually a variation and a range to test (again, sorry)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">this_prop_range</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># no? let&#39;s skip this method</span>
                        <span class="n">this_prop_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">this_prop_min</span><span class="p">])</span>

                <span class="c1"># iterate and test the resulting data</span>
                <span class="n">pbar</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="s2">&quot;adjusting rejection threshold for [&quot;</span> <span class="o">+</span> <span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;] in range [</span><span class="si">%.3f</span><span class="s2">;</span><span class="si">%.3f</span><span class="s2">] (n=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_prop_range</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">this_prop_range</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">this_prop_range</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">this_prop_range</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># add inf to be sure that we try without any thresholds</span>
                <span class="n">this_prop_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">this_prop_range</span><span class="p">,</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>

                <span class="n">test_snr_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">this_prop_range</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">test_lw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">this_prop_range</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">test_nrej_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">this_prop_range</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                <span class="c1"># test each criteria bound</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i_prop_val</span><span class="p">,</span> <span class="n">this_prop_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">this_prop_range</span><span class="p">):</span>
                    <span class="c1"># rebuild min/max rejection bounds including user values</span>
                    <span class="n">peak_prop_min_auto</span> <span class="o">=</span> <span class="n">peak_prop_min</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">peak_prop_max_auto</span> <span class="o">=</span> <span class="n">peak_prop_max</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">peak_prop_max_auto</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_prop_val</span>

                    <span class="c1"># now see what we can reject</span>
                    <span class="n">this_mask_reject_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">peak_prop_analyze</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">peak_prop_min_auto</span><span class="p">[</span><span class="n">p</span><span class="p">]):</span>
                                <span class="n">this_mask_reject_data</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">peak_prop_analyze</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">peak_prop_max_auto</span><span class="p">[</span><span class="n">p</span><span class="p">]):</span>
                                <span class="n">this_mask_reject_data</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># reject data now</span>
                    <span class="n">this_mask_reject_data_sumup</span> <span class="o">=</span> <span class="p">(</span><span class="n">this_mask_reject_data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">this_s_cor</span> <span class="o">=</span> <span class="n">s</span><span class="p">[(</span><span class="n">this_mask_reject_data_sumup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">),</span> <span class="p">:]</span>

                    <span class="c1"># analyze snr / lw and number of rejections</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">this_mask_reject_data_sumup</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
                        <span class="n">this_s_cor_avg</span> <span class="o">=</span> <span class="n">this_s_cor</span><span class="o">.</span><span class="n">correct_average_2d</span><span class="p">()</span>
                        <span class="n">test_snr_list</span><span class="p">[</span><span class="n">i_prop_val</span><span class="p">],</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">this_s_cor_avg</span><span class="o">.</span><span class="n">analyze_snr_1d</span><span class="p">(</span><span class="n">peak_snr_range</span><span class="p">)</span>
                        <span class="n">test_lw_list</span><span class="p">[</span><span class="n">i_prop_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_s_cor_avg</span><span class="o">.</span><span class="n">analyze_linewidth_1d</span><span class="p">(</span><span class="n">peak_lw_range</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
                        <span class="n">test_nrej_list</span><span class="p">[</span><span class="n">i_prop_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_mask_reject_data_sumup</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                    <span class="c1"># progression</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i_prop_val</span><span class="p">)</span>

                <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

                <span class="c1"># relative SNR and minimum acceptable relative SNR change</span>
                <span class="n">test_snr_threshold</span> <span class="o">=</span> <span class="n">initial_snr</span> <span class="o">+</span> <span class="n">initial_snr</span> <span class="o">*</span> <span class="n">auto_adjust_allowed_snr_change</span> <span class="o">/</span> <span class="mf">100.0</span>
                <span class="n">test_snr_list_rel</span> <span class="o">=</span> <span class="n">test_snr_list</span> <span class="o">/</span> <span class="n">initial_snr</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="mf">100.0</span>

                <span class="c1"># relative LW change</span>
                <span class="n">test_lw_list_rel</span> <span class="o">=</span> <span class="n">test_lw_list</span> <span class="o">-</span> <span class="n">initial_lw</span>

                <span class="c1"># first, try and find a higher SNR than the initial one (best case, we reject crappy data and improved final SNR)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">test_snr_list_rel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">auto_adjust_allowed_snr_change</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SNR change above threshold: </span><span class="si">%.2f%%</span><span class="s2"> &gt; </span><span class="si">%.2f%%</span><span class="s2"> threshold! :)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_snr_list_rel</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">auto_adjust_allowed_snr_change</span><span class="p">))</span>
                    <span class="n">ind_max_snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">test_snr_list</span><span class="p">)</span>
                    <span class="n">optim_prop</span> <span class="o">=</span> <span class="n">this_prop_range</span><span class="p">[</span><span class="n">ind_max_snr</span><span class="p">]</span>
                    <span class="n">optim_res_snr</span> <span class="o">=</span> <span class="n">test_snr_list</span><span class="p">[</span><span class="n">ind_max_snr</span><span class="p">]</span>
                    <span class="n">optim_res_lw</span> <span class="o">=</span> <span class="n">test_lw_list</span><span class="p">[</span><span class="n">ind_max_snr</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;optimal [&quot;</span> <span class="o">+</span> <span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;] = </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">optim_prop</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no SNR above threshold found, so let&#39;s try to find at least a lower linewidth (intermediate case), for the same SNR or more</span>
                    <span class="c1"># check that we have a segment of the curve above the initial SNR</span>
                    <span class="n">test_snr_list_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_snr_list_rel</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">test_snr_list_mask</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                        <span class="c1"># that was a bit ambitious, there was absolutely no SNR enhancement</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sorry, this is only making your SNR worse...&quot;</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;the best SNR change we found was </span><span class="si">%.2f%%</span><span class="s2"> compared to initial :(&quot;</span> <span class="o">%</span> <span class="n">test_snr_list_rel</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                        <span class="c1"># set optimal LW to max (inf)</span>
                        <span class="n">optim_prop</span> <span class="o">=</span> <span class="n">this_prop_max</span>
                        <span class="n">optim_res_snr</span> <span class="o">=</span> <span class="n">test_snr_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">optim_res_lw</span> <span class="o">=</span> <span class="n">test_lw_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># we found relative SNR changes equal (no change) or above 0 (little SNR enchancement, still below expectation)</span>
                        <span class="c1"># let&#39;s choose the one with the lowest LW</span>
                        <span class="n">min_lw_snr_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">test_lw_list</span><span class="p">[</span><span class="n">test_snr_list_mask</span><span class="p">])</span>
                        <span class="n">ind_min_lw_snr_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">test_lw_list</span><span class="p">[</span><span class="n">test_snr_list_mask</span><span class="p">])</span>
                        <span class="c1"># if LW was actually reduced</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">min_lw_snr_masked</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;could not improve SNR above threshold but reduced peak linewidth! :)&quot;</span><span class="p">)</span>
                            <span class="n">optim_prop</span> <span class="o">=</span> <span class="n">this_prop_range</span><span class="p">[</span><span class="n">test_snr_list_mask</span><span class="p">][</span><span class="n">ind_min_lw_snr_masked</span><span class="p">]</span>
                            <span class="n">optim_res_snr</span> <span class="o">=</span> <span class="n">test_snr_list</span><span class="p">[</span><span class="n">test_snr_list_mask</span><span class="p">][</span><span class="n">ind_min_lw_snr_masked</span><span class="p">]</span>
                            <span class="n">optim_res_lw</span> <span class="o">=</span> <span class="n">test_lw_list</span><span class="p">[</span><span class="n">test_snr_list_mask</span><span class="p">][</span><span class="n">ind_min_lw_snr_masked</span><span class="p">]</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;optimal [&quot;</span> <span class="o">+</span> <span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;] = </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">optim_prop</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># that was a bit ambitious, there was absolutly no SNR enhancement and no LW enhancement too! :(</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sorry, this is only making your SNR and LW worse...&quot;</span><span class="p">)</span>
                            <span class="c1"># set optimal LW to max (inf)</span>
                            <span class="n">optim_prop</span> <span class="o">=</span> <span class="n">this_prop_max</span>
                            <span class="n">optim_res_snr</span> <span class="o">=</span> <span class="n">test_snr_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">optim_res_lw</span> <span class="o">=</span> <span class="n">test_lw_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># display and save the final snr and lw</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Post-data-rejection based on [&quot;</span> <span class="o">+</span> <span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;] SNR = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">optim_res_snr</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Post-data-rejection based on [&quot;</span> <span class="o">+</span> <span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;] linewidth = </span><span class="si">%.2f</span><span class="s2"> Hz&quot;</span> <span class="o">%</span> <span class="n">optim_res_lw</span><span class="p">)</span>
                <span class="n">auto_method_final_snr_list</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">optim_res_snr</span>
                <span class="n">auto_method_final_lw_list</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">optim_res_lw</span>

                <span class="c1"># plot SNR / LW combinaisons and optimal choice</span>
                <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
                    <span class="c1"># plot the SNRs versus LWs</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">159</span> <span class="o">+</span> <span class="p">(</span><span class="n">iround_data_rej</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">display_axes_ready</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="c1"># we just created the figure, let&#39;s create the axes</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_analyze_and_reject_2d (auto 1/2) (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;adjusting data rejection criteria for [</span><span class="si">%s</span><span class="s2">] (round #</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">iround_data_rej</span><span class="p">))</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                            <span class="n">a</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                        <span class="n">display_axes_ready</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_prop_range</span><span class="p">,</span> <span class="n">test_snr_list</span><span class="p">,</span> <span class="s1">&#39;rx-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SNR&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">optim_prop</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Optimal&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">test_snr_threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SNR threshold&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Estimated SNR (u.a)&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_prop_range</span><span class="p">,</span> <span class="n">test_lw_list</span><span class="p">,</span> <span class="s1">&#39;bx-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Linewidth&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Estimated linewidth (Hz)&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                    <span class="c1"># plot the data rejection percentage</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">159</span> <span class="o">+</span> <span class="p">(</span><span class="n">iround_data_rej</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">display_axes_ready</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># we just created the figure, let&#39;s create the axes</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_analyze_and_reject_2d (auto 2/2) (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;estimating data rejection rates for [</span><span class="si">%s</span><span class="s2">] (round #</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">iround_data_rej</span><span class="p">))</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                            <span class="n">a</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                        <span class="n">display_axes_ready</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_prop_range</span><span class="p">,</span> <span class="n">test_nrej_list</span><span class="p">,</span> <span class="s1">&#39;ko-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of scans rejected&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">properties_names</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of scans rejected&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">this_prop_range</span><span class="p">,</span> <span class="n">test_nrej_list</span> <span class="o">/</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;ko-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total percentage of scans rejected&#39;</span><span class="p">)</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rejection percentage (%)&#39;</span><span class="p">)</span>

                    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="c1"># save the found optimal criteria to rejection critera vector</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_auto_method</span> <span class="o">==</span> <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_LINEWIDTH</span><span class="p">):</span>
                    <span class="n">peak_prop_max_auto_res</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">optim_prop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">peak_prop_min_auto_res</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">optim_prop</span>
                    <span class="n">peak_prop_max_auto_res</span><span class="p">[</span><span class="n">this_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">optim_prop</span>

            <span class="c1"># tried all auto methods, now apply best one</span>
            <span class="c1"># the final snr and lw obtained are in auto_method_final_snr_list and auto_method_final_lw_list</span>
            <span class="c1"># the final bounds are in peak_prop_min_auto_res and peak_prop_max_auto_res</span>

            <span class="c1"># relative SNR change</span>
            <span class="n">auto_method_final_snr_list_rel</span> <span class="o">=</span> <span class="n">auto_method_final_snr_list</span> <span class="o">/</span> <span class="n">initial_snr</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="mf">100.0</span>
            <span class="n">auto_method_final_lw_list_rel</span> <span class="o">=</span> <span class="n">auto_method_final_lw_list</span> <span class="o">-</span> <span class="n">initial_lw</span>

            <span class="c1"># is this higher than the initial snr?</span>
            <span class="k">if</span><span class="p">(</span><span class="n">auto_method_final_snr_list_rel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">auto_adjust_allowed_snr_change</span><span class="p">):</span>
                <span class="c1"># apply this method</span>
                <span class="n">ind_max_snr_auto_method</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">auto_method_final_snr_list</span><span class="p">)</span>
                <span class="n">optim_auto_method</span> <span class="o">=</span> <span class="n">data_rejection_method</span><span class="p">(</span><span class="n">ind_max_snr_auto_method</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;best adjustment done with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">optim_auto_method</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; regarding SNR! (round #</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">iround_data_rej</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no methods could give a SNR above threshold</span>
                <span class="c1"># so let&#39;s try to find at least a method that does not reduce SNR and gives a lower linewidth (intermediate case)</span>
                <span class="n">auto_method_final_snr_list_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">auto_method_final_snr_list_rel</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">auto_method_final_snr_list_mask</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                    <span class="c1"># that was a bit ambitious</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sorry but only made your SNR worse...&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;the best SNR change we found was </span><span class="si">%.2f%%</span><span class="s2"> compared to initial :(&quot;</span> <span class="o">%</span> <span class="n">auto_method_final_snr_list_rel</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;automatic data rejection failed, no optimal method found, sorry! :(&quot;</span><span class="p">)</span>
                    <span class="c1"># no optimal method!</span>
                    <span class="n">optim_auto_method</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we found relative SNR changes equal (no change) or above 0 (little SNR enchancement, still below expectation)</span>
                    <span class="c1"># let&#39;s choose the method that gives the the lowest LW</span>
                    <span class="n">min_lw_auto_method</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">auto_method_final_lw_list_rel</span><span class="p">[</span><span class="n">auto_method_final_snr_list_mask</span><span class="p">])</span>
                    <span class="n">ind_min_lw_auto_method</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">auto_method_final_lw_list_rel</span><span class="p">[</span><span class="n">auto_method_final_snr_list_mask</span><span class="p">])</span>

                    <span class="c1"># if LW was actually reduced</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">min_lw_auto_method</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;could not find a method that improves SNR above threshold, only reduces the peak linewidth! :)&quot;</span><span class="p">)</span>
                        <span class="n">optim_auto_method</span> <span class="o">=</span> <span class="n">data_rejection_method</span><span class="p">(</span><span class="n">ind_min_lw_auto_method</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;best adjustment done with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">optim_auto_method</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; regarding linewidth! (round #</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">iround_data_rej</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># that was a bit ambitious, there was absolutly no SNR enhancement and no LW enhancement too! :(</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;automatic data rejection failed, no optimal method found, sorry! :(&quot;</span><span class="p">)</span>
                        <span class="c1"># no optimal method!</span>
                        <span class="n">optim_auto_method</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span><span class="p">(</span><span class="n">optim_auto_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Post-data-rejection SNR = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">auto_method_final_snr_list</span><span class="p">[</span><span class="n">optim_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Post-data-rejection linewidth = </span><span class="si">%.2f</span><span class="s2"> Hz&quot;</span> <span class="o">%</span> <span class="n">auto_method_final_lw_list</span><span class="p">[</span><span class="n">optim_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>

                <span class="c1"># apply automatically optimized bounds to rejection vectors</span>
                <span class="n">peak_prop_min</span><span class="p">[</span><span class="n">optim_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_min_auto_res</span><span class="p">[</span><span class="n">optim_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
                <span class="n">peak_prop_max</span><span class="p">[</span><span class="n">optim_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_max_auto_res</span><span class="p">[</span><span class="n">optim_auto_method</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">optim_auto_method</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># for each average, check if peak parameters are in the min / max bounds</span>
        <span class="n">mask_reject_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="s2">&quot;rejecting data&quot;</span><span class="p">,</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">peak_prop_analyze</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">peak_prop_min</span><span class="p">[</span><span class="n">p</span><span class="p">]):</span>
                    <span class="n">mask_reject_data</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span><span class="p">(</span><span class="n">peak_prop_analyze</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">peak_prop_max</span><span class="p">[</span><span class="n">p</span><span class="p">]):</span>
                    <span class="n">mask_reject_data</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

        <span class="c1"># stats regarding data rejection, how many, for what reasons, overall percentage</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;data rejection: summary (round #</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">iround_data_rej</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;number of averages rejected because of...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;amplitude = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mask_reject_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;linewidth = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mask_reject_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;frequency = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mask_reject_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;phase = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mask_reject_data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1"># actually reject data now</span>
        <span class="n">mask_reject_data_sumup</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_reject_data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">s_cor</span> <span class="o">=</span> <span class="n">s</span><span class="p">[(</span><span class="n">mask_reject_data_sumup</span> <span class="o">==</span> <span class="kc">False</span><span class="p">),</span> <span class="p">:]</span>
        <span class="c1"># build rejected spectrum</span>
        <span class="n">s_rej</span> <span class="o">=</span> <span class="n">s</span><span class="p">[(</span><span class="n">mask_reject_data_sumup</span> <span class="o">==</span> <span class="kc">True</span><span class="p">),</span> <span class="p">:]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        <span class="n">s_rej_avg</span> <span class="o">=</span> <span class="n">s_rej</span><span class="o">.</span><span class="n">correct_average_2d</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TOTAL data rejection = </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%.0f%%</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mask_reject_data_sumup</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">mask_reject_data_sumup</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)))</span>

        <span class="c1"># perform post-correction measurements</span>
        <span class="n">peak_prop_abs</span><span class="p">,</span> <span class="n">peak_prop_rel2mean</span><span class="p">,</span> <span class="n">peak_prop_rel2firstpt</span> <span class="o">=</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">_analyze_peak_2d</span><span class="p">(</span><span class="n">peak_analyze_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>

        <span class="c1"># first set the data according to relative option: this is a user option</span>
        <span class="k">if</span><span class="p">(</span><span class="n">peak_properties_rel2mean</span><span class="p">):</span>
            <span class="n">peak_prop_rel</span> <span class="o">=</span> <span class="n">peak_prop_rel2mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peak_prop_rel</span> <span class="o">=</span> <span class="n">peak_prop_rel2firstpt</span>

        <span class="c1"># choose if absolute or relative will be analyzed: this is hard-coded</span>
        <span class="n">peak_prop_analyze_postcor</span> <span class="o">=</span> <span class="n">peak_prop_abs</span> <span class="o">*</span> <span class="mf">0.0</span>
        <span class="c1"># amplitude: relative in %</span>
        <span class="n">peak_prop_analyze_postcor</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_rel</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># linewidth: absolute in Hz</span>
        <span class="n">peak_prop_analyze_postcor</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_abs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># frequency: relative in ppm</span>
        <span class="n">peak_prop_analyze_postcor</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_rel</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># phase: absolute in rad</span>
        <span class="n">peak_prop_analyze_postcor</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_rel</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

        <span class="c1"># final display</span>
        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">159</span> <span class="o">+</span> <span class="p">(</span><span class="n">iround_data_rej</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_analyze_and_reject_2d (summary) (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;analyzing data and rejecting some for [</span><span class="si">%s</span><span class="s2">] (round #</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">iround_data_rej</span><span class="p">))</span>

            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="c1"># original data</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_ma</span><span class="p">,</span> <span class="n">peak_prop_analyze</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="s1">&#39;k-x&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># rejected data</span>
                    <span class="n">t_ma_rej</span> <span class="o">=</span> <span class="n">t_ma</span><span class="p">[</span><span class="n">mask_reject_data</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]]</span>
                    <span class="n">this_peak_prop_analyze_rej</span> <span class="o">=</span> <span class="n">peak_prop_analyze</span><span class="p">[</span><span class="n">mask_reject_data</span><span class="p">[:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">]</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_ma_rej</span><span class="p">,</span> <span class="n">this_peak_prop_analyze_rej</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">peak_prop_min</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">peak_prop_max</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rel. amplitude change (%)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rel. amplitude = </span><span class="si">%.2f</span><span class="s2">  </span><span class="si">%.2f</span><span class="s2"> </span><span class="si">%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. linewidth (Hz)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Abs. linewidth = </span><span class="si">%.1f</span><span class="s2">  </span><span class="si">%.1f</span><span class="s2"> Hz (</span><span class="si">%.3f</span><span class="s2">  </span><span class="si">%.3f</span><span class="s2"> ppm)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Acq. time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. frequency (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Abs. frequency = </span><span class="si">%.2f</span><span class="s2">  </span><span class="si">%.2f</span><span class="s2"> ppm ( </span><span class="si">%.1f</span><span class="s2"> Hz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Acq. time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. phase shift (rd)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Abs. phase = </span><span class="si">%.2f</span><span class="s2">  </span><span class="si">%.2f</span><span class="s2"> rad&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">peak_prop_disp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>

            <span class="c1"># nice plot showing all raw data</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">ppm</span> <span class="o">=</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
            <span class="n">ystep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_ma</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">ystep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ystep</span><span class="p">))))</span>

            <span class="n">ampfactor</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">mask_reject_data_sumup</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_ma</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">ampfactor</span> <span class="o">+</span> <span class="n">ystep</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_ma</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">ampfactor</span> <span class="o">+</span> <span class="n">ystep</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># build lineshape segment</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">peak_seg_ppm</span><span class="p">,</span> <span class="n">peak_seg_val</span> <span class="o">=</span> <span class="n">s_ma</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_analyze_range</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_seg_ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_seg_val</span><span class="p">)</span> <span class="o">*</span> <span class="n">ampfactor</span> <span class="o">+</span> <span class="n">ystep</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">peak_analyze_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">peak_analyze_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;individual spectra&#39;</span><span class="p">)</span>

            <span class="c1"># y ticks: spectrum index</span>
            <span class="c1"># TODO: maybe need to calculate this automatically</span>
            <span class="n">n_yticks</span> <span class="o">=</span> <span class="mi">16</span>
            <span class="n">step_yticks</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_yticks</span><span class="p">))</span>
            <span class="n">yt_lbl_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step_yticks</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span><span class="p">(</span><span class="n">yt_lbl_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">yt_lbl_list</span> <span class="o">=</span> <span class="n">yt_lbl_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">yt_lbl_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">yt</span><span class="p">)</span> <span class="k">for</span> <span class="n">yt</span> <span class="ow">in</span> <span class="n">yt_lbl_list</span><span class="p">]</span>

            <span class="n">yt_loc_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ystep</span><span class="p">,</span> <span class="n">step_yticks</span> <span class="o">*</span> <span class="n">ystep</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span><span class="p">(</span><span class="n">yt_loc_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ystep</span><span class="p">)):</span>
                <span class="n">yt_loc_list</span> <span class="o">=</span> <span class="n">yt_loc_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ystep</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yt_loc_list</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">yt_lbl_list</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># wait, are we removing all data ???</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mask_reject_data_sumup</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;all data is rejected! You need to readjust your rejection bounds...&quot;</span><span class="p">)</span>

        <span class="c1"># estimate final SNR and linewidth</span>
        <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        <span class="n">s_cor_avg</span> <span class="o">=</span> <span class="n">s_cor</span><span class="o">.</span><span class="n">correct_average_2d</span><span class="p">()</span>
        <span class="n">final_snr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s_cor_avg</span><span class="o">.</span><span class="n">analyze_snr_1d</span><span class="p">(</span><span class="n">peak_snr_range</span><span class="p">)</span>
        <span class="n">final_lw</span> <span class="o">=</span> <span class="n">s_cor_avg</span><span class="o">.</span><span class="n">analyze_linewidth_1d</span><span class="p">(</span><span class="n">peak_lw_range</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Final post-data-rejection SNR = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">final_snr</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Final post-data-rejection linewidth = </span><span class="si">%.2f</span><span class="s2"> Hz&quot;</span> <span class="o">%</span> <span class="n">final_lw</span><span class="p">)</span>

        <span class="c1"># display corected and rejected spectra</span>
        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
            <span class="n">s_avg</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">correct_average_2d</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

            <span class="c1"># change legends</span>
            <span class="n">s_avg</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="s2">&quot;original spectrum&quot;</span><span class="p">)</span>
            <span class="n">s_cor_avg</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="s2">&quot;corrected spectrum&quot;</span><span class="p">)</span>
            <span class="n">s_rej_avg</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="s2">&quot;rejected spectrum&quot;</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">159</span> <span class="o">+</span> <span class="p">(</span><span class="n">iround_data_rej</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_analyze_and_reject_2d (rej. data) (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;original, corrected and rejected spectra for [</span><span class="si">%s</span><span class="s2">] (round #</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">iround_data_rej</span><span class="p">))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_rej_avg</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_rej_avg</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">s_rej_avg</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_avg</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_avg</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">s_avg</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_cor_avg</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_cor_avg</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">s_cor_avg</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># fill up dict about this data rejection</span>
        <span class="n">data_rej_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Pre-rejection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Pre-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_snr</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Pre-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;lw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_lw</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Pre-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;na&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Pre-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;measurements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_analyze</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Post-rejection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Post-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_snr</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Post-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;lw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_lw</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Post-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;na&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_cor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Post-rejection&quot;</span><span class="p">][</span><span class="s2">&quot;measurements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_prop_analyze_postcor</span>
        <span class="c1"># final rejection bounds</span>
        <span class="n">final_peak_properties_ranges</span> <span class="o">=</span> <span class="n">peak_properties_ranges</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">final_peak_properties_ranges</span><span class="p">[</span><span class="s2">&quot;amplitude (%)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_prop_max</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">final_peak_properties_ranges</span><span class="p">[</span><span class="s2">&quot;linewidth (Hz)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">peak_prop_min</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">peak_prop_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">final_peak_properties_ranges</span><span class="p">[</span><span class="s2">&quot;chemical shift (ppm)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_prop_max</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">final_peak_properties_ranges</span><span class="p">[</span><span class="s2">&quot;phase std. factor (%)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_prop_max</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">phase_std</span> <span class="o">*</span> <span class="mf">100.0</span>  <span class="c1"># special for phase</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Rejection bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_peak_properties_ranges</span>
        <span class="c1"># auto methods</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Automatic data rejection methods&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Automatic data rejection methods&quot;</span><span class="p">][</span><span class="s2">&quot;Methods tried&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_method_list</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Automatic data rejection methods&quot;</span><span class="p">][</span><span class="s2">&quot;Best method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optim_auto_method</span>
        <span class="n">data_rej_dict</span><span class="p">[</span><span class="s2">&quot;Automatic data rejection methods&quot;</span><span class="p">][</span><span class="s2">&quot;SNR change threshold (%)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_adjust_allowed_snr_change</span>

        <span class="c1"># check if empty or not (if first data rejection or not)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_cor</span><span class="o">.</span><span class="n">_data_rejection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_cor</span><span class="o">.</span><span class="n">_data_rejection</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_rej_dict</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s_cor</span><span class="o">.</span><span class="n">_data_rejection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_rej_dict</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_cor</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_realign_2d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_realign_2d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_realign_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">moving_averages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inter_corr_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">freq_shift_max</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Realign each signal of interest in frequency by taking as a reference the first spectra in absolute mode using pick-picking or inter-correlation (experimental).</span>

<span class="sd">        * Works only with a 2D [averages,timepoints] signal.</span>
<span class="sd">        * Returns a 2D [averages,timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peak_range : list [2]</span>
<span class="sd">            Range in ppm used to analyze peak phase</span>
<span class="sd">        moving_averages : int</span>
<span class="sd">            Number of averages to perform when using moving average, need to be an odd number</span>
<span class="sd">        inter_corr_mode : boolean</span>
<span class="sd">            Use inter-correlation technique to adjust frequency shifts. Could be more robust when SNR is low.</span>
<span class="sd">        freq_shift_max : float</span>
<span class="sd">            Max allowed frequency shift during realignment (Hz).</span>
<span class="sd">        allowed_apodization : float/boolean</span>
<span class="sd">            If &gt;0 or !=False, apodize signal during correction process. However, the final corrected signal will not be apodized.</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_realigned : MRSData2 numpy array [averages,timepoints]</span>
<span class="sd">            Resulting frequency realigned data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;frequency realigning [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
        <span class="n">s_realigned</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;single-shot signal, cannot realign this!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># build moving averaged data</span>
            <span class="n">s_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_moving_average_data_2d</span><span class="p">(</span><span class="n">moving_averages</span><span class="p">)</span>

            <span class="c1"># init</span>
            <span class="n">s_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">inter_corr_mode</span><span class="p">):</span>
                <span class="c1"># let&#39;s fix a +/-0.5ppm range</span>
                <span class="n">f_shifts_min</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span>
                <span class="n">f_shifts_max</span> <span class="o">=</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span>
                <span class="c1"># let&#39;s fix a the resolution here for inter-correlation tests</span>
                <span class="n">f_shifts_step</span> <span class="o">=</span> <span class="n">RECO_CORRECT_REALIGN_INTER_CORR_MODE_DF</span> <span class="o">*</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span>
                <span class="n">f_shifts_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">f_shifts_min</span><span class="p">,</span> <span class="n">f_shifts_max</span><span class="p">,</span> <span class="n">f_shifts_step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find peak in average spectrum absolute mode</span>
                <span class="n">ppm_peak_avg</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s_avg</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;measuring peak properties at </span><span class="si">%0.2f</span><span class="s2">ppm!&quot;</span> <span class="o">%</span> <span class="n">ppm_peak_avg</span><span class="p">)</span>

            <span class="c1"># for each average in moving averaged data</span>
            <span class="n">s_realigned_ma</span> <span class="o">=</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="s2">&quot;realigning&quot;</span><span class="p">,</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

                <span class="k">if</span><span class="p">(</span><span class="n">inter_corr_mode</span><span class="p">):</span>
                    <span class="c1"># compare this individual spectrum with the first,  using inter-correlation</span>


                    <span class="c1"># zero-fill and apodize moving average signal if needed</span>
                    <span class="c1"># btw, I only do this in the case of the intercorrelation mode because it is done internally for the peak-picking mode by the the method _analyze_peak_1d</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
                    <span class="n">s_ma_ic</span> <span class="o">=</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">correct_zerofill_nd</span><span class="p">()</span><span class="o">.</span><span class="n">correct_apodization_nd</span><span class="p">(</span><span class="n">allowed_apodization</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

                    <span class="c1"># first spectrum as reference</span>
                    <span class="n">s_ma_ic_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_ma_ic</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>
                    <span class="c1"># use the peak_range as a range for inter-corr tests</span>
                    <span class="n">cc_2d</span> <span class="o">=</span> <span class="n">f_shifts_list</span> <span class="o">*</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">ifs</span><span class="p">,</span> <span class="n">fs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f_shifts_list</span><span class="p">):</span>
                        <span class="n">s_ma_ic_shifted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_ma_ic</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">adjust_frequency</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span>
                        <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">s_ma_ic_ref</span><span class="p">,</span> <span class="n">s_ma_ic_shifted</span><span class="p">)</span>
                        <span class="n">cc_2d</span><span class="p">[</span><span class="n">ifs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># find max correlation</span>
                    <span class="n">optimal_fs_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cc_2d</span><span class="p">)</span>
                    <span class="n">optimal_fs</span> <span class="o">=</span> <span class="n">f_shifts_list</span><span class="p">[</span><span class="n">optimal_fs_ind</span><span class="p">]</span>
                    <span class="n">df_trace</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimal_fs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># measure shift on moving average data</span>
                    <span class="n">ppm_peak</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s_ma</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>

                    <span class="c1"># estimate frequency shift in Hz compared to average spectrum</span>
                    <span class="n">dppm</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ppm_peak_avg</span> <span class="o">-</span> <span class="n">ppm_peak</span><span class="p">)</span>
                    <span class="n">df_trace</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">dppm</span> <span class="o">*</span> <span class="n">s_ma</span><span class="o">.</span><span class="n">f0</span>

                <span class="c1"># check max shift</span>
                <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_trace</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">freq_shift_max</span><span class="p">):</span>
                    <span class="c1"># that is too much, do not realign this spectrum</span>
                    <span class="n">df_trace</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="c1"># correct moving averaged data (for display only, less heavy)</span>
                <span class="n">s_realigned_ma</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">s_ma</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">adjust_frequency</span><span class="p">(</span><span class="n">df_trace</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
                <span class="c1"># correct original data</span>
                <span class="n">s_realigned</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">adjust_frequency</span><span class="p">(</span><span class="n">df_trace</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>

                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

            <span class="c1"># final display</span>
            <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_realign_2d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;frequency realigning [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

                <span class="c1"># display original averaged spectrum</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_avg</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;averaged&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">inter_corr_mode</span><span class="p">):</span>
                    <span class="c1"># add peak position</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm_peak_avg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">peak_val</span><span class="p">),</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_peak_avg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

                <span class="c1"># display original data</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_ma</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

                <span class="c1"># display corrected spectra</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_realigned_ma</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_realigned_ma</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;corrected&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

                <span class="c1"># display corrected averaged spectrum</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_realigned_ma</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s_realigned_ma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;averaged &amp; corrected&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_trace</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s_ma</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;k-x&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;estimated frequency shift (Hz)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;average index&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_realigned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_realigned</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_realigned</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_average_2d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_average_2d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_average_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Average all averages data into one 1D MRS signal.</span>

<span class="sd">        * Works only with a 2D [averages,timepoints] signal.</span>
<span class="sd">        * Returns a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        na : int</span>
<span class="sd">            Number of signals to average</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_mean : MRSData2 numpy array [timepoints]</span>
<span class="sd">            Resulting frequency realigned data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;averaging [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 2D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;single-shot signal, nothing to average!&quot;</span><span class="p">)</span>
            <span class="n">s_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;reshaped to a &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; vector&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;averaging data...&quot;</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span><span class="n">na</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;only &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">na</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">na</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">s_mean</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
                <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
                <span class="n">ppm_mean</span> <span class="o">=</span> <span class="n">s_mean</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">190</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_average_2d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;averaging [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;all spectra&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm_mean</span><span class="p">,</span> <span class="n">s_mean</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;averaged spectrum&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

                <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_mean</span><span class="p">)</span>

        <span class="c1"># if any ref data available, we average it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_mean</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_mean</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_mean</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_average_2d</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_mean</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_phase_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_phase_1d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_phase_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suspect_method</span><span class="o">=</span><span class="n">suspect_phasing_method</span><span class="o">.</span><span class="n">MATCH_MAGNITUDE_REAL</span><span class="p">,</span> <span class="n">ppm_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Phase signal using suspect&#39;s (hidden) phasing functions. You can choose between 3 different types of phasing methods. See suspect/processing/phase.py file.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>
<span class="sd">        * Returns a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        suspect_method : suspect_phasing_method</span>
<span class="sd">            Suspect phasing method to use here</span>
<span class="sd">        ppm_range : list [2]</span>
<span class="sd">            Range in ppm when analyzing spectra for phasing</span>
<span class="sd">        allowed_apodization : float/boolean</span>
<span class="sd">            If &gt;0 or !=False, apodize signal during phase analysis process. However, the final corrected signal will not be apodized.</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_phased : MRSData2 numpy array [timepoints]</span>
<span class="sd">            Resulting phased data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;phasing using suspect functions [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s_analyze</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_apodization_nd</span><span class="p">(</span><span class="n">allowed_apodization</span><span class="p">)</span>

        <span class="c1"># estimate phases</span>
        <span class="k">if</span><span class="p">(</span><span class="n">suspect_method</span> <span class="o">==</span> <span class="n">suspect_phasing_method</span><span class="o">.</span><span class="n">MATCH_MAGNITUDE_REAL</span><span class="p">):</span>
            <span class="n">phi0</span><span class="p">,</span> <span class="n">phi1</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">mag_real</span><span class="p">(</span><span class="n">s_analyze</span><span class="p">,</span> <span class="n">range_ppm</span><span class="o">=</span><span class="n">ppm_range</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">suspect_method</span> <span class="o">==</span> <span class="n">suspect_phasing_method</span><span class="o">.</span><span class="n">MIN_IMAG_INTEGRAL</span><span class="p">):</span>
            <span class="n">phi0</span><span class="p">,</span> <span class="n">phi1</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">ernst</span><span class="p">(</span><span class="n">s_analyze</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">suspect_method</span> <span class="o">==</span> <span class="n">suspect_phasing_method</span><span class="o">.</span><span class="n">ACME</span><span class="p">):</span>
            <span class="n">phi0</span><span class="p">,</span> <span class="n">phi1</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">acme</span><span class="p">(</span><span class="n">s_analyze</span><span class="p">,</span> <span class="n">range_ppm</span><span class="o">=</span><span class="n">ppm_range</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;hey, I do not know this suspect phasing method!?&quot;</span><span class="p">)</span>

        <span class="c1"># apply phase corrections</span>
        <span class="n">s_phased</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">adjust_phase</span><span class="p">(</span><span class="n">phi0</span><span class="p">,</span> <span class="n">phi1</span><span class="p">)</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_phased</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_phased</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_phase_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;phasing (suspect) [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="c1"># add low/high cuts</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_phased</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s_phased</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;phased&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="c1"># add low/high cuts</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># if any ref data available, we phase it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_phased</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_phased</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_phased</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_phase_1d</span><span class="p">(</span><span class="n">suspect_method</span><span class="p">,</span> <span class="n">ppm_range</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_phased</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_apodization_nd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_apodization_nd">[docs]</a>    <span class="k">def</span> <span class="nf">correct_apodization_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apo_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apodize signal using an exponential window adjusted by a linewidth parameter in Hz.</span>

<span class="sd">        * Works with multi-dimensional signals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        apo_factor : float</span>
<span class="sd">            Apodization factor in Hz</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_apo : MRSData2 numpy array [whatever,...,timepoints]</span>
<span class="sd">            Resulting apodized data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;apodizing [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="c1"># apodize each individual signal</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># check apodization factor</span>
        <span class="k">if</span><span class="p">(</span><span class="n">apo_factor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;apodization factor is zero or negative, skipping!&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span>
        <span class="n">w_apo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">apo_factor</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">w_apo_nd</span> <span class="o">=</span> <span class="n">w_apo</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &gt;1</span>
            <span class="n">w_apo_nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">w_apo</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">s_apo</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">w_apo_nd</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="c1"># reshaping</span>
            <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">s_disp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">s_apo_disp</span> <span class="o">=</span> <span class="n">s_apo</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">s_apo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">s_apo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_apo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s_disp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">s_apo_disp</span> <span class="o">=</span> <span class="n">s_apo</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">ppm</span> <span class="o">=</span> <span class="n">s_disp</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
            <span class="n">ppm_apo</span> <span class="o">=</span> <span class="n">s_apo_disp</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">210</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_apodization (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;apodizing [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_disp</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fid&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">w_apo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_disp</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;apodization window&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_apo_disp</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;apodized&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_disp</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original spectrum&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm_apo</span><span class="p">,</span> <span class="n">s_apo_disp</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;chemical shift (ppm)&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;apodized spectrum&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_apo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_apo</span><span class="p">)</span>

        <span class="c1"># if any ref data available, we apodize it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_apo</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_apo</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_apo</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_apodization_nd</span><span class="p">(</span><span class="n">apo_factor</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_apo</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_crop_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_crop_1d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_crop_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nPoints_final</span><span class="o">=</span><span class="mi">6144</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crop signal in time-domain to remove last points.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>
<span class="sd">        * Returns a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nPoints_final : int</span>
<span class="sd">            Final number of points (after crop)</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_crop : MRSData2 numpy array [timepoints]</span>
<span class="sd">            Resulting cropped data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cropping [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># crop</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nPoints_final</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cropping data from </span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2"> points...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nPoints_final</span><span class="p">))</span>
            <span class="n">s_crop</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nPoints_final</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;no cropping needed, getting bored...&quot;</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span>
            <span class="n">t_crop</span> <span class="o">=</span> <span class="n">s_crop</span><span class="o">.</span><span class="n">time_axis</span><span class="p">()</span>
            <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
            <span class="n">ppm_crop</span> <span class="o">=</span> <span class="n">s_crop</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">220</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_crop_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;cropping [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fid&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_crop</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_crop</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;cropped&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original spectrum&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm_crop</span><span class="p">,</span> <span class="n">s_crop</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;chemical shift (ppm)&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;cropped spectrum&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_crop</span><span class="p">)</span>

        <span class="c1"># now we have a MRSData2 obj, modify sequence attribute</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_crop</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;updating sequence.npts...&quot;</span><span class="p">)</span>
            <span class="n">s_crop</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="n">nPoints_final</span>
            <span class="n">s_crop</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">_ready</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># if any ref data available, we crop it too (silently)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">s_crop</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">s_crop</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_crop</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">correct_crop_1d</span><span class="p">(</span><span class="n">nPoints_final</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_crop</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_peak_removal_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_peak_removal_1d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_peak_removal_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hsvd_nComponents</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">hsvd_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.6</span><span class="p">,</span> <span class="mf">4.8</span><span class="p">],</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove any peak(s) within a ppm range using HSVD. Usually used to remove residual water peak.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>
<span class="sd">        * Returns a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hsvd_nComponents : int</span>
<span class="sd">            Number of components for HSVD</span>
<span class="sd">        hsvd_range : list [2]</span>
<span class="sd">            Range in ppm of HSVD components</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_peak_removed : MRSData2 numpy array [timepoints]</span>
<span class="sd">            Resulting water HSVD suppressed data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;removing peak for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progressbar</span><span class="p">(</span><span class="s2">&quot;removing peak(s) with HSVD&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># estimate HSVD components</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">water_suppression</span><span class="o">.</span><span class="n">hsvd</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">hsvd_nComponents</span><span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># filter them by keeping the ones contributing to the residual water peak and its sidebands</span>
        <span class="n">water_components</span> <span class="o">=</span> <span class="p">[</span><span class="n">component</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span> <span class="k">if</span> <span class="p">((</span><span class="mf">4.7</span> <span class="o">-</span> <span class="n">component</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">hsvd_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">4.7</span> <span class="o">-</span> <span class="n">component</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">f0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">hsvd_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># reconstruct the estimated water peak</span>
        <span class="n">hsvd_fid</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">water_suppression</span><span class="o">.</span><span class="n">construct_fid</span><span class="p">(</span><span class="n">water_components</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">())</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># rebuild object</span>
        <span class="n">hsvd_fid</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">hsvd_fid</span><span class="p">)</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># and substract it from the fid</span>
        <span class="n">s_peak_removed</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">hsvd_fid</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># display this over the data</span>
        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">230</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_peak_removal_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;removing peak for [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="c1"># original spectrum</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;original data (real part)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">hsvd_fid</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;estimated HSVD peak&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original spectrum&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="c1"># water removed spectrum</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_peak_removed</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;peak removed spectrum&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_peak_removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_peak_removed</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_peak_removed</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_freqshift_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_freqshift_1d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_freqshift_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_range</span><span class="o">=</span><span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">peak_real_ppm</span><span class="o">=</span><span class="mf">4.7</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shift the spectrum in frequency in order to get the right peaks at the right chemical shifts.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>
<span class="sd">        * Returns a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peak_range : list [2]</span>
<span class="sd">            Range in ppm used to find a peak of interest</span>
<span class="sd">        peak_real_ppm : float</span>
<span class="sd">            Chemical shift to set to the peak found</span>
<span class="sd">        allowed_apodization : float/boolean</span>
<span class="sd">            If &gt;0 or !=False, apodize signal during peak analysis process. However, the final corrected signal will not be apodized.</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_shifted : MRSData2 numpy array [timepoints]</span>
<span class="sd">            Resulting frequency calibrated data stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;calibrating [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

        <span class="c1"># find maximum peak in range and its chemical shift</span>
        <span class="n">ppm_peak</span><span class="p">,</span> <span class="n">peak_val</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_analyze_peak_1d</span><span class="p">(</span><span class="n">peak_range</span><span class="p">,</span> <span class="n">allowed_apodization</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;peak detected at </span><span class="si">%0.2f</span><span class="s2">ppm -&gt; </span><span class="si">%0.2f</span><span class="s2">ppm!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ppm_peak</span><span class="p">,</span> <span class="n">peak_real_ppm</span><span class="p">))</span>

        <span class="c1"># estimate frequency shift in Hz</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;frequency shifting data...&quot;</span><span class="p">)</span>
        <span class="n">dppm</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak_real_ppm</span> <span class="o">-</span> <span class="n">ppm_peak</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dppm</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">f0</span>
        <span class="n">s_shifted</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">adjust_frequency</span><span class="p">(</span><span class="o">-</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">240</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_freqshift_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;calibrating [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="c1"># add peak position</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm_peak</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_val</span><span class="p">),</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ppm_peak</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_shifted</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;shifted&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="c1"># add new peak position</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_real_ppm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">peak_val</span><span class="p">),</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">peak_real_ppm</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_shifted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_shifted</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_shifted</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.correct_bandpass_filtering_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.correct_bandpass_filtering_1d">[docs]</a>    <span class="k">def</span> <span class="nf">correct_bandpass_filtering_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_ppm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">window_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter the signal using FFT windowing.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>
<span class="sd">        * Returns a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        range_ppm : list [2]</span>
<span class="sd">            Range in ppm used for band-pass filtering</span>
<span class="sd">        window_func : numpy windowing function</span>
<span class="sd">            Apodization window function</span>
<span class="sd">        display : boolean</span>
<span class="sd">            Display correction process (True) or not (False)</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_filtered : MRSData2 numpy array [timepoints]</span>
<span class="sd">            Resulting frequency filtered signal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;band-pass filtering [</span><span class="si">%s</span><span class="s2">]: keeping the </span><span class="si">%.2f</span><span class="s2">-</span><span class="si">%.2f</span><span class="s2">ppm region...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">range_ppm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">range_ppm</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ppm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">()</span>

        <span class="c1"># build apodization window</span>
        <span class="n">ind_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ppm</span> <span class="o">-</span> <span class="n">range_ppm</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ind_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ppm</span> <span class="o">-</span> <span class="n">range_ppm</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">n_window</span> <span class="o">=</span> <span class="n">ind_low</span> <span class="o">-</span> <span class="n">ind_high</span>
        <span class="n">window_segment</span> <span class="o">=</span> <span class="n">window_func</span><span class="p">(</span><span class="n">n_window</span><span class="p">)</span>
        <span class="n">window_full</span> <span class="o">=</span> <span class="n">ppm</span> <span class="o">*</span> <span class="mf">0.0</span>
        <span class="n">window_full</span><span class="p">[</span><span class="n">ind_high</span><span class="p">:</span><span class="n">ind_low</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_segment</span>

        <span class="c1"># apply window</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span>
        <span class="n">sf_filtered</span> <span class="o">=</span> <span class="n">sf</span> <span class="o">*</span> <span class="n">window_full</span>
        <span class="n">s_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">sf_filtered</span><span class="p">))</span>

        <span class="c1"># convert back to MRSData2</span>
        <span class="n">s_filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_filtered</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">display</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;correct_bandpass_filtering_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;filtering [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">window_full</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="c1"># add low/high cuts</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">range_ppm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">range_ppm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">time_axis</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">s_filtered</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (s)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;filtered&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ppm</span><span class="p">,</span> <span class="n">s_filtered</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;filtered&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="c1"># add low/high cuts</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">range_ppm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">range_ppm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s_filtered</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRSData2.display_voi_anatomy_nd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.display_voi_anatomy_nd">[docs]</a>    <span class="k">def</span> <span class="nf">display_voi_anatomy_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the VOI on a anatomical image of your choice. Experimental for now, just following tutorial here: https://suspect.readthedocs.io/en/latest/notebooks/tut06_mpl.html</span>

<span class="sd">        * Works with multi-dimensional signals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;displaying VOI [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="c1"># read dicom images</span>
        <span class="n">t2w</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">load_dicom_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anatomy_folderpath</span> <span class="o">+</span> <span class="s2">&quot;/original-primary-m-norm-nd_e01_0001.dcm&quot;</span><span class="p">)</span>

        <span class="c1"># find best slice</span>
        <span class="n">pcg_centre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_scanner</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">pcg_centre_index</span> <span class="o">=</span> <span class="n">t2w</span><span class="o">.</span><span class="n">from_scanner</span><span class="p">(</span><span class="o">*</span><span class="n">pcg_centre</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># VOI drawing coordinates</span>
        <span class="c1"># TODO: this works only for sagittal images (spinal cord)</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">voxel_size</span>  <span class="c1"># mm (will need cm)</span>
        <span class="n">corner_coords_pcg</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span>    <span class="o">-</span><span class="n">vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>   <span class="o">-</span><span class="n">vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">],</span>
                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span>    <span class="o">-</span><span class="n">vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>   <span class="n">vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">],</span>
                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span>    <span class="n">vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>    <span class="n">vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">],</span>
                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span>    <span class="n">vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>    <span class="o">-</span><span class="n">vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">],</span>
                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span>    <span class="o">-</span><span class="n">vx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">,</span>   <span class="o">-</span><span class="n">vx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">20.0</span><span class="p">]]</span>
        <span class="n">corner_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t2w</span><span class="o">.</span><span class="n">from_scanner</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">to_scanner</span><span class="p">(</span><span class="o">*</span><span class="n">coord</span><span class="p">))</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">corner_coords_pcg</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">260</span><span class="p">)</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;display_voi_anatomy_nd (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">t2w</span><span class="p">[</span><span class="n">pcg_centre_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">corner_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">corner_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="MRSData2.display_spectrum_1d"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.display_spectrum_1d">[docs]</a>    <span class="k">def</span> <span class="nf">display_spectrum_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifig</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">display_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">allowed_apodization</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">magnitude_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display spectrum in figure &#39;ifig&#39;, overlaying if needed.</span>

<span class="sd">        * Works only with a 1D [timepoints] signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ifig: int</span>
<span class="sd">            The figure index that shoud host the plot</span>
<span class="sd">        s : MRSData2 numpy array [timepoints]</span>
<span class="sd">            MRS data to display</span>
<span class="sd">        display_range : list [2]</span>
<span class="sd">            Range in ppm used for display</span>
<span class="sd">        allowed_apodization : float</span>
<span class="sd">            Apodization factor used for display (Hz)</span>
<span class="sd">        magnitude_mode : boolean</span>
<span class="sd">            Displays in magnitude mode (True) or the real part (False)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : matplotlib.figure</span>
<span class="sd">            Resulting matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;displaying [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 1D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># init</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_apodization_nd</span><span class="p">(</span><span class="n">allowed_apodization</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;displaying stuff!&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">ifig</span><span class="p">)</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;display_spectrum_1d (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">magnitude_mode</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_offset</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">frequency_axis_ppm</span><span class="p">(),</span> <span class="n">s</span><span class="o">.</span><span class="n">spectrum</span><span class="p">()</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_offset</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="c1"># add ytick if offset</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">yt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">()</span>
            <span class="n">yt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">yt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_offset</span><span class="p">))</span>
            <span class="n">yt3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">yt2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yt3</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">display_range</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">display_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">display_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;chemical shift (ppm)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;spectrum&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">ifig</span><span class="p">))</span></div>

<div class="viewcode-block" id="MRSData2.save_ismrmd"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.save_ismrmd">[docs]</a>    <span class="k">def</span> <span class="nf">save_ismrmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the MRSData2 object to a ISMRMRD format file. This function depends on ismrmrd-python, available at https://github.com/ismrmrd/ismrmrd-python. General info about this open file format is available here: https://ismrmrd.github.io/. Got inspired by this example: https://github.com/ismrmrd/ismrmrd-python-tools/blob/master/generate_cartesian_shepp_logan_dataset.py .</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        h5_filepath: string</span>
<span class="sd">            Full absolute file path pointing to h5 file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;saving MRS signal to &quot;</span> <span class="o">+</span> <span class="n">h5_filepath</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="c1"># dimensions check</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;this method only works for 3D signals! You are feeding it with </span><span class="si">%d</span><span class="s2">-dimensional data. :s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>

        <span class="c1"># try importing here in order not to break everything because you do not have this dependency</span>
        <span class="kn">import</span> <span class="nn">ismrmrd</span>

        <span class="c1"># TODO: need to add more info to the header: voxel size/position, etc.</span>

        <span class="c1"># open  dataset</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">h5_filepath</span><span class="p">,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">create_if_needed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create the XML header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">ismrmrdHeader</span><span class="p">()</span>

        <span class="c1"># subject stuff</span>
        <span class="n">subj</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">subjectInformationType</span><span class="p">()</span>
        <span class="n">subj</span><span class="o">.</span><span class="n">patientName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">subj</span><span class="o">.</span><span class="n">patientID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="c1"># bug here...</span>
        <span class="c1"># subj.patientBirthdate = self.patient[&quot;birthday&quot;].strftime(&#39;%Y-%m-%d&#39;)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">subj</span><span class="o">.</span><span class="n">patientGender</span> <span class="o">=</span> <span class="s2">&quot;M&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">subj</span><span class="o">.</span><span class="n">patientGender</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">subj</span><span class="o">.</span><span class="n">patientGender</span> <span class="o">=</span> <span class="s2">&quot;O&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;patient gender unknown!&quot;</span><span class="p">)</span>
        <span class="n">subj</span><span class="o">.</span><span class="n">patientWeight_kg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="c1"># no patient height in the ismrmrd format!?</span>
        <span class="c1"># add to header</span>
        <span class="n">header</span><span class="o">.</span><span class="n">subjectInformation</span> <span class="o">=</span> <span class="n">subj</span>

        <span class="c1"># sequence stuff</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">sequenceParametersType</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">tr</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">TE</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">te</span><span class="p">]</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">sequence_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># add to header</span>
        <span class="n">header</span><span class="o">.</span><span class="n">sequenceParameters</span> <span class="o">=</span> <span class="n">seq</span>

        <span class="c1"># experimental conditions</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">experimentalConditionsType</span><span class="p">()</span>
        <span class="n">exp</span><span class="o">.</span><span class="n">H1resonanceFrequency_Hz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f0</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="n">header</span><span class="o">.</span><span class="n">experimentalConditions</span> <span class="o">=</span> <span class="n">exp</span>

        <span class="c1"># dummy encoding</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">encoding</span><span class="p">()</span>
        <span class="n">encoding</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">trajectoryType</span><span class="o">.</span><span class="n">cartesian</span>
        <span class="n">efov</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">fieldOfView_mm</span><span class="p">()</span>
        <span class="n">efov</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">efov</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">efov</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rfov</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">fieldOfView_mm</span><span class="p">()</span>
        <span class="n">rfov</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rfov</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rfov</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ematrix</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">matrixSize</span><span class="p">()</span>
        <span class="n">ematrix</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ematrix</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ematrix</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rmatrix</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">matrixSize</span><span class="p">()</span>
        <span class="n">rmatrix</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rmatrix</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rmatrix</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">espace</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">encodingSpaceType</span><span class="p">()</span>
        <span class="n">espace</span><span class="o">.</span><span class="n">matrixSize</span> <span class="o">=</span> <span class="n">ematrix</span>
        <span class="n">espace</span><span class="o">.</span><span class="n">fieldOfView_mm</span> <span class="o">=</span> <span class="n">efov</span>
        <span class="n">rspace</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">encodingSpaceType</span><span class="p">()</span>
        <span class="n">rspace</span><span class="o">.</span><span class="n">matrixSize</span> <span class="o">=</span> <span class="n">rmatrix</span>
        <span class="n">rspace</span><span class="o">.</span><span class="n">fieldOfView_mm</span> <span class="o">=</span> <span class="n">rfov</span>
        <span class="n">encoding</span><span class="o">.</span><span class="n">encodedSpace</span> <span class="o">=</span> <span class="n">espace</span>
        <span class="n">encoding</span><span class="o">.</span><span class="n">reconSpace</span> <span class="o">=</span> <span class="n">rspace</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">xsd</span><span class="o">.</span><span class="n">encodingLimitsType</span><span class="p">()</span>
        <span class="n">encoding</span><span class="o">.</span><span class="n">encodingLimits</span> <span class="o">=</span> <span class="n">limits</span>
        <span class="n">header</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

        <span class="c1"># write header</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">write_xml_header</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">toxml</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="c1"># data</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="n">ismrmrd</span><span class="o">.</span><span class="n">Acquisition</span><span class="p">()</span>
        <span class="n">acq</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">acq</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:]</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">append_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>

        <span class="c1"># done</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="MRSData2.save_mat"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.save_mat">[docs]</a>    <span class="k">def</span> <span class="nf">save_mat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat_filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the numpy array content to a MATLAB mat file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mat_filepath: string</span>
<span class="sd">            Full absolute file path pointing to mat file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: need to add some header info</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;saving MRS signal to &quot;</span> <span class="o">+</span> <span class="n">mat_filepath</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">mat_filepath</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MRSdata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span></div>

<div class="viewcode-block" id="MRSData2.save_pkl"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.save_pkl">[docs]</a>    <span class="k">def</span> <span class="nf">save_pkl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkl_filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the whole object to a pickle file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pkl_filepath: string</span>
<span class="sd">            Full absolute file path pointing to pkl file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;saving MRS signal to &quot;</span> <span class="o">+</span> <span class="n">pkl_filepath</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduce internal pickling method used when dumping. Modified so that MRSData2 attributes are not forgotten. See for more info: https://docs.python.org/3/library/pickle.html .&quot;&quot;&quot;</span>
        <span class="c1"># get numpy reduce tuple</span>
        <span class="n">rd</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">()</span>
        <span class="c1"># add MRSData2 attributes</span>
        <span class="n">rd2</span> <span class="o">=</span> <span class="n">rd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,)</span>
        <span class="c1"># return the new reduce tuple version</span>
        <span class="k">return</span><span class="p">(</span><span class="n">rd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rd2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set new state to object. Internal pickling method used when loading. Modified so that MRSData2 attributes are not forgotten. See for more info: https://docs.python.org/3/library/pickle.html .&quot;&quot;&quot;</span>
        <span class="c1"># load MRSData2 attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># load all the rest relative to numpy</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="MRSData2.to_dataframe"><a class="viewcode-back" href="../../mrs.html#mrs.reco.MRSData2.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_obj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix_str</span><span class="o">=</span><span class="s2">&quot;data_&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the object&#39;s attributes to dataframe. Can include the object itself.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_obj : boolean</span>
<span class="sd">            Include self to the dataframe row</span>
<span class="sd">        prefix_str : string</span>
<span class="sd">            Prefix string to add to column names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : Dataframe</span>
<span class="sd">            Containing the attributes as columns (a single row)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;converting to dataframe...&quot;</span><span class="p">)</span>

        <span class="c1"># get all attributes but remove the private ones</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;^(?!_).*&quot;</span><span class="p">))</span>

        <span class="c1"># add some specific private attributes I need</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;display_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_label</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;noise_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_level</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rejection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rejection</span><span class="p">]</span>  <span class="c1"># can be a list</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;file_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_file_hash</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_rawdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rawdata</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">patient</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="kc">True</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">include_obj</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;obj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="n">prefix_str</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="pipeline"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline">[docs]</a><span class="k">class</span> <span class="nc">pipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The pipeline class is used to store all the reconstruction parameters needed for a specific bunch of acquired signals. Once the parameters are set, the pipeline can be run using one of the methods.&quot;&quot;&quot;</span>

    <span class="c1"># frozen stuff: a technique to prevent creating new attributes</span>
    <span class="c1"># (https://stackoverflow.com/questions/3603502/prevent-creating-new-attributes-outside-init)</span>
    <span class="n">__isfrozen</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overload of __setattr__ method to check that we are not creating a new attribute.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isfrozen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error_new_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the reconstruction pipeline, using a template if needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        template_name: string</span>
<span class="sd">            Reco pipeline template file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- initializing dataset dict ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="n">MAX_NUM_DATASETS</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_NUM_DATASETS</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;analysis_results&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                               <span class="s2">&quot;dcm&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;analysis_results&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                               <span class="s2">&quot;physio_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s2">&quot;imaging_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s2">&quot;resp_bpm&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s2">&quot;heart_bpm&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="c1"># --- global settings ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># option to process only a set of datasets: list of indexes</span>
                            <span class="s2">&quot;datasets_indexes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="c1"># ppm scale reference</span>
                            <span class="s2">&quot;ppm0&quot;</span><span class="p">:</span> <span class="mf">4.7</span><span class="p">,</span>
                            <span class="c1"># ppm range to search for peak used for phasing, etc.</span>
                            <span class="s2">&quot;POI_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">],</span>
                            <span class="c1"># ppm range to search for ppm scale calibration</span>
                            <span class="s2">&quot;POI_shift_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">],</span>
                            <span class="c1"># real ppm value the above peak</span>
                            <span class="s2">&quot;POI_shift_true_ppm&quot;</span><span class="p">:</span> <span class="mf">4.7</span><span class="p">,</span>
                            <span class="c1"># ppm range to search for peak for SNR estimation</span>
                            <span class="s2">&quot;POI_SNR_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">],</span>
                            <span class="c1"># ppm range to search for peak for FWHM estimation</span>
                            <span class="s2">&quot;POI_LW_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">],</span>
                            <span class="c1"># ppm range to for SNR/LW estimation in ref. data</span>
                            <span class="s2">&quot;POI_ref_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">],</span>
                            <span class="c1"># apodization factor used during signal analysis, never actually applied for signal correction</span>
                            <span class="s2">&quot;allowed_apodization&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                            <span class="c1"># path to pkl file to store processed data</span>
                            <span class="s2">&quot;storage_file&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="c1"># force display off if needed</span>
                            <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="c1"># ppm range used for display</span>
                            <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                            <span class="c1"># y offset used for display</span>
                            <span class="s2">&quot;display_offset&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="c1"># raise error if raw data looks worse than dcm</span>
                            <span class="s2">&quot;raise_error_on_badreco&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="c1"># --- available jobs and their parameters ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># --- job: spectrum final display ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">display_spectrum_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;displaying&quot;</span><span class="p">,</span>
                                  <span class="c1"># figure index</span>
                                  <span class="s2">&quot;fig_index&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="c1"># ppm range used for display</span>
                                  <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                  <span class="c1"># apodization factor used for display (Hz)</span>
                                  <span class="s2">&quot;allowed_apodization&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                  <span class="c1"># display spectrum in magnitude mode?</span>
                                  <span class="s2">&quot;magnitude_mode&quot;</span><span class="p">:</span> <span class="kc">False</span>
                                  <span class="p">}</span>

        <span class="c1"># --- job: VOI display on anatomical images ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying_anatomy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">display_voi_anatomy_nd</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;overlaying VOI on anatomical image&quot;</span>
                                  <span class="p">}</span>

        <span class="c1"># --- job: automatic rephasing ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;phasing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_phase_3d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;phasing&quot;</span><span class="p">,</span>
                               <span class="c1"># use reference data is available?</span>
                               <span class="s2">&quot;using_ref_data&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="c1"># ppm range to look fo peak used to estimate phase</span>
                               <span class="s2">&quot;POI_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                               <span class="c1"># average all averages per channel</span>
                               <span class="s2">&quot;average_per_channel_mode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="c1"># measure phase from 1st time point</span>
                               <span class="s2">&quot;first_point_fid_mode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="c1"># order of phasing in time: 0th or 1st order</span>
                               <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="c1"># add an additional 0th order phase (rd)</span>
                               <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                               <span class="c1"># display all this process to check what the hell is going on</span>
                               <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                               <span class="p">}</span>

        <span class="c1"># --- job: amplification ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_intensity_scaling_nd</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;scaling intensity&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;scaling_factor_rawdata&quot;</span><span class="p">:</span> <span class="mf">1e8</span><span class="p">,</span>
                               <span class="s2">&quot;scaling_factor_dcm&quot;</span><span class="p">:</span> <span class="mf">1.0</span>
                               <span class="p">}</span>

        <span class="c1"># --- job: FID modulus ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;FID modulus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_fidmodulus_nd</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;FID modulus&quot;</span>
                                   <span class="p">}</span>

        <span class="c1"># --- job: time_shifting ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;time_shifting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_time_shift_nd</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;time_shifting&quot;</span><span class="p">,</span>
                                     <span class="c1"># time shift in us</span>
                                     <span class="s2">&quot;time_shift_us&quot;</span><span class="p">:</span> <span class="mi">375</span><span class="p">,</span>
                                     <span class="c1"># display all this process to check what the hell is going on</span>
                                     <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                     <span class="p">}</span>

        <span class="c1"># --- job: channel combination ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;channel_combining&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_combine_channels_3d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;channel-combining&quot;</span><span class="p">,</span>
                                         <span class="c1"># use non water-suppressed data to recombine and rephase channels</span>
                                         <span class="s2">&quot;using_ref_data&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                         <span class="c1"># should we rephase (0th order) data while combining?</span>
                                         <span class="s2">&quot;phasing&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                         <span class="c1"># boolean mask to switch on/off some Rx channels</span>
                                         <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
                                         <span class="p">}</span>

        <span class="c1"># --- job: concatenate ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;concatenate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">concatenate_2d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;concatenate&quot;</span>
                                   <span class="p">}</span>

        <span class="c1"># --- job: zero_filling ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;zero_filling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_zerofill_nd</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;zero-filling&quot;</span><span class="p">,</span>
                                    <span class="c1"># number of signal points after zf</span>
                                    <span class="s2">&quot;npts&quot;</span><span class="p">:</span> <span class="mi">8192</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                                    <span class="c1"># display all this process to check what the hell is going on</span>
                                    <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                    <span class="p">}</span>

        <span class="c1"># --- job: analyze physio signal ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;physio_analysis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">analyze_physio_2d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;analyzing physio. signals&quot;</span><span class="p">,</span>
                                       <span class="c1"># ppm range to look for a peak to analyze</span>
                                       <span class="s2">&quot;POI_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                       <span class="c1"># time range in (ms) to look around timestamp for correlation physio/MRS</span>
                                       <span class="s2">&quot;delta_time_ms&quot;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span>
                                       <span class="c1"># apodization factor used during signal analysis stage</span>
                                       <span class="s2">&quot;allowed_apodization&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                       <span class="c1"># display all this process to check what the hell is going on</span>
                                       <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span>
                                       <span class="p">}</span>

        <span class="c1"># --- job: automatic data rejection based on criterias ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;data_rejecting&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_analyze_and_reject_2d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;data rejecting&quot;</span><span class="p">,</span>
                                      <span class="c1"># ppm range to look for a peak to analyze</span>
                                      <span class="s2">&quot;POI_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                      <span class="c1"># ppm range to estimate SNR</span>
                                      <span class="s2">&quot;POI_SNR_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                      <span class="c1"># ppm range to estimate LW</span>
                                      <span class="s2">&quot;POI_LW_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                      <span class="c1"># size of moving average window</span>
                                      <span class="s2">&quot;moving_averages&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="c1"># if True, rejects if linewidth could not be estimated</span>
                                      <span class="s2">&quot;reject_when_linewidth_fails&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="c1"># rejection criterias for</span>
                                      <span class="c1"># amplitude relative changes: keep data if within +/-val % range</span>
                                      <span class="c1"># linewidth changes: keep data is below val Hz</span>
                                      <span class="c1"># chemical shift changes: keep data is within +/-val ppm</span>
                                      <span class="c1"># phase changes: keep data if within +/-val/100 * std(phase) rd</span>
                                      <span class="s2">&quot;ranges&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;amplitude (%)&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                 <span class="s2">&quot;linewidth (Hz)&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                 <span class="s2">&quot;chemical shift (ppm)&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                                 <span class="s2">&quot;phase std. factor (%)&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
                                      <span class="c1"># for amplitude, chemical shift and phase, the rejection of data is based on ranges of relative changes of those metrics. Relative to what? The man value over the whole acquisition (True) or the first acquired point (False)</span>
                                      <span class="s2">&quot;rel2mean&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="c1"># method for automatic adjustement</span>
                                      <span class="s2">&quot;auto_method_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_AMPLITUDE</span><span class="p">,</span>
                                                           <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_LINEWIDTH</span><span class="p">,</span>
                                                           <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_FREQUENCY</span><span class="p">,</span>
                                                           <span class="n">data_rejection_method</span><span class="o">.</span><span class="n">AUTO_PHASE</span><span class="p">],</span>
                                      <span class="c1"># minimum allowed SNR change (%) when adjusting the linewidth criteria, this can be positive (we want to increase SNR +10% by rejecting crappy dat) or negative (we are ok in decreasing the SNR -10% in order to get better resolved spectra)</span>
                                      <span class="s2">&quot;auto_allowed_snr_change&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                                      <span class="c1"># apodization factor used during signal analysis stage</span>
                                      <span class="s2">&quot;allowed_apodization&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                      <span class="c1"># intercorrelation mode for realignment?</span>
                                      <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                      <span class="p">}</span>

        <span class="c1"># --- job: automatic data frequency realignment ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;realigning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_realign_2d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;frequency realigning&quot;</span><span class="p">,</span>
                                  <span class="c1"># ppm range to look for a peak to analyze</span>
                                  <span class="s2">&quot;POI_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                  <span class="c1"># size of moving average window</span>
                                  <span class="s2">&quot;moving_averages&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="c1"># use correlation mode</span>
                                  <span class="s2">&quot;inter_corr_mode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                  <span class="c1"># maximum frequency shift allowed in Hz</span>
                                  <span class="s2">&quot;freq_shift_max&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
                                  <span class="c1"># apodization factor used during signal analysis stage</span>
                                  <span class="s2">&quot;allowed_apodization&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                  <span class="c1"># display all this process to check what the hell is going on</span>
                                  <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                  <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                  <span class="p">}</span>

        <span class="c1"># --- job: spectral filtering ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;filtering&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_bandpass_filtering_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;FFT filtering&quot;</span><span class="p">,</span>
                                 <span class="c1"># ppm range to keep</span>
                                 <span class="s2">&quot;range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                                 <span class="c1"># type of apodization window (take it from numpy/scipy)</span>
                                 <span class="s2">&quot;window_func&quot;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">tukey</span><span class="p">,</span>
                                 <span class="c1"># display all this process to check what the hell is going on</span>
                                 <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                 <span class="p">}</span>

        <span class="c1"># --- job: data averaging ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;averaging&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_average_2d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;averaging&quot;</span><span class="p">,</span>
                                 <span class="c1"># number of averages to mean (None = all)</span>
                                 <span class="s2">&quot;na&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="c1"># display all this process to check what the hell is going on</span>
                                 <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                 <span class="p">}</span>

        <span class="c1"># --- job: phasing using suspect ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;phasing_suspect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_phase_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;phasing (suspect)&quot;</span><span class="p">,</span>
                                         <span class="c1"># phasing method</span>
                                         <span class="s2">&quot;suspect_method&quot;</span><span class="p">:</span> <span class="n">suspect_phasing_method</span><span class="o">.</span><span class="n">MATCH_MAGNITUDE_REAL</span><span class="p">,</span>
                                         <span class="c1"># ppm range to analyze phase</span>
                                         <span class="s2">&quot;range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                                         <span class="c1"># apodization factor used during signal analysis stage</span>
                                         <span class="s2">&quot;allowed_apodization&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                         <span class="c1"># display all this process to check what the hell is going on</span>
                                         <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                         <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                         <span class="p">}</span>

        <span class="c1"># --- job: noise level analysis ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;noise_estimation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">analyze_noise_nd</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;estimating noise level&quot;</span><span class="p">,</span>
                                        <span class="c1"># estimate noise std time-domain on the last 100 pts of the FID</span>
                                        <span class="s2">&quot;npts&quot;</span><span class="p">:</span> <span class="mi">100</span>
                                        <span class="p">}</span>

        <span class="c1"># --- job: data apodization ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;apodizing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_apodization_nd</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;apodizing&quot;</span><span class="p">,</span>
                                 <span class="c1"># exponential damping factor for apodization (Hz)</span>
                                 <span class="s2">&quot;damping_hz&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                                 <span class="c1"># display all this process to check what the hell is going on</span>
                                 <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                 <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                 <span class="p">}</span>

        <span class="c1"># --- job: data cropping ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;cropping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_crop_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;cropping&quot;</span><span class="p">,</span>
                                <span class="c1"># final number of signal points after crop</span>
                                <span class="s2">&quot;final_npts&quot;</span><span class="p">:</span> <span class="mi">6144</span><span class="p">,</span>
                                <span class="c1"># display all this process to check what the hell is going on</span>
                                <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                <span class="p">}</span>

        <span class="c1"># --- job: water post-acquisition removal ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;water_removal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_peak_removal_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;removing water peak&quot;</span><span class="p">,</span>
                                     <span class="c1"># number of components when running HSVD</span>
                                     <span class="s2">&quot;hsvd_components&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                                     <span class="c1"># ppm range where all components will be remove</span>
                                     <span class="s2">&quot;POI_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                     <span class="c1"># display all this process to check what the hell is going on</span>
                                     <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                     <span class="p">}</span>

        <span class="c1"># --- job: spectrum chemical shift calibration ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;calibrating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">correct_freqshift_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;frequency shifting&quot;</span><span class="p">,</span>
                                   <span class="c1"># ppm range to look for the peak of interest (NAA by default)</span>
                                   <span class="s2">&quot;POI_shift_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                   <span class="c1"># real ppm value for this peak</span>
                                   <span class="s2">&quot;POI_shift_true_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                   <span class="c1"># apodization factor used during signal analysis stage</span>
                                   <span class="s2">&quot;allowed_apodization&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                   <span class="c1"># display all this process to check what the hell is going on</span>
                                   <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                   <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                   <span class="p">}</span>

        <span class="c1"># --- job: SNR analysis ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;analyzing_snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">analyze_snr_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;analyzing SNR&quot;</span><span class="p">,</span>
                                     <span class="c1"># ppm range to look for a peak to analyze</span>
                                     <span class="s2">&quot;POI_SNR_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                     <span class="c1"># ppm range to look for pure noise</span>
                                     <span class="s2">&quot;n_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="c1"># divide SNR by 2, like LCModel do</span>
                                     <span class="s2">&quot;half_factor&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="c1"># should we look at the magnitude or real spectrum?</span>
                                     <span class="s2">&quot;magnitude_mode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="c1"># display all this process to check what the hell is going on</span>
                                     <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                     <span class="p">}</span>

        <span class="c1"># --- job: LW analysis ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;analyzing_lw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">analyze_linewidth_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;analyzing peak-linewidth&quot;</span><span class="p">,</span>
                                    <span class="c1"># ppm range to look for a peak to analyze</span>
                                    <span class="s2">&quot;POI_LW_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                    <span class="c1"># should we look at the magnitude or real spectrum?</span>
                                    <span class="s2">&quot;magnitude_mode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="c1"># display all this process to check what the hell is going on</span>
                                    <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                    <span class="p">}</span>

        <span class="c1"># --- job: ref data SNR analysis ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;ref_data_analyzing_snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">analyze_snr_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;analyzing ref. data SNR&quot;</span><span class="p">,</span>
                                     <span class="c1"># ppm range to look for a peak to analyze</span>
                                     <span class="s2">&quot;POI_ref_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                     <span class="c1"># ppm range to look for pure noise</span>
                                     <span class="s2">&quot;n_range_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="c1"># divide SNR by 2, like LCModel do</span>
                                     <span class="s2">&quot;half_factor&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="c1"># should we look at the magnitude or real spectrum?</span>
                                     <span class="s2">&quot;magnitude_mode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="c1"># display all this process to check what the hell is going on</span>
                                     <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                     <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                     <span class="p">}</span>

        <span class="c1"># --- job: ref data LW analysis ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;ref_data_analyzing_lw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;job_func&quot;</span><span class="p">:</span> <span class="n">MRSData2</span><span class="o">.</span><span class="n">analyze_linewidth_1d</span><span class="p">,</span> <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="s2">&quot;analyzing ref. data peak-linewidth&quot;</span><span class="p">,</span>
                                    <span class="c1"># ppm range to look for a peak to analyze</span>
                                    <span class="s2">&quot;POI_ref_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">,</span>
                                    <span class="c1"># should we look at the magnitude or real spectrum?</span>
                                    <span class="s2">&quot;magnitude_mode&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="c1"># display all this process to check what the hell is going on</span>
                                    <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;display_range_ppm&quot;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span>
                                    <span class="p">}</span>

        <span class="c1"># --- job list ---</span>
        <span class="c1"># list of data processing to apply to the data</span>
        <span class="c1"># beware, you need to know what you are doing here</span>
        <span class="c1"># also, be careful with the dimensionality of data 3D, 2D, 1D along the data processing</span>
        <span class="c1"># order is important!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;phasing&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;FID modulus&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;channel_combining&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;concatenate&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;zero_filling&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;physio_analysis&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;data_rejecting&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;realigning&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;averaging&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;noise_estimation&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;apodizing&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;cropping&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;water_removal&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;calibrating&quot;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying&quot;</span><span class="p">]]</span>

        <span class="c1"># --- analyze job list ---</span>
        <span class="c1"># SNR/LW analysis job list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_job_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;channel_combining&quot;</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;averaging&quot;</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;calibrating&quot;</span><span class="p">]]</span>

        <span class="c1"># --- SNR/LW analysis ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_enable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_display</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># --- template loading if needed ---</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="n">template_name</span>
        <span class="k">if</span><span class="p">(</span><span class="n">template_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># overwrite everything above with the template</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

        <span class="c1"># freeze the object and prevent the creation of new attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__isfrozen</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return value of setting from settings dict. Sounds like a stupid method but I use it to replace pointers. To make it a little easier for the user, a settings dict contains all the main parameters that I repeatably used during the reco, especially the ppm range to look for a peak of interest (POI). For each job defined above, the default parameter value are linked to this settings dict using this method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        setting_key : dict key from self.settings</span>
<span class="sd">            Name of the setting</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.settings[setting_key] : ?</span>
<span class="sd">            Value of the setting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">setting_key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_run_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">default_args</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate SNR and/or peak linewidth for this dataset. Values are stored. A mini default pipeline is applied before SNR/LW measurements and can be set with self.analyze_job_list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job : dict entry from self.job</span>
<span class="sd">            The job to run on the data</span>
<span class="sd">        data : MRSData2 object [whatever,...,timepoints]</span>
<span class="sd">            Data to process</span>
<span class="sd">        default_args : boolean</span>
<span class="sd">            Should we ignore the pipeline job parameters and run with default arguments (True)?</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        job_result : ?</span>
<span class="sd">            Stuff returned by the job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get job name</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line_break</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="n">job_name</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;job_name&quot;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> on [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">display_label</span><span class="p">))</span>
        <span class="c1"># get function</span>
        <span class="n">job_func</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;job_func&quot;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">default_args</span><span class="p">):</span>
            <span class="n">job_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get arguments</span>
            <span class="n">job_args</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">job_args</span><span class="p">[</span><span class="s2">&quot;job_name&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">job_args</span><span class="p">[</span><span class="s2">&quot;job_func&quot;</span><span class="p">]</span>
            <span class="n">job_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">job_args</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># call job on data</span>
        <span class="n">job_result</span> <span class="o">=</span> <span class="n">job_func</span><span class="p">(</span><span class="o">*</span><span class="n">job_args</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

        <span class="c1"># return</span>
        <span class="k">return</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">current_job</span><span class="p">,</span> <span class="n">already_done_jobs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate SNR and/or peak linewidth for this dataset. Values are stored. A mini default pipeline is applied before SNR/LW measurements and can be set with self.analyze_job_list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : MRSData2 object [whatever,...,timepoints]</span>
<span class="sd">            Dataset</span>
<span class="sd">        current_job : MRSData2 method function</span>
<span class="sd">            The job that was just applied to data before calling this function</span>
<span class="sd">        already_done_jobs : list (stack)</span>
<span class="sd">            List of already applied processing functions to this dataset</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_snr : float</span>
<span class="sd">            SNR estimated on data</span>
<span class="sd">        data_lw : float</span>
<span class="sd">            Peak linewidth estimated on data</span>
<span class="sd">        ref_data_snr : float</span>
<span class="sd">            SNR estimated on ref. data if any</span>
<span class="sd">        ref_data_lw : float</span>
<span class="sd">            Peak linewidth estimated on ref. data if any</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;estimating SNR and LW for [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">display_label</span><span class="p">)</span>

        <span class="c1"># init job list</span>
        <span class="n">this_analyze_job_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_job_list</span> <span class="o">+</span> <span class="n">already_done_jobs</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_job_list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_done_jobs</span><span class="p">)]</span>

        <span class="c1"># run mini-pipeline with default arguments (= no display)</span>
        <span class="c1"># and with no log output</span>
        <span class="n">log</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">this_analyze_job_list</span><span class="p">:</span>
            <span class="c1"># run job on this dataset with default arguments</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># measure snr</span>
        <span class="n">this_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;analyzing_snr&quot;</span><span class="p">]</span>
        <span class="n">data_snr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">this_job</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="c1"># measure lw</span>
        <span class="n">this_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;analyzing_lw&quot;</span><span class="p">]</span>
        <span class="n">data_lw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">this_job</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># measure ref data snr</span>
            <span class="n">this_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;ref_data_analyzing_snr&quot;</span><span class="p">]</span>
            <span class="n">ref_data_snr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">this_job</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">data_ref</span><span class="p">)</span>
            <span class="c1"># measure ref data lw</span>
            <span class="n">this_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;ref_data_analyzing_lw&quot;</span><span class="p">]</span>
            <span class="n">ref_data_lw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">this_job</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">data_ref</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_data_snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">ref_data_lw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># output</span>
        <span class="n">log</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="n">job_label</span> <span class="o">=</span> <span class="s2">&quot;post-&quot;</span> <span class="o">+</span> <span class="n">current_job</span><span class="p">[</span><span class="s2">&quot;job_name&quot;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">job_label</span> <span class="o">+</span> <span class="s2">&quot; SNR of [</span><span class="si">%s</span><span class="s2">] = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">data_snr</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">job_label</span> <span class="o">+</span> <span class="s2">&quot; LW of [</span><span class="si">%s</span><span class="s2">] = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span> <span class="n">data_lw</span><span class="p">))</span>

        <span class="k">return</span><span class="p">(</span><span class="n">data_snr</span><span class="p">,</span> <span class="n">data_lw</span><span class="p">,</span> <span class="n">ref_data_snr</span><span class="p">,</span> <span class="n">ref_data_lw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_detect_data_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">s_ref</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect highest SNR between these two datasets and return them in the right order.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : MRSData2 object</span>
<span class="sd">            Data supposed to be WS</span>
<span class="sd">        s_ref : MRSData2 object</span>
<span class="sd">            Data supposed to be noWS and used as a reference signal for phasing, etc.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s2 : MRSData2 object</span>
<span class="sd">            Data supposed to be WS</span>
<span class="sd">        s_ref2 : MRSData2 object</span>
<span class="sd">            Data supposed to be noWS and used as a reference signal for phasing, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># compare FID max in magnitude (dirty but robust)</span>
        <span class="n">s_ref_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_ref</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">s_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s_tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s_ref_tmp</span><span class="p">)):</span>
            <span class="c1"># need to swap</span>
            <span class="k">return</span><span class="p">(</span><span class="n">s_ref</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_ref</span><span class="p">)</span>

<div class="viewcode-block" id="pipeline.get_te_list"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.get_te_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_te_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the TEs for all the data signals in this pipeline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [s.te for s in self._data_list] : list</span>
<span class="sd">            TEs for all signals stored in here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">te</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">])</span></div>

<div class="viewcode-block" id="pipeline.run"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the pipeline for MRS reco. It includes.</span>

<span class="sd">            * reading the data</span>
<span class="sd">            * phasing</span>
<span class="sd">            * combining channels</span>
<span class="sd">            * analyze real noise level before going on with processing</span>
<span class="sd">            * zero_filling</span>
<span class="sd">            * peak analysis &amp; data rejection</span>
<span class="sd">            * realigning</span>
<span class="sd">            * averaging</span>
<span class="sd">            * checking original noise level</span>
<span class="sd">            * apodizing</span>
<span class="sd">            * cropping</span>
<span class="sd">            * removing water reidue with HSVD</span>
<span class="sd">            * shifting the spectrum</span>
<span class="sd">            * analyzing the SNR</span>
<span class="sd">            * analyzing the linewidth</span>
<span class="sd">            * displaying the spectrum</span>
<span class="sd">            +</span>
<span class="sd">            * analyzing the SNR evolution during data processing</span>
<span class="sd">            * analyzing the linewidth evolution during data processing</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self._data_list : list of MRSData2 objects</span>
<span class="sd">            Final MRS data signals obtained from reconstruction pipeline stored in a MRSData2 object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- reading dataset dict</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;checking datasets...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

        <span class="c1"># for each data set, check dict fields</span>
        <span class="n">ind_dataset_ok</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="n">legend_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">rawdata_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">rawfiles_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">dicomfiles_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">physiofile_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;physio_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">imagingfile_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;imaging_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># checking that this is an entry</span>
            <span class="k">if</span><span class="p">(</span><span class="n">legend_ok</span> <span class="ow">or</span> <span class="n">rawfiles_ok</span> <span class="ow">or</span> <span class="n">dicomfiles_ok</span> <span class="ow">or</span> <span class="n">physiofile_ok</span> <span class="ow">or</span> <span class="n">imagingfile_ok</span><span class="p">):</span>
                <span class="c1"># seems like a entry</span>

                <span class="c1"># checking legend</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">legend_ok</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;dataset[</span><span class="si">%d</span><span class="s2">] is missing a legend! :(&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># checking datafiles</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">rawdata_ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rawfiles_ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dicomfiles_ok</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;dataset[</span><span class="si">%d</span><span class="s2">] is missing data, no raw or dicom files were set! :(&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># checking number of datafiles</span>
                <span class="k">if</span><span class="p">(</span><span class="n">rawfiles_ok</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;dataset[</span><span class="si">%d</span><span class="s2">] has </span><span class="si">%d</span><span class="s2"> raw-files! There should be 1 or 2. :(&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">])))</span>
                <span class="k">if</span><span class="p">(</span><span class="n">dicomfiles_ok</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;dataset[</span><span class="si">%d</span><span class="s2">] has </span><span class="si">%d</span><span class="s2"> dicom-files! There should be 1 or 2. :(&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">])))</span>

                <span class="c1"># clean and print strings</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;dataset[</span><span class="si">%d</span><span class="s2">]:&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># legend</span>
                <span class="k">if</span><span class="p">(</span><span class="n">legend_ok</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  legend = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;legend&quot;</span><span class="p">])</span>
                <span class="c1"># raw data</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  raw #0 = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  raw #1 [REF] = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  raw #1 [REF] = None&quot;</span><span class="p">)</span>
                <span class="c1"># dicom</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  dicom #0 = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  dicom #1 [REF] = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  dicom #1 [REF] = None&quot;</span><span class="p">)</span>
                <span class="c1"># physio</span>
                <span class="k">if</span><span class="p">(</span><span class="n">physiofile_ok</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;physio_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;physio_file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  physio = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;physio_file&quot;</span><span class="p">])</span>
                <span class="c1"># imaging</span>
                <span class="k">if</span><span class="p">(</span><span class="n">imagingfile_ok</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;imaging_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;imaging_file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  imaging = &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;imaging_file&quot;</span><span class="p">])</span>

                <span class="c1"># index of non-empty datasets</span>
                <span class="n">ind_dataset_ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># filter datasets</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;datasets_indexes&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># if only one index, convert to list</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;datasets_indexes&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;datasets_indexes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;datasets_indexes&quot;</span><span class="p">]]</span>

            <span class="c1"># keep only data to process</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;datasets_indexes&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># keep only the non-empty datasets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind_dataset_ok</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

        <span class="c1"># --- reading data ---</span>
        <span class="c1"># now let&#39;s read the data files</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line_break</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading data files...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="n">this_legend</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span>
            <span class="n">this_physio_filename</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;physio_file&quot;</span><span class="p">]</span>
            <span class="n">this_imaging_filename</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;imaging_file&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;dcm&quot;</span><span class="p">]:</span>
                <span class="c1"># check if any data file to read</span>
                <span class="n">this_data_filename</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_data_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># no? so pass</span>
                    <span class="k">continue</span>

                <span class="c1"># reading WS data</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading data [&quot;</span> <span class="o">+</span> <span class="n">this_legend</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">MRSData2</span><span class="p">(</span><span class="n">this_data_filename</span><span class="p">,</span> <span class="n">this_physio_filename</span><span class="p">,</span> <span class="n">this_imaging_filename</span><span class="p">)</span>

                <span class="c1"># reading noWS data</span>
                <span class="n">this_data_ref_filename</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_data_ref_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info_line_break</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading data [&quot;</span> <span class="o">+</span> <span class="n">this_legend</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                    <span class="n">s_ref</span> <span class="o">=</span> <span class="n">MRSData2</span><span class="p">(</span><span class="n">this_data_ref_filename</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># find ref data (highest snr)</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">s_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_data_ref</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s_ref</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s_ref</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;data : got a &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; vector&quot;</span><span class="p">)</span>
                <span class="c1"># set ppm reference</span>
                <span class="n">s</span><span class="o">.</span><span class="n">ppm0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;ppm0&quot;</span><span class="p">]</span>
                <span class="c1"># set legend &amp; offset</span>
                <span class="n">this_new_legend</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;#</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">this_legend</span>
                <span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">is_rawdata</span><span class="p">):</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="n">this_new_legend</span> <span class="o">+</span> <span class="s2">&quot; [RAW]&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="n">this_new_legend</span> <span class="o">+</span> <span class="s2">&quot; [DCM]&quot;</span><span class="p">)</span>

                <span class="n">s</span><span class="o">.</span><span class="n">set_display_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;display_offset&quot;</span><span class="p">])</span>
                <span class="c1"># store</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_new_legend</span>

                <span class="k">if</span><span class="p">(</span><span class="n">s_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info_line_break</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ref. data: got a &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; vector&quot;</span><span class="p">)</span>
                    <span class="c1"># if several averages, mean now (that could be a problem!?)</span>
                    <span class="n">s_ref</span> <span class="o">=</span> <span class="n">s_ref</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># add 1 dimension</span>
                    <span class="n">s_ref</span> <span class="o">=</span> <span class="n">s_ref</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">s_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;reshaped to a &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; vector&quot;</span><span class="p">)</span>
                    <span class="c1"># set ppm reference</span>
                    <span class="n">s_ref</span><span class="o">.</span><span class="n">ppm0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;ppm0&quot;</span><span class="p">]</span>
                    <span class="c1"># set legend &amp; offset</span>
                    <span class="n">this_new_legend</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;#</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">this_legend</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">s_ref</span><span class="o">.</span><span class="n">is_rawdata</span><span class="p">):</span>
                        <span class="n">s_ref</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="n">this_new_legend</span> <span class="o">+</span> <span class="s2">&quot; [REF] [RAW]&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s_ref</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="n">this_new_legend</span> <span class="o">+</span> <span class="s2">&quot; [REF] [DCM]&quot;</span><span class="p">)</span>
                    <span class="n">s_ref</span><span class="o">.</span><span class="n">set_display_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;display_offset&quot;</span><span class="p">])</span>
                    <span class="c1"># store</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data_ref</span> <span class="o">=</span> <span class="n">s_ref</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

        <span class="c1"># --- applying global settings ---</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading your job list...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="c1"># applying some global settings to jobs</span>
        <span class="n">default_display_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">this_job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">this_setting_name</span><span class="p">,</span> <span class="n">this_setting_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="n">this_job_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># should we use a default value for this parameter?</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_setting_value</span> <span class="o">==</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="n">this_job_name</span><span class="p">][</span><span class="n">this_setting_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_setting</span><span class="p">(</span><span class="n">this_setting_name</span><span class="p">)</span>
                <span class="c1"># with exception for display setting (mask) to control display per job</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_setting_name</span> <span class="o">==</span> <span class="s2">&quot;display&quot;</span> <span class="ow">and</span> <span class="n">default_display_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># False False =&gt; False</span>
                    <span class="c1"># False True =&gt; False</span>
                    <span class="c1"># True True =&gt; True</span>
                    <span class="c1"># True False =&gt; False</span>
                    <span class="c1"># that&#39;s a &quot;and mask&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="n">this_job_name</span><span class="p">][</span><span class="n">this_setting_name</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">default_display_value</span>

        <span class="c1"># remove display job if we don&#39;t want to display</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;display&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying&quot;</span><span class="p">])</span>
            <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying_anatomy&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying_anatomy&quot;</span><span class="p">])</span>

        <span class="c1"># for each job</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">this_job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">):</span>
            <span class="n">this_job_name</span> <span class="o">=</span> <span class="n">this_job</span><span class="p">[</span><span class="s2">&quot;job_name&quot;</span><span class="p">]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">this_job_name</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

        <span class="c1"># --- running job list ---</span>
        <span class="c1"># exception here: if any concatenate, we need to run the job list in two parts (before and after concatenation in order to reload the processed data)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line_break</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;running job list...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="c1"># init job stacks</span>
        <span class="n">concatenate_loop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;concatenate&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">jobs_stack_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">jobs_stack</span> <span class="o">=</span> <span class="n">jobs_stack_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">jobs_done_stack_init</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">jobs_done_stack</span> <span class="o">=</span> <span class="n">jobs_done_stack_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">concatenate_loop</span><span class="p">):</span>
            <span class="c1"># resuming job stack after concatenate</span>
            <span class="n">jobs_stack_init</span> <span class="o">=</span> <span class="n">jobs_stack</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">jobs_done_stack_init</span> <span class="o">=</span> <span class="n">jobs_done_stack</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># for each dataset, raw and dicom, the list of data processing functions with the right arguments</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;dcm&quot;</span><span class="p">]:</span>
                    <span class="n">this_data</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                    <span class="c1"># if no data to process (= no DCM provided)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">this_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">info_line_break</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;processing [&quot;</span> <span class="o">+</span> <span class="n">this_data</span><span class="o">.</span><span class="n">display_label</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

                    <span class="c1"># run job list for this dataset</span>
                    <span class="n">jobs_stack</span> <span class="o">=</span> <span class="n">jobs_stack_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">jobs_done_stack</span> <span class="o">=</span> <span class="n">jobs_done_stack_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># job pop</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="n">jobs_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="c1"># if concatenate, get out of this dataset job loop</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">job</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;concatenate&quot;</span><span class="p">]):</span>
                            <span class="k">break</span>

                        <span class="c1"># run job on this dataset</span>
                        <span class="n">job_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">this_data</span><span class="p">)</span>

                        <span class="c1"># push job in the stack of jobs done</span>
                        <span class="n">jobs_done_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

                        <span class="c1"># replace with processed signal</span>
                        <span class="k">if</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span> <span class="o">==</span> <span class="n">MRSData2</span><span class="p">):</span>
                            <span class="n">this_data</span> <span class="o">=</span> <span class="n">job_result</span>
                            <span class="c1"># measure SNR/LW after this process?</span>
                            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_enable</span><span class="p">):</span>
                                <span class="c1"># prepare storage</span>
                                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                                <span class="c1"># get job name, renaming if needed</span>
                                <span class="n">this_job_name</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;job_name&quot;</span><span class="p">]</span>
                                <span class="c1"># get list of job names already in analysis list</span>
                                <span class="n">analysis_results_job_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                                <span class="c1"># check if any duplicates, meaning a job than was applied multiple times</span>
                                <span class="n">analysis_results_job_names_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">this_job_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">analysis_results_job_names</span><span class="p">]</span>
                                <span class="n">this_job_already_applied_count</span> <span class="o">=</span> <span class="n">analysis_results_job_names_mask</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">if</span><span class="p">(</span><span class="n">this_job_already_applied_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                                    <span class="c1"># not the first time we apply this job?</span>
                                    <span class="n">this_job_name</span> <span class="o">=</span> <span class="n">this_job_name</span> <span class="o">+</span> <span class="s2">&quot; (#</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_job_already_applied_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                                <span class="c1"># get SNR and LW estimations</span>
                                <span class="n">this_data_snr</span><span class="p">,</span> <span class="n">this_data_lw</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span><span class="p">(</span><span class="n">this_data</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">jobs_done_stack</span><span class="p">)</span>

                                <span class="c1"># store analysis results</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">][</span><span class="n">this_job_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="n">this_data_snr</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="n">this_data_lw</span><span class="p">}</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

                    <span class="c1"># we finish running all jobs on a dataset, storing</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_data</span>

            <span class="c1"># if last job was concatenate, that means all datasets were processed and are ready for it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">job</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;concatenate&quot;</span><span class="p">]):</span>
                <span class="n">job_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;concatenate&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">job_name</span><span class="p">)</span>
                <span class="c1"># attention, concatenate is only done for raw data</span>
                <span class="n">s_concatenated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)):</span>
                    <span class="n">s_concatenated</span> <span class="o">=</span> <span class="n">s_concatenated</span><span class="o">.</span><span class="n">concatenate_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>

                <span class="c1"># empty and store the single concatenated signal in the dataset dict</span>
                <span class="n">s_concatenated</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="n">s_concatenated</span><span class="o">.</span><span class="n">display_label</span> <span class="o">+</span> <span class="s2">&quot; [CONCATENATED]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_concatenated</span><span class="o">.</span><span class="n">display_label</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_concatenated</span>

        <span class="c1"># if we did a concatenate job, then keep only the first concatenated dataset at index 0</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;concatenate&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># before leaving, analyze ref data if available</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;dcm&quot;</span><span class="p">]:</span>
                <span class="n">this_data</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                <span class="c1"># if no data to process (= no DCM provided)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">this_data_ref_snr</span><span class="p">,</span> <span class="n">this_data_ref_lw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze</span><span class="p">(</span><span class="n">this_data</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">jobs_done_stack</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="n">this_data_ref_snr</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="n">this_data_ref_lw</span><span class="p">}</span>

        <span class="c1"># --- summary final linewidths ---</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_enable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;display&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_analyze_results</span><span class="p">()</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pipeline terminated!&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;returning processed signals!&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span></div>

<div class="viewcode-block" id="pipeline.get_analyze_results"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.get_analyze_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_analyze_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return analyze results as several numpy vectors eassy to plot.Dataset and job names will be padded to ease terminal output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_label_list : list (n)</span>
<span class="sd">            Data legends</span>
<span class="sd">        job_label_list : list (n)</span>
<span class="sd">            Job names</span>
<span class="sd">        snr_raw_list : numpy array (n x m)</span>
<span class="sd">            SNR estimated on raw data</span>
<span class="sd">        lw_raw_list : numpy array (n x m)</span>
<span class="sd">            Peak linewidth estimated on raw data</span>
<span class="sd">        snr_dcm_list : numpy array (n x m)</span>
<span class="sd">            SNR estimated on reconstructed data (dicom)</span>
<span class="sd">        lw_dcm_list : numpy array (n x m)</span>
<span class="sd">            Peak linewidth estimated on reconstructed data (dicom)</span>
<span class="sd">        snr_ref_raw_list : numpy array (n)</span>
<span class="sd">            SNR estimated on raw ref. data</span>
<span class="sd">        lw_ref_raw_list : numpy array (n)</span>
<span class="sd">            Peak linewidth estimated on raw ref. data</span>
<span class="sd">        snr_ref_dcm_list : numpy array (n)</span>
<span class="sd">            SNR estimated on reconstructed ref. data (dicom)</span>
<span class="sd">        lw_ref_dcm_list : numpy array (n)</span>
<span class="sd">            Peak linewidth estimated on reconstructed ref. data (dicom)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;converting analyze results to arrays...&quot;</span><span class="p">)</span>

        <span class="c1"># build label list</span>
        <span class="n">data_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">]</span>
        <span class="n">data_label_nchar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">data_labels</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span>
        <span class="n">data_label_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">data_label_nchar</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data_labels</span><span class="p">]</span>

        <span class="c1"># build job label list</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">job_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">job_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">job_label_nchar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">job_labels</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span>
        <span class="n">job_label_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">job_label_nchar</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">job_labels</span><span class="p">]</span>

        <span class="c1"># init</span>
        <span class="n">snr_raw_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lw_raw_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">snr_dcm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lw_dcm_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">snr_ref_raw_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lw_ref_raw_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">snr_ref_dcm_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lw_ref_dcm_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># for each dataset</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
            <span class="c1"># if raw data, find snr and lw estimations and store it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snr_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">lw_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;lw&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">snr_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_label_list</span><span class="p">))</span>
                <span class="n">lw_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_label_list</span><span class="p">))</span>

            <span class="c1"># if dcm data, find snr and lw estimations and store it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snr_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">lw_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;lw&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">snr_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_label_list</span><span class="p">))</span>
                <span class="n">lw_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_label_list</span><span class="p">))</span>

            <span class="c1"># if raw ref data, find snr and lw estimations and store it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snr_ref_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">][</span><span class="s2">&quot;snr&quot;</span><span class="p">]])</span>
                <span class="n">lw_ref_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">][</span><span class="s2">&quot;lw&quot;</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">snr_ref_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                <span class="n">lw_ref_raw_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>

            <span class="c1"># if dcm ref data, find snr and lw estimations and store it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snr_ref_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">][</span><span class="s2">&quot;snr&quot;</span><span class="p">]])</span>
                <span class="n">lw_ref_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;dcm&quot;</span><span class="p">][</span><span class="s2">&quot;ref_data_analysis_results&quot;</span><span class="p">][</span><span class="s2">&quot;lw&quot;</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">snr_ref_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                <span class="n">lw_ref_dcm_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>

        <span class="n">snr_raw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snr_raw_list</span><span class="p">)</span>
        <span class="n">lw_raw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lw_raw_list</span><span class="p">)</span>
        <span class="n">snr_dcm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snr_dcm_list</span><span class="p">)</span>
        <span class="n">lw_dcm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lw_dcm_list</span><span class="p">)</span>

        <span class="n">snr_ref_raw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snr_ref_raw_list</span><span class="p">)</span>
        <span class="n">lw_ref_raw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lw_ref_raw_list</span><span class="p">)</span>
        <span class="n">snr_ref_dcm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snr_ref_dcm_list</span><span class="p">)</span>
        <span class="n">lw_ref_dcm_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lw_ref_dcm_list</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">data_label_list</span><span class="p">,</span> <span class="n">job_label_list</span><span class="p">,</span> <span class="n">snr_raw_list</span><span class="p">,</span> <span class="n">lw_raw_list</span><span class="p">,</span> <span class="n">snr_dcm_list</span><span class="p">,</span> <span class="n">lw_dcm_list</span><span class="p">,</span> <span class="n">snr_ref_raw_list</span><span class="p">,</span> <span class="n">lw_ref_raw_list</span><span class="p">,</span> <span class="n">snr_ref_dcm_list</span><span class="p">,</span> <span class="n">lw_ref_dcm_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="pipeline.get_final_analyze_results"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.get_final_analyze_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_final_analyze_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return final analyze results for each dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_label_list : list (n)</span>
<span class="sd">            Data legends</span>
<span class="sd">        snr_raw_list : numpy array (n)</span>
<span class="sd">            SNR estimated on data</span>
<span class="sd">        lw_raw_list : numpy array (n)</span>
<span class="sd">            Peak linewidth estimated on data</span>
<span class="sd">        lw_ref_raw_list : numpy array (n)</span>
<span class="sd">            Peak linewidth estimated on ref. data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;returning final analyze results...&quot;</span><span class="p">)</span>

        <span class="n">data_label_list</span><span class="p">,</span> <span class="n">job_label_list</span><span class="p">,</span> <span class="n">snr_raw_list</span><span class="p">,</span> <span class="n">lw_raw_list</span><span class="p">,</span> <span class="n">snr_dcm_list</span><span class="p">,</span> <span class="n">lw_dcm_list</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">lw_ref_raw_list</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">lw_ref_dcm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analyze_results</span><span class="p">()</span>

        <span class="c1"># only keep final estimations from last job</span>
        <span class="n">snr_raw_list</span> <span class="o">=</span> <span class="n">snr_raw_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lw_raw_list</span> <span class="o">=</span> <span class="n">lw_raw_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">snr_dcm_list</span> <span class="o">=</span> <span class="n">snr_dcm_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lw_dcm_list</span> <span class="o">=</span> <span class="n">lw_dcm_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lw_ref_raw_list</span> <span class="o">=</span> <span class="n">lw_ref_raw_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lw_ref_dcm_list</span> <span class="o">=</span> <span class="n">lw_ref_dcm_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># if any raw data estimations are None, replace them by dcm estimations</span>
        <span class="n">snr_raw_list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">snr_raw_list</span><span class="p">)]</span> <span class="o">=</span> <span class="n">snr_dcm_list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">snr_raw_list</span><span class="p">)]</span>
        <span class="n">lw_raw_list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lw_raw_list</span><span class="p">)]</span> <span class="o">=</span> <span class="n">lw_dcm_list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lw_raw_list</span><span class="p">)]</span>
        <span class="n">lw_ref_raw_list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lw_ref_raw_list</span><span class="p">)]</span> <span class="o">=</span> <span class="n">lw_ref_dcm_list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lw_ref_raw_list</span><span class="p">)]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">data_label_list</span><span class="p">,</span> <span class="n">snr_raw_list</span><span class="p">,</span> <span class="n">lw_raw_list</span><span class="p">,</span> <span class="n">lw_ref_raw_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="pipeline.check_analyze_results"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.check_analyze_results">[docs]</a>    <span class="k">def</span> <span class="nf">check_analyze_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for each dataset that we got a beter reconstruction with raw data than dicom.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ignore_error : boolean</span>
<span class="sd">            Do not raise error if raw data reconstruction gave worst results than DICOM in terms of SNR and /or LW. If (False), just raise a warning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;quality checking analyze results...&quot;</span><span class="p">)</span>

        <span class="n">data_label_list</span><span class="p">,</span> <span class="n">job_label_list</span><span class="p">,</span> <span class="n">snr_raw_list</span><span class="p">,</span> <span class="n">lw_raw_list</span><span class="p">,</span> <span class="n">snr_dcm_list</span><span class="p">,</span> <span class="n">lw_dcm_list</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analyze_results</span><span class="p">()</span>

        <span class="c1"># only keep final estimations from last job</span>
        <span class="n">snr_raw_list</span> <span class="o">=</span> <span class="n">snr_raw_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lw_raw_list</span> <span class="o">=</span> <span class="n">lw_raw_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">snr_dcm_list</span> <span class="o">=</span> <span class="n">snr_dcm_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lw_dcm_list</span> <span class="o">=</span> <span class="n">lw_dcm_list</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">error_str</span> <span class="o">=</span> <span class="s2">&quot;final SNR and/or LW is worst for raw data than for dicom for dataset(s): &quot;</span>
        <span class="n">n_bad_reco</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># compare dcm analyze results to raw data results, when possible</span>
        <span class="k">for</span> <span class="n">this_dataset_label</span><span class="p">,</span> <span class="n">this_snr_raw</span><span class="p">,</span> <span class="n">this_lw_raw</span><span class="p">,</span> <span class="n">this_snr_dcm</span><span class="p">,</span> <span class="n">this_lw_dcm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data_label_list</span><span class="p">,</span> <span class="n">snr_raw_list</span><span class="p">,</span> <span class="n">lw_raw_list</span><span class="p">,</span> <span class="n">snr_dcm_list</span><span class="p">,</span> <span class="n">lw_dcm_list</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">this_snr_raw</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">this_snr_dcm</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">this_lw_raw</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">this_lw_dcm</span><span class="p">)):</span>
                <span class="k">if</span><span class="p">((</span><span class="n">this_snr_raw</span> <span class="o">&lt;</span> <span class="n">this_snr_dcm</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this_lw_raw</span> <span class="o">&gt;</span> <span class="n">this_lw_dcm</span><span class="p">)):</span>
                    <span class="c1"># the raw data reconstruction was worst than the dicom :(</span>
                    <span class="n">n_bad_reco</span> <span class="o">=</span> <span class="n">n_bad_reco</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">error_str</span> <span class="o">=</span> <span class="n">error_str</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">], &quot;</span> <span class="o">%</span> <span class="n">this_dataset_label</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">n_bad_reco</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raise_error_on_badreco&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_error</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_str</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_str</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="pipeline.display_analyze_results"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.display_analyze_results">[docs]</a>    <span class="k">def</span> <span class="nf">display_analyze_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print final SNR and peak-linewidth for each dataset. Plot bargraph showing evolution of SNR and linewidth during data processing (to check that a job did not destroy the data for example!) and compare with dicom when possible.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;displaying SNR and linewidth final results...&quot;</span><span class="p">)</span>

        <span class="c1"># get analyze data as list and np arrays</span>
        <span class="n">data_label_list</span><span class="p">,</span> <span class="n">job_label_list</span><span class="p">,</span> <span class="n">snr_raw_list</span><span class="p">,</span> <span class="n">lw_raw_list</span><span class="p">,</span> <span class="n">snr_dcm_list</span><span class="p">,</span> <span class="n">lw_dcm_list</span><span class="p">,</span> <span class="n">snr_ref_raw_list</span><span class="p">,</span> <span class="n">lw_ref_raw_list</span><span class="p">,</span> <span class="n">snr_ref_dcm_list</span><span class="p">,</span> <span class="n">lw_ref_dcm_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analyze_results</span><span class="p">()</span>

        <span class="c1"># terminal output</span>

        <span class="c1"># for each dataset (line), print final SNR/LW columns</span>
        <span class="c1"># if DCM dataset was included, add SNR/LW for DCM too</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RAW / DCM dataset &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_label_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;SNR (u.a)&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;LW (Hz)&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;ref. data LW (Hz)&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">this_dataset_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_label_list</span><span class="p">):</span>
            <span class="n">this_dataset_lastjob_snr_raw</span> <span class="o">=</span> <span class="n">snr_raw_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">this_dataset_lastjob_snr_dcm</span> <span class="o">=</span> <span class="n">snr_dcm_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">this_dataset_lastjob_snr_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> / </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_dataset_lastjob_snr_raw</span><span class="p">,</span> <span class="n">this_dataset_lastjob_snr_dcm</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

            <span class="n">this_dataset_lastjob_lw_raw</span> <span class="o">=</span> <span class="n">lw_raw_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">this_dataset_lastjob_lw_dcm</span> <span class="o">=</span> <span class="n">lw_dcm_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">this_dataset_lastjob_lw_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> / </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_dataset_lastjob_lw_raw</span><span class="p">,</span> <span class="n">this_dataset_lastjob_lw_dcm</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

            <span class="n">this_dataset_ref_lw_raw</span> <span class="o">=</span> <span class="n">lw_ref_raw_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">this_dataset_ref_lw_dcm</span> <span class="o">=</span> <span class="n">lw_ref_dcm_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">this_dataset_ref_lw_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> / </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_dataset_ref_lw_raw</span><span class="p">,</span> <span class="n">this_dataset_ref_lw_dcm</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_dataset_label</span><span class="p">,</span> <span class="n">this_dataset_lastjob_snr_str</span><span class="p">,</span> <span class="n">this_dataset_lastjob_lw_str</span><span class="p">,</span> <span class="n">this_dataset_ref_lw_str</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

        <span class="c1"># display SNR/LW evolution for all data and all jobs</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_display</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;display_analyze_results (mrs.reco.MRSData2)&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;SNR/peak-linewidth results&quot;</span><span class="p">)</span>

            <span class="c1"># prepare bars</span>
            <span class="n">nBars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_label_list</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span> <span class="o">*</span> <span class="n">nBars</span> <span class="o">+</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># bars get thinner if more data</span>
            <span class="n">pos_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">job_label_list</span><span class="p">))</span>
            <span class="n">pos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">nBars</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="o">+</span><span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">nBars</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">nBars</span><span class="p">)</span>
            <span class="n">snr_ylim</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
            <span class="n">lw_ylim</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

            <span class="c1"># iterate in lists and plot bars</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">this_dataset_label</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data_label_list</span><span class="p">,</span> <span class="n">pos_shift</span><span class="p">)):</span>
                <span class="c1"># snr list for this dataset, raw data</span>
                <span class="n">this_dataset_snr_list</span> <span class="o">=</span> <span class="n">snr_raw_list</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span>
                <span class="n">snr_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">snr_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">this_dataset_snr_list</span><span class="p">))</span>
                <span class="n">snr_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">snr_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">this_dataset_snr_list</span><span class="p">))</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos_bars</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">this_dataset_snr_list</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">this_dataset_label</span><span class="p">)</span>
                <span class="c1"># snr list for this dataset, dcm data</span>
                <span class="n">this_dataset_snr_list</span> <span class="o">=</span> <span class="n">snr_dcm_list</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span>
                <span class="n">snr_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">snr_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">this_dataset_snr_list</span><span class="p">))</span>
                <span class="n">snr_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">snr_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">this_dataset_snr_list</span><span class="p">))</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos_bars</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">this_dataset_snr_list</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># lw list for this dataset, raw data</span>
                <span class="n">this_dataset_lw_list</span> <span class="o">=</span> <span class="n">lw_raw_list</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span>
                <span class="n">lw_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lw_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">this_dataset_lw_list</span><span class="p">))</span>
                <span class="n">lw_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lw_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">this_dataset_lw_list</span><span class="p">))</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos_bars</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">this_dataset_lw_list</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">this_dataset_label</span><span class="p">)</span>
                <span class="c1"># lw list for this dataset, dcm data</span>
                <span class="n">this_dataset_lw_list</span> <span class="o">=</span> <span class="n">lw_dcm_list</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span>
                <span class="n">lw_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lw_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">this_dataset_lw_list</span><span class="p">))</span>
                <span class="n">lw_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lw_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">this_dataset_lw_list</span><span class="p">))</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos_bars</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">this_dataset_lw_list</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># add fake DCM bars to have it in the legend</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">pos_bars</span><span class="p">,</span> <span class="n">this_dataset_lw_list</span> <span class="o">*</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DCM&quot;</span><span class="p">)</span>

            <span class="c1"># snr bargraph</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SNR (u.a)&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">pos_bars</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">snr_ylim</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">+</span><span class="mi">5</span><span class="p">]))</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="c1"># lw bargraph</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Estimated linewidth (Hz)&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">pos_bars</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">job_label_list</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lw_ylim</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">+</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="pipeline.display_final_data"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.display_final_data">[docs]</a>    <span class="k">def</span> <span class="nf">display_final_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot final processed datasets.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;displaying final processed data...&quot;</span><span class="p">)</span>

        <span class="c1"># get display job</span>
        <span class="n">disp_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;displaying&quot;</span><span class="p">]</span>

        <span class="c1"># run a diplay job for each dataset</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="s2">&quot;dcm&quot;</span><span class="p">]:</span>
                <span class="n">this_data</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                <span class="c1"># if no data</span>
                <span class="k">if</span><span class="p">(</span><span class="n">this_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c1"># run job on this dataset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span><span class="n">disp_job</span><span class="p">,</span> <span class="n">this_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="pipeline.load_template"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.load_template">[docs]</a>    <span class="k">def</span> <span class="nf">load_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load reco pipeline attributes from template previously saved.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        template_name: string</span>
<span class="sd">            Template name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template_filename</span> <span class="o">=</span> <span class="n">template_name</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;load pipeline from template file [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="n">template_filename</span><span class="p">)</span>
        <span class="c1"># check if exist</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">default_paths</span><span class="o">.</span><span class="n">DEFAULT_RECO_TEMPLATE_FOLDER</span> <span class="o">+</span> <span class="n">template_filename</span><span class="p">)):</span>
            <span class="c1"># now open pkl file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_paths</span><span class="o">.</span><span class="n">DEFAULT_RECO_TEMPLATE_FOLDER</span> <span class="o">+</span> <span class="n">template_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="p">[</span><span class="n">reco_pipe_template</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="c1"># copy attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">reco_pipe_template</span><span class="o">.</span><span class="n">settings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">reco_pipe_template</span><span class="o">.</span><span class="n">job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_list</span> <span class="o">=</span> <span class="n">reco_pipe_template</span><span class="o">.</span><span class="n">job_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analyze_job_list</span> <span class="o">=</span> <span class="n">reco_pipe_template</span><span class="o">.</span><span class="n">analyze_job_list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analyze_enable</span> <span class="o">=</span> <span class="n">reco_pipe_template</span><span class="o">.</span><span class="n">analyze_enable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analyze_display</span> <span class="o">=</span> <span class="n">reco_pipe_template</span><span class="o">.</span><span class="n">analyze_display</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no template [</span><span class="si">%s</span><span class="s2">] found in [</span><span class="si">%s</span><span class="s2">]!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">template_filename</span><span class="p">,</span> <span class="n">default_paths</span><span class="o">.</span><span class="n">DEFAULT_RECO_TEMPLATE_FOLDER</span><span class="p">))</span></div>

<div class="viewcode-block" id="pipeline.save_template"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.save_template">[docs]</a>    <span class="k">def</span> <span class="nf">save_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save current pipeline object as template.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        template_name: string</span>
<span class="sd">            Template name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template_filename</span> <span class="o">=</span> <span class="n">template_name</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;saving current pipeline to template file [</span><span class="si">%s</span><span class="s2">]...&quot;</span> <span class="o">%</span> <span class="n">template_filename</span><span class="p">)</span>
        <span class="c1"># save to pkl file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_paths</span><span class="o">.</span><span class="n">DEFAULT_RECO_TEMPLATE_FOLDER</span> <span class="o">+</span> <span class="n">template_filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix_str</span><span class="o">=</span><span class="s2">&quot;reco_&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the object&#39;s attributes to dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefix_str : string</span>
<span class="sd">            Prefix string to add to column names</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : Dataframe</span>
<span class="sd">            With all the datasets and parameters from this pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;converting to dataframe...&quot;</span><span class="p">)</span>

        <span class="c1"># use pandas json_normalize function to flatten all nested stuff (magic!)</span>
        <span class="c1"># this takes care of the job attribute too</span>
        <span class="n">df_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># need a specific call for the dataset attribute</span>
        <span class="n">df_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">df_dataset</span> <span class="o">=</span> <span class="n">df_dataset</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;dataset_&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">df_p</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span>

        <span class="c1"># and need a specific call for the MRSData2 types</span>
        <span class="n">df_dataset_raw_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;dataset_raw_data_&quot;</span><span class="p">)</span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df_dataset</span><span class="p">[</span><span class="s2">&quot;dataset_raw_data&quot;</span><span class="p">]</span> <span class="k">if</span><span class="p">(</span><span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="n">df_dataset_dcm_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;dataset_dcm_data_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df_dataset</span><span class="p">[</span><span class="s2">&quot;dataset_dcm_data&quot;</span><span class="p">]</span> <span class="k">if</span><span class="p">(</span><span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df_dataset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_dataset_raw_data_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">df_dataset_raw_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_dataset_raw_data_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">df_dataset</span><span class="p">[</span><span class="s2">&quot;dataset_raw_data&quot;</span><span class="p">]</span>
            <span class="c1"># append columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_dataset_raw_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_dataset_dcm_data_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">df_dataset_dcm_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_dataset_dcm_data_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">df_dataset</span><span class="p">[</span><span class="s2">&quot;dataset_dcm_data&quot;</span><span class="p">]</span>
            <span class="c1"># append columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_dataset_dcm_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># append columns</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_p</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_p</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_dataset</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># set index (prefer raw data if available)</span>
        <span class="k">if</span><span class="p">(</span><span class="s2">&quot;dataset_raw_data_file_hash&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;dataset_raw_data_file_hash&quot;</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="s2">&quot;dataset_dcm_data_file_hash&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;dataset_dcm_data_file_hash&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no data file hash found in datasets! :(&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="c1"># prefix</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="n">prefix_str</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<div class="viewcode-block" id="pipeline.save_datasets"><a class="viewcode-back" href="../../mrs.html#mrs.reco.pipeline.save_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">save_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save corresponding this pipeline, all its parameters and its datasets to a dataframe stored on the disk.&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;saving to disk...&quot;</span><span class="p">)</span>

        <span class="c1"># check it we have specified a file path</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;storage_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no pkl file path specified to save to disk!&quot;</span><span class="p">)</span>
            <span class="k">return</span><span class="p">()</span>

        <span class="c1"># first, convert this pipeline and all to a df</span>
        <span class="n">this_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dataframe</span><span class="p">()</span>
        <span class="c1"># add timestamp</span>
        <span class="n">this_df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># load current df from file, if exist</span>
        <span class="n">pkl_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;storage_file&quot;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pkl_filepath</span><span class="p">)):</span>
            <span class="c1"># load</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">pkl_filepath</span><span class="p">)</span>
            <span class="c1"># remove rows for which we have new data</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">this_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="c1"># append new rows</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">this_df</span><span class="p">])</span>

            <span class="c1"># save back</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">pkl_filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no file</span>
            <span class="n">this_df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">pkl_filepath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="remove_grids_from_all_figs"><a class="viewcode-back" href="../../mrs.html#mrs.reco.remove_grids_from_all_figs">[docs]</a><span class="k">def</span> <span class="nf">remove_grids_from_all_figs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Remove the grid in all axes for all open figures.&quot;&quot;&quot;</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="p">[</span><span class="n">manager</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">figure</span> <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">_pylab_helpers</span><span class="o">.</span><span class="n">Gcf</span><span class="o">.</span><span class="n">get_all_fig_managers</span><span class="p">()]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="reco_spatial_select_profile"><a class="viewcode-back" href="../../mrs.html#mrs.reco.reco_spatial_select_profile">[docs]</a><span class="k">def</span> <span class="nf">reco_spatial_select_profile</span><span class="p">(</span><span class="n">dcm_folders_list</span><span class="p">,</span> <span class="n">legends_list</span><span class="p">,</span> <span class="n">analyze_selectivity_range_list</span><span class="o">=</span><span class="p">[[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">3550</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">10600</span><span class="p">,</span> <span class="o">-</span><span class="mi">7800</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">3650</span><span class="p">,</span> <span class="mi">1850</span><span class="p">]]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reconstruct the VOI selection profile from data acquired using the &#39;VOI trace&#39; mode (available in CMRR&#39;s MRS sequences).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dcm_folders_list: list</span>
<span class="sd">        List of folder paths containing DICOM files</span>
<span class="sd">    legends_list : list</span>
<span class="sd">        List of legends</span>
<span class="sd">    analyze_selectivity_range_list : list</span>
<span class="sd">        List of ranges (point index) in the X, Y and Z direction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    analyze_selectivity_list : list</span>
<span class="sd">        Analysis results (amount of signal IN and OUT of the ranges)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># init</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xdata_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ydata_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zdata_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xdata_axis_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ydata_axis_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zdata_axis_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># read the 3 VOI traces per dataset</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading data files...&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dcm_folders_list</span><span class="p">:</span>
        <span class="c1"># read data</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;looking in folder: &quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading the 3 dicom files...&quot;</span><span class="p">)</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_siemens_dicom</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="s2">&quot;/original-primary_e09_0001.dcm&quot;</span><span class="p">)</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_siemens_dicom</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="s2">&quot;/original-primary_e09_0002.dcm&quot;</span><span class="p">)</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="n">suspect</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_siemens_dicom</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="s2">&quot;/original-primary_e09_0003.dcm&quot;</span><span class="p">)</span>
        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">])</span>
        <span class="c1"># normalize</span>
        <span class="n">sx_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sx</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sx</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">sy_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sy</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sy</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">sz_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">spectrum</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># store</span>
        <span class="n">xdata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sx_spectrum</span><span class="p">)</span>
        <span class="n">ydata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sy_spectrum</span><span class="p">)</span>
        <span class="n">zdata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sz_spectrum</span><span class="p">)</span>
        <span class="n">xdata_axis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sx</span><span class="o">.</span><span class="n">frequency_axis</span><span class="p">())</span>
        <span class="n">ydata_axis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sy</span><span class="o">.</span><span class="n">frequency_axis</span><span class="p">())</span>
        <span class="n">zdata_axis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sz</span><span class="o">.</span><span class="n">frequency_axis</span><span class="p">())</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

    <span class="c1"># analysis</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;evaluating selectivity using a &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">analyze_selectivity_range_list</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;ppm ranges...&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
    <span class="n">analyze_selectivity_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">dcm_folders_list</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sx_ax</span><span class="p">,</span> <span class="n">sy_ax</span><span class="p">,</span> <span class="n">sz_ax</span><span class="p">,</span> <span class="n">leg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xdata_list</span><span class="p">,</span> <span class="n">ydata_list</span><span class="p">,</span> <span class="n">zdata_list</span><span class="p">,</span> <span class="n">xdata_axis_list</span><span class="p">,</span> <span class="n">ydata_axis_list</span><span class="p">,</span> <span class="n">zdata_axis_list</span><span class="p">,</span> <span class="n">legends_list</span><span class="p">)):</span>

        <span class="c1"># find ppm indexes corresponding to ppm values</span>
        <span class="n">sx_ithreshold_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sx_ax</span> <span class="o">-</span> <span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sx_ithreshold_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sx_ax</span> <span class="o">-</span> <span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">sy_ithreshold_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sy_ax</span> <span class="o">-</span> <span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sy_ithreshold_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sy_ax</span> <span class="o">-</span> <span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">sz_ithreshold_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sz_ax</span> <span class="o">-</span> <span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sz_ithreshold_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sz_ax</span> <span class="o">-</span> <span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># evaluate signal inside voxel</span>
        <span class="n">sx_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sx</span><span class="p">[</span><span class="n">sx_ithreshold_l</span><span class="p">:</span><span class="n">sx_ithreshold_r</span><span class="p">],</span> <span class="n">sx_ax</span><span class="p">[</span><span class="n">sx_ithreshold_l</span><span class="p">:</span><span class="n">sx_ithreshold_r</span><span class="p">])</span>
        <span class="n">sy_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sy</span><span class="p">[</span><span class="n">sy_ithreshold_l</span><span class="p">:</span><span class="n">sy_ithreshold_r</span><span class="p">],</span> <span class="n">sy_ax</span><span class="p">[</span><span class="n">sy_ithreshold_l</span><span class="p">:</span><span class="n">sy_ithreshold_r</span><span class="p">])</span>
        <span class="n">sz_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="n">sz_ithreshold_l</span><span class="p">:</span><span class="n">sz_ithreshold_r</span><span class="p">],</span> <span class="n">sz_ax</span><span class="p">[</span><span class="n">sz_ithreshold_l</span><span class="p">:</span><span class="n">sz_ithreshold_r</span><span class="p">])</span>

        <span class="c1"># put to zero the inside</span>
        <span class="n">sx_masked</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sx_masked</span><span class="p">[</span><span class="n">sx_ithreshold_l</span><span class="p">:</span><span class="n">sx_ithreshold_r</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sy_masked</span> <span class="o">=</span> <span class="n">sy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sy_masked</span><span class="p">[</span><span class="n">sy_ithreshold_l</span><span class="p">:</span><span class="n">sy_ithreshold_r</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sz_masked</span> <span class="o">=</span> <span class="n">sz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sz_masked</span><span class="p">[</span><span class="n">sz_ithreshold_l</span><span class="p">:</span><span class="n">sz_ithreshold_r</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># evaluate signal outside voxel</span>
        <span class="n">sx_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sx_masked</span><span class="p">,</span> <span class="n">sx_ax</span><span class="p">)</span>
        <span class="n">sy_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sy_masked</span><span class="p">,</span> <span class="n">sy_ax</span><span class="p">)</span>
        <span class="n">sz_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">sz_masked</span><span class="p">,</span> <span class="n">sz_ax</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;selectivity results for [&quot;</span> <span class="o">+</span> <span class="n">leg</span> <span class="o">+</span> <span class="s2">&quot;]...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; [X] IN=</span><span class="si">%.0f</span><span class="s2">Hz-1 OUT=</span><span class="si">%.0f</span><span class="s2"> Hz-1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sx_in</span><span class="p">,</span> <span class="n">sx_out</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; [Y] IN=</span><span class="si">%.0f</span><span class="s2">Hz-1 OUT=</span><span class="si">%.0f</span><span class="s2"> Hz-1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sy_in</span><span class="p">,</span> <span class="n">sy_out</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; [Z] IN=</span><span class="si">%.0f</span><span class="s2">Hz-1 OUT=</span><span class="si">%.0f</span><span class="s2"> Hz-1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sz_in</span><span class="p">,</span> <span class="n">sz_out</span><span class="p">))</span>

        <span class="c1"># store</span>
        <span class="n">analyze_selectivity_list</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sx_in</span><span class="p">,</span> <span class="n">sy_in</span><span class="p">,</span> <span class="n">sz_in</span><span class="p">]</span>
        <span class="n">analyze_selectivity_list</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sx_out</span><span class="p">,</span> <span class="n">sy_out</span><span class="p">,</span> <span class="n">sz_out</span><span class="p">]</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>

    <span class="c1"># display</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;displaying the 3 spatial profiles...&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info_line________________________</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s2">&quot;run (mrs.reco.voi_pipeline)&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;spatial selection profiles&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sx_ax</span><span class="p">,</span> <span class="n">sy_ax</span><span class="p">,</span> <span class="n">sz_ax</span><span class="p">,</span> <span class="n">leg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xdata_list</span><span class="p">,</span> <span class="n">ydata_list</span><span class="p">,</span> <span class="n">zdata_list</span><span class="p">,</span> <span class="n">xdata_axis_list</span><span class="p">,</span> <span class="n">ydata_axis_list</span><span class="p">,</span> <span class="n">zdata_axis_list</span><span class="p">,</span> <span class="n">legends_list</span><span class="p">):</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sx_ax</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency dispersion (Hz)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sx_ax</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency dispersion (Hz)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;X spatial profile&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sy_ax</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency dispersion (Hz)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sy_ax</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency dispersion (Hz)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y spatial profile&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sz_ax</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency dispersion (Hz)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sz_ax</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency dispersion (Hz)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z spatial profile&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span>

    <span class="c1"># display ppm range lines</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">analyze_selectivity_range_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span><span class="p">(</span><span class="n">analyze_selectivity_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_dw_reco_pipeline"><a class="viewcode-back" href="../../mrs.html#mrs.reco.get_dw_reco_pipeline">[docs]</a><span class="k">def</span> <span class="nf">get_dw_reco_pipeline</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a reconstruction pipeline object to process this DW-MRS data. In short, it reshapes and split the current dataset into several datasets corresponding to different directions and bvalues, in order to process each of them in a pipeline. This method is quite weird and experimental for now. A lot of stuff missing. And that is why it is here, out of any class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : MRSData2 object</span>
<span class="sd">        DW data to process</span>
<span class="sd">    template_name : string</span>
<span class="sd">        Reco pipeline template file to use</span>
<span class="sd">    legend : string</span>
<span class="sd">        Some legend to use for this dataset</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p : reco.pipeline object</span>
<span class="sd">        Ready to run reconstruction pipeline for DW-MRS data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;generating a reconstruction pipeline to process DW-MRS data...&quot;</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="s2">&quot;directions&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="s2">&quot;bvalues&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="s2">&quot;n_b0&quot;</span><span class="p">)):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;sorry but this dataset was not acquired with a DW-MRS sequence.&quot;</span><span class="p">)</span>

    <span class="c1"># get the dw parameters from the sequence</span>
    <span class="n">n_averages</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">na</span>
    <span class="n">n_directions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directions</span><span class="p">)</span>
    <span class="n">n_bvalues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">bvalues</span><span class="p">)</span>
    <span class="n">n_b0</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">n_b0</span>

    <span class="c1"># number of dw scans including b0</span>
    <span class="n">n_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_directions</span> <span class="o">*</span> <span class="n">n_bvalues</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_b0</span>
    <span class="c1"># number of channels</span>
    <span class="n">n_chan</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># number of time points</span>
    <span class="n">n_pts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># 1st reshape</span>
    <span class="n">s4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">n_averages</span><span class="p">,</span> <span class="n">n_diff</span><span class="p">,</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">n_pts</span><span class="p">])</span>

    <span class="c1"># extract b0 data temporarly</span>
    <span class="n">s4d_b0</span> <span class="o">=</span> <span class="n">s4d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="c1"># and remove it from dataset (considering it was acquired first!)</span>
    <span class="n">s4d</span> <span class="o">=</span> <span class="n">s4d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="c1"># 2nd reshape: separate bval from dir</span>
    <span class="c1"># TODO: this 2nd reshape is a shot in the dark!!!</span>
    <span class="n">s5d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s4d</span><span class="p">,</span> <span class="p">[</span><span class="n">n_averages</span><span class="p">,</span> <span class="n">n_directions</span><span class="p">,</span> <span class="n">n_bvalues</span><span class="p">,</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">n_pts</span><span class="p">])</span>
    <span class="n">s5d_b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s4d_b0</span><span class="p">,</span> <span class="p">[</span><span class="n">n_averages</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">n_pts</span><span class="p">])</span>

    <span class="c1"># now prepape reco pipeline</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>

    <span class="c1"># edit the dataset list</span>
    <span class="n">i_dataset</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># store b0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">s5d_b0</span><span class="p">))</span>
    <span class="c1"># edit hash</span>
    <span class="n">s</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">+</span> <span class="s2">&quot;_b0&quot;</span>
    <span class="c1"># edit sequence parameters</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">bvalues</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># edit label</span>
    <span class="n">s</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="n">legend</span> <span class="o">+</span> <span class="s2">&quot; b0&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i_dataset</span><span class="p">][</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend</span> <span class="o">+</span> <span class="s2">&quot; b0&quot;</span>
    <span class="c1"># store</span>
    <span class="n">p</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i_dataset</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

    <span class="n">i_dataset</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">this_dir_index</span><span class="p">,</span> <span class="n">this_dir</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">this_bval_index</span><span class="p">,</span> <span class="n">this_bval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">bvalues</span><span class="p">):</span>
            <span class="c1"># build MRSData2 object</span>
            <span class="n">s_extracted</span> <span class="o">=</span> <span class="n">s5d</span><span class="p">[:,</span> <span class="n">this_dir_index</span><span class="p">,</span> <span class="n">this_bval_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">inherit</span><span class="p">(</span><span class="n">s_extracted</span><span class="p">)</span>
            <span class="c1"># edit hash</span>
            <span class="n">s</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">_data_file_hash</span> <span class="o">+</span> <span class="s2">&quot;_d</span><span class="si">%d</span><span class="s2">b</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_dir_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">this_bval_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># edit sequence parameters</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="n">this_dir</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">bvalues</span> <span class="o">=</span> <span class="n">this_bval</span>
            <span class="c1"># edit label</span>
            <span class="n">p</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i_dataset</span><span class="p">][</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend</span> <span class="o">+</span> <span class="s2">&quot; d</span><span class="si">%d</span><span class="s2"> b</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_dir_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">this_bval_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">set_display_label</span><span class="p">(</span><span class="n">legend</span> <span class="o">+</span> <span class="s2">&quot; d</span><span class="si">%d</span><span class="s2"> b</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">this_dir_index</span><span class="p">,</span> <span class="n">this_bval_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># store</span>
            <span class="n">p</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i_dataset</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

            <span class="c1"># next</span>
            <span class="n">i_dataset</span> <span class="o">=</span> <span class="n">i_dataset</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Tangi Roussel

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>